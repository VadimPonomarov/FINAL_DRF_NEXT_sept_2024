# üê≥ AutoRia - Infrastructure Setup

## üìã –û–≥–ª—è–¥

Docker, Redis, Nginx, PostgreSQL —Ç–∞ —ñ–Ω—à—ñ infrastructure –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∏.

---

## üê≥ Docker Compose

### –ë–∞–∑–æ–≤–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

```yaml
# docker-compose.yml
version: '3.8'

services:
  # PostgreSQL Database
  db:
    image: postgres:15
    environment:
      POSTGRES_DB: autoria
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis Cache
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Django Backend
  app:
    build:
      context: ./backend
      dockerfile: Dockerfile
    command: >
      sh -c "python manage.py migrate &&
             python manage.py create_test_users &&
             python manage.py runserver 0.0.0.0:8000"
    volumes:
      - ./backend:/app
      - media_files:/app/media
      - static_files:/app/staticfiles
    ports:
      - "8000:8000"
    environment:
      - DEBUG=True
      - DATABASE_URL=postgresql://postgres:postgres@db:5432/autoria
      - REDIS_URL=redis://redis:6379/1
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy

  # Celery Worker
  celery:
    build:
      context: ./backend
      dockerfile: Dockerfile
    command: celery -A config worker -l info
    volumes:
      - ./backend:/app
    environment:
      - DATABASE_URL=postgresql://postgres:postgres@db:5432/autoria
      - REDIS_URL=redis://redis:6379/1
    depends_on:
      - db
      - redis

  # Celery Beat (scheduler)
  celery-beat:
    build:
      context: ./backend
      dockerfile: Dockerfile
    command: celery -A config beat -l info
    volumes:
      - ./backend:/app
    depends_on:
      - db
      - redis

volumes:
  postgres_data:
  redis_data:
  media_files:
  static_files:
```

### –ö–æ–º–∞–Ω–¥–∏ Docker

```bash
# –ó–∞–ø—É—Å–∫ –≤—Å—ñ—Ö —Å–µ—Ä–≤—ñ—Å—ñ–≤
docker-compose up -d

# –ü–µ—Ä–µ–≥–ª—è–¥ –ª–æ–≥—ñ–≤
docker-compose logs -f app

# –ó—É–ø–∏–Ω–∏—Ç–∏
docker-compose down

# –ü–æ–≤–Ω–µ –æ—á–∏—â–µ–Ω–Ω—è (–≤–∫–ª—é—á–Ω–æ –∑ volumes)
docker-compose down -v
```

---

## üì¶ Redis –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è

### Backend –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è

```python
# backend/config/extra_config/cache_config.py

CACHES = {
    'default': {
        'BACKEND': 'django_redis.cache.RedisCache',
        'LOCATION': os.getenv('REDIS_URL', 'redis://redis:6379/1'),
        'OPTIONS': {
            'CLIENT_CLASS': 'django_redis.client.DefaultClient',
            'SOCKET_CONNECT_TIMEOUT': 5,
            'SOCKET_TIMEOUT': 5,
            'RETRY_ON_TIMEOUT': True,
            'MAX_CONNECTIONS': 50,
        }
    }
}
```

### Frontend –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è

```typescript
// frontend/src/lib/redis.ts
import Redis from 'ioredis';

const redis = new Redis({
  host: process.env.REDIS_HOST || 'localhost',
  port: parseInt(process.env.REDIS_PORT || '6379'),
  password: process.env.REDIS_PASSWORD,
  db: 0,
  retryStrategy: (times) => {
    const delay = Math.min(times * 50, 2000);
    return delay;
  }
});
```

### –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è

```python
# Backend - Django cache
from django.core.cache import cache

cache.set('currency_usd', 41.5, 86400)  # 24h
rate = cache.get('currency_usd')
```

```typescript
// Frontend - Next.js API route
import redis from '@/lib/redis';

await redis.set('backend_auth', JSON.stringify(authData), 'EX', 86400);
const auth = await redis.get('backend_auth');
```

---

## üåê Nginx Reverse Proxy

### –ë–∞–∑–æ–≤–∞ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è

```nginx
# nginx/nginx.conf

upstream backend {
    server app:8000;
}

upstream frontend {
    server frontend:3000;
}

server {
    listen 80;
    server_name localhost;

    client_max_body_size 10M;

    # Frontend
    location / {
        proxy_pass http://frontend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }

    # Backend API
    location /api/ {
        proxy_pass http://backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Django Static Files
    location /static/ {
        alias /app/staticfiles/;
    }

    # Media Files
    location /media/ {
        alias /app/media/;
    }

    # WebSocket (–¥–ª—è chat)
    location /ws/ {
        proxy_pass http://backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
    }
}
```

### –î–æ–¥–∞—Ç–∏ –¥–æ docker-compose.yml

```yaml
services:
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - static_files:/app/staticfiles:ro
      - media_files:/app/media:ro
    depends_on:
      - app
      - frontend
```

---

## üíæ PostgreSQL –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è

### Backup —Ç–∞ Restore

```bash
# Backup
docker-compose exec db pg_dump -U postgres autoria > backup.sql

# Restore
cat backup.sql | docker-compose exec -T db psql -U postgres autoria
```

### –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è performance

```python
# backend/config/extra_config/db_config.py

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql',
        'NAME': os.getenv('POSTGRES_DB', 'autoria'),
        'USER': os.getenv('POSTGRES_USER', 'postgres'),
        'PASSWORD': os.getenv('POSTGRES_PASSWORD', 'postgres'),
        'HOST': os.getenv('POSTGRES_HOST', 'db'),
        'PORT': os.getenv('POSTGRES_PORT', '5432'),
        'CONN_MAX_AGE': 600,  # Connection pooling
        'OPTIONS': {
            'connect_timeout': 10,
        },
        'ATOMIC_REQUESTS': True,  # –¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ request
    }
}
```

---

## üîí Environment Variables

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞

```
env-config/
‚îú‚îÄ‚îÄ .env.base          # –ë–∞–∑–æ–≤—ñ (–Ω–µ —Å–µ–∫—Ä–µ—Ç–Ω—ñ)
‚îú‚îÄ‚îÄ .env.secrets       # API –∫–ª—é—á—ñ (–ó–ê–®–ò–§–†–û–í–ê–ù–Ü)
‚îú‚îÄ‚îÄ .env.local         # –õ–æ–∫–∞–ª—å–Ω—ñ (gitignored)
‚îî‚îÄ‚îÄ .env.docker        # Docker specific
```

### .env.base (–ø—Ä–∏–∫–ª–∞–¥)

```bash
# Django
DEBUG=True
ALLOWED_HOSTS=localhost,127.0.0.1,0.0.0.0

# Database
POSTGRES_DB=autoria
POSTGRES_USER=postgres
POSTGRES_HOST=db
POSTGRES_PORT=5432

# Redis
REDIS_HOST=redis
REDIS_PORT=6379

# URLs
BACKEND_URL=http://localhost:8000
FRONTEND_URL=http://localhost:3000
```

### .env.secrets (–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω—ñ)

```bash
# –ó–ê–®–ò–§–†–û–í–ê–ù–û —á–µ—Ä–µ–∑ Fernet
POSTGRES_PASSWORD=gAAAAABh...
SECRET_KEY=gAAAAABh...
GOOGLE_MAPS_API_KEY=gAAAAABh...
EMAIL_HOST_PASSWORD=gAAAAABh...
```

---

## üìä –ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ —Ç–∞ –õ–æ–≥—É–≤–∞–Ω–Ω—è

### Docker logs

```bash
# –í—Å—ñ —Å–µ—Ä–≤—ñ—Å–∏
docker-compose logs -f

# –ö–æ–Ω–∫—Ä–µ—Ç–Ω–∏–π —Å–µ—Ä–≤—ñ—Å
docker-compose logs -f app
docker-compose logs -f redis

# –û—Å—Ç–∞–Ω–Ω—ñ 100 —Ä—è–¥–∫—ñ–≤
docker-compose logs --tail=100 app
```

### Application logs

```python
# backend/config/extra_config/logger_config.py

LOGGING = {
    'version': 1,
    'handlers': {
        'file': {
            'class': 'logging.FileHandler',
            'filename': 'logs/django.log',
            'formatter': 'verbose',
        },
    },
    'loggers': {
        'django': {
            'handlers': ['file'],
            'level': 'INFO',
        },
    },
}
```

### Flower (Celery monitoring)

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç–∏ Flower
docker-compose exec celery celery -A config flower

# –í—ñ–¥–∫—Ä–∏—Ç–∏ http://localhost:5555
```

---

## üöÄ Production Deployment

### Dockerfile –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó

```dockerfile
# backend/Dockerfile

FROM python:3.11-slim

# Multi-stage build
WORKDIR /app

# Install dependencies
COPY pyproject.toml poetry.lock ./
RUN pip install poetry && \
    poetry config virtualenvs.create false && \
    poetry install --no-dev --no-interaction --no-ansi

# Copy application
COPY . .

# Collect static files
RUN python manage.py collectstatic --noinput

# Run as non-root user
RUN useradd -m appuser
USER appuser

CMD ["gunicorn", "config.wsgi:application", "--bind", "0.0.0.0:8000"]
```

### Gunicorn –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è

```python
# backend/gunicorn.conf.py

bind = "0.0.0.0:8000"
workers = 4  # CPU cores * 2 + 1
worker_class = "sync"
worker_connections = 1000
timeout = 30
keepalive = 2

# Logging
accesslog = "logs/gunicorn.access.log"
errorlog = "logs/gunicorn.error.log"
loglevel = "info"
```

---

## üìã –ß–µ–∫-–ª–∏—Å—Ç Production

### Security:
- [ ] `DEBUG=False`
- [ ] `SECRET_KEY` –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–∏–π —Ç–∞ –±–µ–∑–ø–µ—á–Ω–∏–π
- [ ] `ALLOWED_HOSTS` –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω—ñ
- [ ] HTTPS —É–≤—ñ–º–∫–Ω–µ–Ω–æ
- [ ] Firewall rules –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω—ñ
- [ ] Database –ø–∞—Ä–æ–ª—å –∑–º—ñ–Ω–µ–Ω–∏–π
- [ ] Redis password –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–π

### Performance:
- [ ] Gunicorn –∑ workers
- [ ] Nginx reverse proxy
- [ ] PostgreSQL connection pooling
- [ ] Redis caching active
- [ ] Static files served through Nginx
- [ ] Media files optimized

### Monitoring:
- [ ] Logs rotation –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ
- [ ] Flower –¥–ª—è Celery
- [ ] Health checks –ø—Ä–∞—Ü—é—é—Ç—å
- [ ] Backups –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω—ñ

---

## üîó –ü–æ–≤'—è–∑–∞–Ω—ñ –¥–æ–∫—É–º–µ–Ω—Ç–∏

- [Setup Guide](./SETUP_GUIDE.md) - –ü–æ—á–∞—Ç–∫–æ–≤–µ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
- [Troubleshooting](./TROUBLESHOOTING.md) - –í–∏—Ä—ñ—à–µ–Ω–Ω—è –ø—Ä–æ–±–ª–µ–º
- [Backend API](./BACKEND_API_GUIDE.md) - API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è

---

**–í–µ—Ä—Å—ñ—è**: 2.0  
**–û—Å—Ç–∞–Ω–Ω—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è**: 2025-01-25

