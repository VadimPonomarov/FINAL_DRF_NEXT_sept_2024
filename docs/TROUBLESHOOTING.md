# üîß AutoRia - –í–∏—Ä—ñ—à–µ–Ω–Ω—è –ø—Ä–æ–±–ª–µ–º

## üìã –û–≥–ª—è–¥

–ü–æ–≤–Ω–∏–π –ø–æ—Å—ñ–±–Ω–∏–∫ –∑ –≤–∏—Ä—ñ—à–µ–Ω–Ω—è —Ç–∏–ø–æ–≤–∏—Ö –ø—Ä–æ–±–ª–µ–º –≤ AutoRia –ø–ª–∞—Ç—Ñ–æ—Ä–º—ñ.

---

## üîê –ü—Ä–æ–±–ª–µ–º–∏ –∑ –ê–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—î—é

### 401 Unauthorized –Ω–∞ –≤—Å—ñ—Ö –∑–∞–ø–∏—Ç–∞—Ö

**–°–∏–º–ø—Ç–æ–º–∏**:
```
GET /api/users/profile/ ‚Üí 401 Unauthorized
```

**–ü—Ä–∏—á–∏–Ω–∏ —Ç–∞ —Ä—ñ—à–µ–Ω–Ω—è**:

1. **–¢–æ–∫–µ–Ω –Ω–µ –∑–±–µ—Ä–µ–∂–µ–Ω–æ –≤ Redis**
   ```typescript
   // –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏
   const token = await fetch('/api/redis/get/backend_auth');
   console.log(token);
   ```
   **–§—ñ–∫—Å**: –ü—ñ—Å–ª—è –ª–æ–≥—ñ–Ω–∞ –ø–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ `fetchAuth` –∑–±–µ—Ä—ñ–≥–∞—î —Ç–æ–∫–µ–Ω:
   ```typescript
   await fetch('/api/redis/set', {
     method: 'POST',
     body: JSON.stringify({
       key: 'backend_auth',
       value: JSON.stringify({ access: accessToken, refresh: refreshToken })
     })
   });
   ```

2. **–¢–æ–∫–µ–Ω –∑–∞—Å—Ç–∞—Ä—ñ–≤**
   ```typescript
   // frontend/src/utils/fetchWithAuth.ts
   if (response.status === 401) {
     const refreshed = await refreshAccessToken();
     if (refreshed) {
       // Retry original request
       return fetchWithAuth(url, options);
     }
   }
   ```

3. **Provider –Ω–µ —Å–ø—ñ–≤–ø–∞–¥–∞—î**
   ```typescript
   const provider = await fetch('/api/redis/get/auth_provider');
   // –ú–∞—î –±—É—Ç–∏ 'backend' –∞–±–æ 'dummy'
   ```

###  NextAuth Session –ø–æ–º–∏–ª–∫–∏

**–°–∏–º–ø—Ç–æ–º–∏**:
```
[next-auth][error][SESSION_ERROR]
```

**–§—ñ–∫—Å**:
```typescript
// frontend/src/app/api/auth/[...nextauth]/route.ts
session: {
  strategy: 'jwt',  // –ù–µ 'database'
  maxAge: 24 * 60 * 60,  // 24 –≥–æ–¥–∏–Ω–∏
},
callbacks: {
  async jwt({ token, user }) {
    if (user) token.user = user;
    return token;
  }
}
```

---

## üåê CORS –ü–æ–º–∏–ª–∫–∏

### CORS policy: No 'Access-Control-Allow-Origin'

**–°–∏–º–ø—Ç–æ–º–∏**:
```
Access to fetch at 'http://localhost:8000/api/...' from origin 'http://localhost:3000'
has been blocked by CORS policy
```

**–§—ñ–∫—Å (Backend)**:
```python
# backend/config/extra_config/cors_config.py

CORS_ALLOWED_ORIGINS = [
    "http://localhost:3000",
    "http://127.0.0.1:3000",
    "http://frontend:3000",  # Docker
]

CORS_ALLOW_CREDENTIALS = True

CORS_ALLOW_HEADERS = [
    'accept',
    'authorization',
    'content-type',
    'x-csrftoken',
    'x-requested-with',
]
```

### Preflight OPTIONS –∑–∞–ø–∏—Ç–∏ fails

**–°–∏–º–ø—Ç–æ–º–∏**:
```
OPTIONS /api/... ‚Üí 403 Forbidden
```

**–§—ñ–∫—Å**:
```python
# –î–æ–¥–∞—Ç–∏ –≤ CORS_ALLOW_METHODS
CORS_ALLOW_METHODS = [
    'DELETE',
    'GET',
    'OPTIONS',  # –û–±–æ–≤'—è–∑–∫–æ–≤–æ!
    'PATCH',
    'POST',
    'PUT',
]
```

---

## üîÑ –ü—Ä–æ–±–ª–µ–º–∏ –∑ –†–µ–¥—ñ—Ä–µ–∫—Ç–∞–º–∏

### –ù–µ—Å–∫—ñ–Ω—á–µ–Ω–Ω—ñ —Ä–µ–¥—ñ—Ä–µ–∫—Ç–∏ /login ‚Üí /

**–°–∏–º–ø—Ç–æ–º–∏**:
```
/login ‚Üí / ‚Üí /login ‚Üí / ‚Üí ...
```

**–ü—Ä–∏—á–∏–Ω–∞**: `useRedisAuth` –≤–≤–∞–∂–∞—î –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–∏–º, –∞–ª–µ –Ω–∞—Å–ø—Ä–∞–≤–¥—ñ –Ω—ñ.

**–§—ñ–∫—Å**:
```typescript
// frontend/src/contexts/RedisAuthContext.tsx
useEffect(() => {
  const checkAuth = async () => {
    const provider = await fetch('/api/redis/get/auth_provider').then(r => r.json());
    const authKey = provider === 'dummy' ? 'dummy_auth' : 'backend_auth';
    const authData = await fetch(`/api/redis/get/${authKey}`).then(r => r.json());
    
    if (authData && authData.access) {
      // –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Ç–æ–∫–µ–Ω –≤–∞–ª—ñ–¥–Ω–∏–π
      const valid = await fetch('/api/users/profile/', {
        headers: { Authorization: `Bearer ${authData.access}` }
      });
      
      if (valid.ok) {
        setRedisUser(authData.user);
      } else {
        // –¢–æ–∫–µ–Ω –Ω–µ–¥—ñ–π—Å–Ω–∏–π - –æ—á–∏—Å—Ç–∏—Ç–∏
        await fetch('/api/redis/delete/backend_auth', { method: 'POST' });
        setRedisUser(null);
      }
    }
  };
  
  checkAuth();
}, []);
```

---

## üñºÔ∏è –ü—Ä–æ–±–ª–µ–º–∏ –∑ –ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è–º–∏

### AI –≥–µ–Ω–µ—Ä–∞—Ü—ñ—è –∑–æ–±—Ä–∞–∂–µ–Ω—å fails

**–°–∏–º–ø—Ç–æ–º–∏**:
```
POST /api/ads/cars/{id}/images/generate/ ‚Üí 500 Internal Server Error
Error: g4f timeout or connection error
```

**–†—ñ—à–µ–Ω–Ω—è**:

1. **–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ g4f**:
   ```python
   # backend/test_g4f.py
   from g4f.client import Client
   
   client = Client()
   response = client.images.generate(
       model="flux",
       prompt="car"
   )
   print(response.data[0].url)
   ```

2. **–ó–±—ñ–ª—å—à–∏—Ç–∏ timeout**:
   ```python
   # backend/core/services/ai_image_service.py
   response = client.images.generate(
       model="flux",
       prompt=prompt,
       timeout=60  # 60 —Å–µ–∫—É–Ω–¥
   )
   ```

3. **Fallback –Ω–∞ stock URLs**:
   ```python
   try:
       image_url = generate_image(prompt)
   except Exception as e:
       logger.error(f"AI generation failed: {e}")
       image_url = "https://via.placeholder.com/800x600?text=Car"
   ```

### –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–æ–±—Ä–∞–∂–µ–Ω—å fails

**–°–∏–º–ø—Ç–æ–º–∏**:
```
POST /api/ads/cars/{id}/images/upload/ ‚Üí 413 Request Entity Too Large
```

**–§—ñ–∫—Å**:
```python
# backend/config/extra_config/security_config.py
FILE_UPLOAD_MAX_MEMORY_SIZE = 10 * 1024 * 1024  # 10 MB
DATA_UPLOAD_MAX_MEMORY_SIZE = 10 * 1024 * 1024  # 10 MB
```

```nginx
# nginx.conf (—è–∫—â–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è)
client_max_body_size 10M;
```

---

## üê≥ Docker —Ç–∞ Infrastructure

### Redis connection refused

**–°–∏–º–ø—Ç–æ–º–∏**:
```
[ERROR] Redis client not available
ConnectionRefusedError: [Errno 111] Connection refused
```

**–†—ñ—à–µ–Ω–Ω—è**:

1. **–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ Redis –ø—Ä–∞—Ü—é—î**:
   ```bash
   docker-compose ps redis
   # –ú–∞—î –±—É—Ç–∏ "Up"
   ```

2. **–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è**:
   ```python
   # backend/config/extra_config/cache_config.py
   CACHES = {
       'default': {
           'BACKEND': 'django_redis.cache.RedisCache',
           'LOCATION': os.getenv('REDIS_URL', 'redis://redis:6379/1'),
           'OPTIONS': {
               'CLIENT_CLASS': 'django_redis.client.DefaultClient',
               'SOCKET_CONNECT_TIMEOUT': 5,
               'SOCKET_TIMEOUT': 5,
           }
       }
   }
   ```

3. **Docker network**:
   ```bash
   # –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ network
   docker network ls
   docker network inspect final_drf_next_sept_2024_default
   ```

### PostgreSQL connection errors

**–°–∏–º–ø—Ç–æ–º–∏**:
```
django.db.utils.OperationalError: could not connect to server
```

**–§—ñ–∫—Å**:
```yaml
# docker-compose.yml
services:
  db:
    image: postgres:15
    environment:
      POSTGRES_DB: autoria
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
  
  app:
    depends_on:
      db:
        condition: service_healthy  # –ß–µ–∫–∞—Ç–∏ –ø–æ–∫–∏ DB –≥–æ—Ç–æ–≤–∞
```

---

## üé® Frontend Problems

### Build fails –∑ "Module not found"

**–°–∏–º–ø—Ç–æ–º–∏**:
```
Module not found: Can't resolve '@/components/...'
```

**–§—ñ–∫—Å**:
```json
// frontend/tsconfig.json
{
  "compilerOptions": {
    "baseUrl": ".",
    "paths": {
      "@/*": ["src/*"]
    }
  }
}
```

### Cache –ø—Ä–æ–±–ª–µ–º–∏

**–°–∏–º–ø—Ç–æ–º–∏**: –°—Ç–∞—Ä—ñ –¥–∞–Ω—ñ –≤—ñ–¥–æ–±—Ä–∞–∂–∞—é—Ç—å—Å—è –ø—ñ—Å–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è

**–§—ñ–∫—Å**:
```bash
# –û—á–∏—Å—Ç–∏—Ç–∏ Next.js cache
cd frontend
rm -rf .next
npm run dev
```

**–î–ª—è production**:
```bash
npm run build
# –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ .next/cache
```

---

## üìä –ü–æ–≤'—è–∑–∞–Ω—ñ –¥–æ–∫—É–º–µ–Ω—Ç–∏

- [Setup Guide](./SETUP_GUIDE.md) - –ü–æ—á–∞—Ç–∫–æ–≤–µ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
- [Infrastructure](./INFRASTRUCTURE_SETUP.md) - Docker, Redis, Nginx
- [Backend API](./BACKEND_API_GUIDE.md) - API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è

---

**–í–µ—Ä—Å—ñ—è**: 2.0  
**–û—Å—Ç–∞–Ω–Ω—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è**: 2025-01-25

