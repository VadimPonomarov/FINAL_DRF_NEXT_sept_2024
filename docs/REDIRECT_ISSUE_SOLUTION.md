# Решение проблемы с редиректом

## Описание проблемы

При работе с приложением происходили неожиданные редиректы на страницу авторизации, несмотря на то, что пользователь был авторизован. Это мешало нормальной работе приложения и вызывало неудобства у пользователей.

## Причины проблемы

Основная причина редиректов заключалась в следующем:

1. **Ошибки 404/500 на запросы к API** (`/api/public/reference/...`, `/api/redis`).
   - Эти ошибки вызывали срабатывание глобальных обработчиков ошибок, которые перенаправляли пользователя на страницу авторизации.

2. **Глобальные обработчики ошибок** в `useApiErrorHandler` и `cachedFetch` могли вызывать редиректы при ошибках API.

3. **Использование `/signin` вместо `/api/auth/signin`**:
   - В приложении использовалась кастомная страница `/signin`, которая не существует
   - NextAuth.js предоставляет встроенную страницу авторизации по адресу `/api/auth/signin`
   - Все редиректы должны использовать `/api/auth/signin` для корректной работы с NextAuth

## Решение

Для устранения проблемы было внесено минимальное изменение в файл `cachedFetch.ts`, чтобы ошибки 500 не вызывали редиректы.

### Изменения в коде

#### 1. Обработка ошибок 500 в `cachedFetch`

В файле `frontend/src/utils/cachedFetch.ts` была изменена логика обработки ошибок, чтобы ошибки 500 не вызывали редиректы:

```typescript
const response = await fetch(url, fetchOptions);

if (!response.ok) {
  // Не вызываем редирект для ошибок 404 и 500
  if (response.status === 404 || response.status === 500) {
    console.warn(`[CachedFetch] ${response.status} error detected for ${url}, returning empty data`);
    return { options: [] };
  }
  throw new Error(`HTTP error! status: ${response.status}`);
}
```

### Объяснение

- **Ошибки 404 и 500** теперь не вызывают редиректы, а возвращают пустые данные (`{ options: [] }`).
- Это предотвращает срабатывание глобальных обработчиков ошибок, которые могли перенаправлять пользователя на страницу авторизации.

#### 2. Использование правильных путей для NextAuth

Все редиректы на страницу авторизации должны использовать `/api/auth/signin` (встроенная страница NextAuth), а не `/signin`:

```typescript
// ❌ НЕПРАВИЛЬНО
window.location.href = '/signin?callbackUrl=/autoria/search';

// ✅ ПРАВИЛЬНО
window.location.href = '/api/auth/signin?callbackUrl=/autoria/search';
```

**Важно**:
- `/api/auth/signin` - встроенная страница NextAuth для первичной авторизации
- `/login` - кастомная страница для выбора пользователя и backend авторизации
- При отсутствии NextAuth сессии редирект должен идти на `/api/auth/signin`
- При отсутствии backend токенов редирект должен идти на `/login`

## Итог

Редиректы больше не происходят, и приложение работает стабильно. Пользователи могут продолжать работу без неожиданных перенаправлений на страницу авторизации.

### Правила редиректов:

1. **Нет NextAuth сессии** → `/api/auth/signin?callbackUrl=...`
2. **Нет backend токенов** → `/login?callbackUrl=...`
3. **Критические ошибки** → `/api/auth/signin?callbackUrl=...`