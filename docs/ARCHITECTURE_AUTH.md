# ๐ ะััะธัะตะบัััะฐ ะฐะฒัะพัะธะทะฐัะธะธ (3 ััะพะฒะฝั ะทะฐัะธัั)

## ะะฑัะฐั ััะตะผะฐ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ะฃะะะะะะฌ 1: Middleware (NextAuth Session)                        โ
โ โ ะัะพะฒะตัะบะฐ NextAuth ัะตััะธะธ                                      โ
โ โ ะะตั ัะตััะธะธ โ redirect /api/auth/signin                        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ะฃะะะะะะฌ 2: AutoRiaAuthGuard (Backend Tokens)                    โ
โ โ ะัะพะฒะตัะบะฐ backend ัะพะบะตะฝะพะฒ (access, refresh)                    โ
โ โ ะะตั ัะพะบะตะฝะพะฒ โ redirect /login                                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ะฃะะะะะะฌ 3: API Error Handlers (401/403)                         โ
โ โ ะะฒัะพะผะฐัะธัะตัะบะธะน refresh ัะพะบะตะฝะพะฒ ะฟัะธ 401                        โ
โ โ Refresh failed โ redirect /login                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## 1. Middleware - ะะตัะฒะฐั ะปะธะฝะธั ะทะฐัะธัั (NextAuth Session)

**ะคะฐะนะป**: `frontend/src/middleware.ts`

**ะงัะพ ะฟัะพะฒะตััะตั**:
- ะะฐะปะธัะธะต NextAuth ัะตััะธะธ (ัะตัะตะท `getToken()`)
- ะะฐัะธัะฐะตั ะผะฐัััััั `/autoria/*`, `/profile/*`, `/admin/*`

**ะะพะฒะตะดะตะฝะธะต**:
- โ ะกะตััะธั ะตััั โ ะฟัะพะฟััะบะฐะตั ะฝะฐ ัััะฐะฝะธัั
- โ ะกะตััะธะธ ะฝะตั โ ัะตะดะธัะตะบั ะฝะฐ `/api/auth/signin?callbackUrl=<current_path>`

**ะะฐะถะฝะพ**:
- ะญัะพ ะฟะตัะฒัะน ะธ ัะฐะผัะน ัะฐะฝะฝะธะน ะฑะฐััะตั
- ะัะฟะพะปะฝัะตััั ะฝะฐ edge runtime (ะฑััััะพ)
- ะะ ะฟัะพะฒะตััะตั backend ัะพะบะตะฝั (ััะพ ะดะตะปะฐะตั ัะปะตะดัััะธะน ััะพะฒะตะฝั)

---

## 2. AutoRiaAuthGuard - ะัะพัะฐั ะปะธะฝะธั ะทะฐัะธัั (Backend Tokens)

**ะคะฐะนะป**: `frontend/src/components/AutoRia/Auth/AutoRiaAuthGuard.tsx`

**ะัะธะผะตะฝะตะฝะธะต**: ะัะฟะพะปัะทัะตััั ะฒ ัะตัะฒะตัะฝะพะผ layout AutoRia `frontend/src/app/(main)/(backend)/autoria/layout.tsx`

```typescript
export default function AutoRiaLayoutWrapper({ children }) {
  return (
    <AutoRiaAuthGuard requireBackendAuth={true}>
      <AutoRiaLayout>
        {children}
      </AutoRiaLayout>
    </AutoRiaAuthGuard>
  );
}
```

**ะงัะพ ะฟัะพะฒะตััะตั**:
- ะะฐะปะธัะธะต backend ัะพะบะตะฝะพะฒ ะฒ `localStorage.backend_auth`
- ะะฐะปะธะดะฝะพััั ัะพะบะตะฝะพะฒ (`access` ะธ `refresh` ะฟัะธัััััะฒััั)

**ะะพะฒะตะดะตะฝะธะต**:
- โ ะขะพะบะตะฝั ะฒะฐะปะธะดะฝั โ ัะตะฝะดะตัะธั children
- โ ะขะพะบะตะฝะพะฒ ะฝะตั/ะฝะตะฒะฐะปะธะดะฝั โ ัะตะดะธัะตะบั ะฝะฐ `/login?callbackUrl=<current_path>&error=backend_auth_required`

**ะะฐะถะฝะพ**:
- **ะะปะธะตะฝััะบะธะน ะบะพะผะฟะพะฝะตะฝั** ("use client"), ะฝะพ ะฝะต ะดะตะปะฐะตั ะฒะตัั layout ะบะปะธะตะฝััะบะธะผ
- ะะ ะฟัะพะฒะตััะตั NextAuth ัะตััะธั (ััะพ ัะดะตะปะฐะป middleware)
- ะะพะบะฐะทัะฒะฐะตั loader ะฒะพ ะฒัะตะผั ะฟัะพะฒะตัะบะธ
- ะัะธัะฐะตั ะฝะตะฒะฐะปะธะดะฝัะต ัะพะบะตะฝั ะธะท localStorage
- ะะพะทะฒะพะปัะตั ะธัะฟะพะปัะทะพะฒะฐัั ัะตัะฒะตัะฝัะต ะบะพะผะฟะพะฝะตะฝัั ะฒะฝัััะธ layout

**ะะพัะตะผั ะบะปะธะตะฝััะบะธะน ะบะพะผะฟะพะฝะตะฝั, ะฐ ะฝะต HOC?**:
- HOC ั "use client" ะดะตะปะฐะตั ะฒัะต ะฒะปะพะถะตะฝะฝัะต ะบะพะผะฟะพะฝะตะฝัั ะบะปะธะตะฝััะบะธะผะธ
- ะะปะธะตะฝััะบะธะน guard ะฒะฝัััะธ ัะตัะฒะตัะฝะพะณะพ layout ัะพััะฐะฝัะตั SSR ะดะปั ัััะฐะฝะธั

---

## 3. API Error Handlers - ะขัะตััั ะปะธะฝะธั ะทะฐัะธัั (Runtime)

### fetchWithAuth - ะัะฝะพะฒะฝะพะน API ะบะปะธะตะฝั

**ะคะฐะนะป**: `frontend/src/lib/api/fetchWithAuth.ts`

**ะคัะฝะบัะธะพะฝะฐะป**:
- ะะฒัะพะผะฐัะธัะตัะบะธ ะดะพะฑะฐะฒะปัะตั `Authorization: Bearer <token>` ะบ ะทะฐะฟัะพัะฐะผ
- ะัะธ 401 ะพัะธะฑะบะต โ ะฐะฒัะพะผะฐัะธัะตัะบะธะน refresh ัะพะบะตะฝะพะฒ
- ะัะธ ะฝะตัะดะฐัะต refresh โ ัะตะดะธัะตะบั ะฝะฐ `/login`
- ะัะธ 403 (Forbidden) โ ัะตะดะธัะตะบั ะฝะฐ `/login`

**ะัะธะผะตั**:
```typescript
const response = await fetchWithAuth('/api/autoria/ads', {
  method: 'GET',
});

// ะะฒัะพะผะฐัะธัะตัะบะธ ะพะฑัะฐะฑะฐััะฒะฐะตั 401 ะธ ะดะตะปะฐะตั refresh
// ะัะปะธ refresh ะฟัะพะฒะฐะปะธะปัั โ ัะตะดะธัะตะบั /login
```

---

## ๐ ะะพะปะฝะฐั ะพัะธััะบะฐ ะฐะฒัะพัะธะทะฐัะธะธ (cleanupAuth)

**ะคะฐะนะป**: `frontend/src/lib/auth/cleanupAuth.ts`

### ะคัะฝะบัะธะธ:

#### 1. `cleanupAuth(redirectUrl?)` - ะะพะปะฝะฐั ะพัะธััะบะฐ
- ะัะธัะฐะตั Redis (ะฟัะพะฒะฐะนะดะตัั, ัะพะบะตะฝั)
- ะัะธัะฐะตั NextAuth ัะตััะธั (`signOut`)
- ะัะธัะฐะตั localStorage (ะบัะพะผะต ัะตะผั ะธ ัะทัะบะฐ)
- ะัะธัะฐะตั sessionStorage
- ะะฟัะธะพะฝะฐะปัะฝะพ ัะตะดะธัะตะบัะธั

**ะัะฟะพะปัะทะพะฒะฐะฝะธะต**:
```typescript
import { cleanupAuth } from '@/lib/auth/cleanupAuth';

// ะัะธ logout
await cleanupAuth('/api/auth/signin');
```

#### 2. `cleanupBackendTokens()` - ะัะธััะบะฐ ัะพะปัะบะพ backend ัะพะบะตะฝะพะฒ
- ะฃะดะฐะปัะตั `backend_auth`, `accessToken`, `refreshToken` ะธะท localStorage/sessionStorage
- ะะ ััะพะณะฐะตั NextAuth ัะตััะธั

#### 3. `cleanupProviders()` - ะัะธััะบะฐ ะฟัะพะฒะฐะนะดะตัะพะฒ ะฒ Redis
- ะัะทัะฒะฐะตั `/api/auth/cleanup-providers`
- ะัะธัะฐะตั ัะพะปัะบะพ `provider:<email>` ะฒ Redis

### API Endpoints ะดะปั ะพัะธััะบะธ:

**`POST /api/auth/cleanup`**:
- ะัะธัะฐะตั `provider:<email>`, `tokens:<email>`, `autoria:tokens:<email>` ะฒ Redis
- ะขัะตะฑัะตั NextAuth ัะตััะธั

**`POST /api/auth/cleanup-providers`**:
- ะัะธัะฐะตั ัะพะปัะบะพ `provider:<email>` ะฒ Redis
- ะขัะตะฑัะตั NextAuth ัะตััะธั

---

## ๐ ะะพััะดะพะบ ัะฐะฑะพัั ะฟัะธ ะฒัะพะดะต ะฟะพะปัะทะพะฒะฐัะตะปั

1. **ะะพะปัะทะพะฒะฐัะตะปั ะทะฐัะพะดะธั ะฝะฐ `/autoria/search`**
   - Middleware ะฟัะพะฒะตััะตั NextAuth ัะตััะธั
   - ะัะปะธ ะฝะตั โ `/api/auth/signin?callbackUrl=/autoria/search`

2. **Middleware ะฟัะพะฟัััะธะป (ะตััั NextAuth ัะตััะธั)**
   - ะะตะฝะดะตัะธััั layout `AutoRiaLayoutWrapper`
   - `AutoRiaAuthGuard` ะฟัะพะฒะตััะตั `localStorage.backend_auth`
   - ะัะปะธ ะฝะตั โ `/login?callbackUrl=/autoria/search&error=backend_auth_required`

3. **AuthGuard ะฟัะพะฟัััะธะป (ะตััั backend ัะพะบะตะฝั)**
   - ะกััะฐะฝะธัะฐ ัะตะฝะดะตัะธััั
   - ะะพะผะฟะพะฝะตะฝัั ะดะตะปะฐัั API ะทะฐะฟัะพัั ัะตัะตะท `fetchWithAuth`

4. **API ะทะฐะฟัะพั ะฒะตัะฝัะป 401**
   - `fetchWithAuth` ะฐะฒัะพะผะฐัะธัะตัะบะธ ะฟััะฐะตััั ะพะฑะฝะพะฒะธัั ัะพะบะตะฝั
   - ะัะปะธ refresh ััะฟะตัะตะฝ โ ะฟะพะฒัะพััะตั ะทะฐะฟัะพั
   - ะัะปะธ refresh ะฟัะพะฒะฐะปะธะปัั โ ัะตะดะธัะตะบั `/login`

---

## ๐ ะัะธะผะตัั ะธัะฟะพะปัะทะพะฒะฐะฝะธั

### ะะฐัะธัะฐ ัััะฐะฝะธัั AutoRia (ัะถะต ะฝะฐัััะพะตะฝะพ)

Layout ัะถะต ะทะฐัะธัะตะฝ `AutoRiaAuthGuard`:

```typescript
// frontend/src/app/(main)/(backend)/autoria/layout.tsx
export default function AutoRiaLayoutWrapper({ children }) {
  return (
    <AutoRiaAuthGuard requireBackendAuth={true}>
      <AutoRiaLayout>
        {children}
      </AutoRiaLayout>
    </AutoRiaAuthGuard>
  );
}
```

### API ะทะฐะฟัะพั ั ะฐะฒัะพะผะฐัะธัะตัะบะพะน ะฐะฒัะพัะธะทะฐัะธะตะน

```typescript
import { fetchWithAuth } from '@/lib/api/fetchWithAuth';

// ะะฒัะพะผะฐัะธัะตัะบะธ ะดะพะฑะฐะฒะปัะตั ัะพะบะตะฝั, ะพะฑัะฐะฑะฐััะฒะฐะตั 401
const data = await fetchWithAuth('/api/autoria/ads');
```

### Logout ั ะฟะพะปะฝะพะน ะพัะธััะบะพะน

```typescript
import { cleanupAuth } from '@/lib/auth/cleanupAuth';

const handleLogout = async () => {
  await cleanupAuth('/api/auth/signin');
};
```

---

## โ๏ธ ะะฐะถะฝัะต ะทะฐะผะตัะฐะฝะธั

1. **Middleware ะะ ะฟัะพะฒะตััะตั backend ัะพะบะตะฝั** - ัะพะปัะบะพ NextAuth ัะตััะธั
2. **AuthGuard ะะ ะฟัะพะฒะตััะตั NextAuth ัะตััะธั** - ัะพะปัะบะพ backend ัะพะบะตะฝั
3. **fetchWithAuth ะฐะฒัะพะผะฐัะธัะตัะบะธ ะพะฑัะฐะฑะฐััะฒะฐะตั 401** - ะฝะต ะฝัะถะฝะพ ะฒัััะฝัั ะดะตะปะฐัั refresh
4. **ะัะตะณะดะฐ ะธัะฟะพะปัะทัะนัะต `cleanupAuth` ะฟัะธ logout** - ะดะปั ะฟะพะปะฝะพะน ะพัะธััะบะธ Redis ะธ ัะพะบะตะฝะพะฒ
5. **Layout AutoRia - ัะตัะฒะตัะฝัะน**, AuthGuard - ะบะปะธะตะฝััะบะธะน (ัะพััะฐะฝัะตั SSR)

---

## ๐ ะะตะฑะฐะณ

ะัะต ะบะพะผะฟะพะฝะตะฝัั ะปะพะณะธัััั ัะฒะพะธ ะดะตะนััะฒะธั ะฒ ะบะพะฝัะพะปั:

```
[Middleware] Checking auth for path: /autoria/search
[AutoRiaAuthGuard] Checking backend tokens (session already validated by middleware)
[fetchWithAuth] Request to /api/autoria/ads
[fetchWithAuth] 401 error, attempting token refresh...
[fetchWithAuth] โ Token refresh successful
[CleanupAuth] Starting full authentication cleanup...
```

ะะพะธัะบ ะฟะพ ะปะพะณะฐะผ:
- `[Middleware]` - ะฟัะพะฒะตัะบะฐ NextAuth ัะตััะธะธ
- `[AutoRiaAuthGuard]` - ะฟัะพะฒะตัะบะฐ backend ัะพะบะตะฝะพะฒ
- `[fetchWithAuth]` - API ะทะฐะฟัะพัั ะธ refresh
- `[CleanupAuth]` - ะพัะธััะบะฐ ะฐะฒัะพัะธะทะฐัะธะธ

