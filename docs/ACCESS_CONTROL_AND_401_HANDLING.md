# üõ°Ô∏è –°–∏—Å—Ç–µ–º–∞ –ö–æ–Ω—Ç—Ä–æ–ª—è –î–æ—Å—Ç—É–ø–∞ –∏ –û–±—Ä–∞–±–æ—Ç–∫–∞ 401 –û—à–∏–±–æ–∫

## üìã –û–≥–ª—è–¥

–ü—Ä–æ–µ–∫—Ç —Ä–µ–∞–ª—ñ–∑—É—î **—Ç—Ä–∏—Ä—ñ–≤–Ω–µ–≤—É —Å–∏—Å—Ç–µ–º—É –∫–æ–Ω—Ç—Ä–æ–ª—é –¥–æ—Å—Ç—É–ø—É** –∑ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ—é –æ–±—Ä–æ–±–∫–æ—é 401 –ø–æ–º–∏–ª–æ–∫ —á–µ—Ä–µ–∑ –º–µ—Ö–∞–Ω—ñ–∑–º auto-refresh —Ç–æ–∫–µ–Ω—ñ–≤. –í—Å—è —Å–∏—Å—Ç–µ–º–∞ –ø–æ–±—É–¥–æ–≤–∞–Ω–∞ –Ω–∞ –ø—Ä–∏–Ω—Ü–∏–ø—ñ **Defense in Depth** (–∑–∞—Ö–∏—Å—Ç –≤ –≥–ª–∏–±–∏–Ω—É) –∑ –∫—ñ–ª—å–∫–æ–º–∞ —Ä—ñ–≤–Ω—è–º–∏ –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó.

---

## üèóÔ∏è –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞ –ó–∞—Ö–∏—Å—Ç—É

### –†—ñ–≤–Ω—ñ –ó–∞—Ö–∏—Å—Ç—É

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –£–†–û–í–ï–ù–¨ 1: Middleware (Next.js)                         ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ‚îÇ
‚îÇ  –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞: NextAuth —Å–µ—Å—Å—ñ—è (HTTP-only cookie)           ‚îÇ
‚îÇ  –î—ñ—è –ø—Ä–∏ –≤—ñ–¥—Å—É—Ç–Ω–æ—Å—Ç—ñ: –†–µ–¥–∏—Ä–µ–∫—Ç ‚Üí /api/auth/signin       ‚îÇ
‚îÇ  –§–∞–π–ª: frontend/src/middleware.ts                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                        ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –£–†–û–í–ï–ù–¨ 2: BackendTokenPresenceGate (React HOC)         ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ‚îÇ
‚îÇ  –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞: Backend —Ç–æ–∫–µ–Ω–∏ –≤ Redis                       ‚îÇ
‚îÇ  –î—ñ—è –ø—Ä–∏ –≤—ñ–¥—Å—É—Ç–Ω–æ—Å—Ç—ñ: –†–µ–¥–∏—Ä–µ–∫—Ç ‚Üí /login (—á–µ—Ä–µ–∑         ‚îÇ
‚îÇ                       redirectToAuth)                   ‚îÇ
‚îÇ  –§–∞–π–ª: frontend/src/components/AutoRia/Auth/             ‚îÇ
‚îÇ         BackendTokenPresenceGate.tsx                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                        ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –£–†–û–í–ï–ù–¨ 3: Runtime –û–±—Ä–æ–±–∫–∞ (API Routes + fetchWithAuth) ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ‚îÇ
‚îÇ  –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞: –í–∞–ª—ñ–¥–Ω—ñ—Å—Ç—å —Ç–æ–∫–µ–Ω—ñ–≤ –ø—Ä–∏ API –∑–∞–ø–∏—Ç–∞—Ö          ‚îÇ
‚îÇ  –î—ñ—è –ø—Ä–∏ 401: Auto-refresh ‚Üí Retry ‚Üí redirectToAuth    ‚îÇ
‚îÇ  –§–∞–π–ª–∏:                                                  ‚îÇ
‚îÇ    - frontend/src/utils/fetchWithAuth.ts               ‚îÇ
‚îÇ    - frontend/src/app/api/*/route.ts                    ‚îÇ
‚îÇ    - frontend/src/services/api/apiClient.ts             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üîê –†—ñ–≤–µ–Ω—å 1: Middleware - –ó–∞—Ö–∏—Å—Ç –Ω–∞ –†—ñ–≤–Ω—ñ –†–æ—É—Ç–∏–Ω–≥—É

### –ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è
–ü–µ—Ä—à–∞ –ª—ñ–Ω—ñ—è –∑–∞—Ö–∏—Å—Ç—É, —è–∫–∞ —Å–ø—Ä–∞—Ü—å–æ–≤—É—î **–î–û** —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥—É —Å—Ç–æ—Ä—ñ–Ω–∫–∏. –ü–µ—Ä–µ–≤—ñ—Ä—è—î –Ω–∞—è–≤–Ω—ñ—Å—Ç—å NextAuth —Å–µ—Å—Å—ñ—ó –¥–ª—è –≤—Å—ñ—Ö –∑–∞—Ö–∏—â–µ–Ω–∏—Ö –º–∞—Ä—à—Ä—É—Ç—ñ–≤.

### –§–∞–π–ª
`frontend/src/middleware.ts`

### –õ–æ–≥—ñ–∫–∞ –†–æ–±–æ—Ç–∏

```typescript
// –î–ª—è AutoRia —Å–µ–∫—Ü—ñ—ó
if (AUTORIA_PATHS.some(path => pathname.startsWith(path))) {
  const token = await getToken({ req, secret: process.env.NEXTAUTH_SECRET });
  
  if (!token || !token.email) {
    // ‚ùå –ù–µ–º–∞—î NextAuth —Å–µ—Å—Å—ñ—ó
    return NextResponse.redirect('/api/auth/signin?callbackUrl=<original_url>');
  }
  
  // ‚úÖ NextAuth —Å–µ—Å—Å—ñ—è —ñ—Å–Ω—É—î - –ø—Ä–æ–ø—É—Å–∫–∞—î–º–æ –¥–∞–ª—ñ –¥–æ —Ä—ñ–≤–Ω—è 2
  return NextResponse.next();
}
```

### –©–æ –ü–µ—Ä–µ–≤—ñ—Ä—è—î—Ç—å—Å—è
- ‚úÖ –ù–∞—è–≤–Ω—ñ—Å—Ç—å NextAuth —Å–µ—Å—Å—ñ—ó (HTTP-only cookie)
- ‚úÖ –í–∞–ª—ñ–¥–Ω—ñ—Å—Ç—å —Ç–æ–∫–µ–Ω—É —á–µ—Ä–µ–∑ `getToken()`
- ‚úÖ –ù–∞—è–≤–Ω—ñ—Å—Ç—å `email` –≤ —Ç–æ–∫–µ–Ω—ñ

### –î—ñ—ó –ø—Ä–∏ –í—ñ–¥—Å—É—Ç–Ω–æ—Å—Ç—ñ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó
1. –°—Ç–≤–æ—Ä—é—î—Ç—å—Å—è URL –¥–ª—è —Ä–µ–¥–∏—Ä–µ–∫—Ç—É: `/api/auth/signin?callbackUrl=<original_path>`
2. –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—î—Ç—å—Å—è –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω–∫—É OAuth –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó
3. –ü—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ—ó –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó - –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –Ω–∞ `callbackUrl`

### –¢–∏–ø–∏ –®–ª—è—Ö—ñ–≤

#### PUBLIC_PATHS (–Ω–µ –ø–æ—Ç—Ä–µ–±—É—é—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó)
```typescript
[
  '/api/auth',      // NextAuth internal endpoints
  '/api/redis',     // Redis API
  '/api/health',    // Health checks
  '/api/public',    // Public API endpoints
  '/register',     // User registration
  '/auth'          // Auth redirect page
]
```

#### INTERNAL_AUTH_PATHS (–ø–æ—Ç—Ä–µ–±—É—é—Ç—å NextAuth —Å–µ—Å—Å—ñ—é, –∞–ª–µ –Ω–µ backend —Ç–æ–∫–µ–Ω–∏)
```typescript
[
  '/login',    // Login page (–¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è backend —Ç–æ–∫–µ–Ω—ñ–≤)
  '/profile',  // User profile
  '/settings'  // Settings page
]
```

#### AUTORIA_PATHS (–ø–æ—Ç—Ä–µ–±—É—é—Ç—å NextAuth —Å–µ—Å—Å—ñ—é + backend —Ç–æ–∫–µ–Ω–∏)
```typescript
[
  '/autoria/search',
  '/autoria/ad',
  '/autoria/my-ads',
  '/autoria/favorites',
  '/autoria/create',
  '/autoria'  // All other autoria paths
]
```

### –û—Å–æ–±–ª–∏–≤–æ—Å—Ç—ñ
- ‚úÖ –ü—Ä–∞—Ü—é—î –Ω–∞ **—Å–µ—Ä–≤–µ—Ä–Ω—ñ–π —Å—Ç–æ—Ä–æ–Ω—ñ** (edge runtime)
- ‚úÖ –í–∏–∫–æ–Ω—É—î—Ç—å—Å—è **–î–û** —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ñ–≤
- ‚úÖ –ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∞ –∑–∞—Ç—Ä–∏–º–∫–∞ (–Ω–µ —á–µ–∫–∞—î –Ω–∞ client-side –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏)
- ‚ö†Ô∏è **–ù–ï –ø–µ—Ä–µ–≤—ñ—Ä—è—î** backend —Ç–æ–∫–µ–Ω–∏ (—Ü–µ —Ä—ñ–≤–µ–Ω—å 2)

---

## üîê –†—ñ–≤–µ–Ω—å 2: BackendTokenPresenceGate - –ó–∞—Ö–∏—Å—Ç –Ω–∞ –†—ñ–≤–Ω—ñ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ñ–≤

### –ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è
–î—Ä—É–≥–∞ –ª—ñ–Ω—ñ—è –∑–∞—Ö–∏—Å—Ç—É, —è–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä—è—î –Ω–∞—è–≤–Ω—ñ—Å—Ç—å backend —Ç–æ–∫–µ–Ω—ñ–≤ –≤ Redis **–ø—ñ—Å–ª—è** —Ç–æ–≥–æ, —è–∫ middleware –ø—ñ–¥—Ç–≤–µ—Ä–¥–∏–≤ NextAuth —Å–µ—Å—Å—ñ—é.

### –§–∞–π–ª
`frontend/src/components/AutoRia/Auth/BackendTokenPresenceGate.tsx`

### –õ–æ–≥—ñ–∫–∞ –†–æ–±–æ—Ç–∏

```typescript
const checkBackendTokens = async (isRetry = false) => {
  // 1. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ç–æ–∫–µ–Ω—ñ–≤ —á–µ—Ä–µ–∑ /api/auth/me (–ø–µ—Ä–µ–≤—ñ—Ä—è—î Redis)
  const tokenCheck = await fetch('/api/auth/me', {
    method: 'GET',
    credentials: 'include',
    cache: 'no-store'
  });

  if (tokenCheck.ok) {
    // ‚úÖ Backend —Ç–æ–∫–µ–Ω–∏ –∑–Ω–∞–π–¥–µ–Ω—ñ —ñ –≤–∞–ª—ñ–¥–Ω—ñ
    setIsLoading(false);
    return;
  }

  // 2. –Ø–∫—â–æ 401 —ñ —Ü–µ –ø–µ—Ä—à–∞ —Å–ø—Ä–æ–±–∞ - –ø—Ä–æ–±—É—î–º–æ refresh
  if (tokenCheck.status === 401 && !isRetry) {
    const refreshResponse = await fetch('/api/auth/refresh', {
      method: 'POST',
      credentials: 'include',
      cache: 'no-store'
    });

    if (refreshResponse.ok) {
      // ‚úÖ Refresh —É—Å–ø—ñ—à–Ω–∏–π - –ø–æ–≤—Ç–æ—Ä—é—î–º–æ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É
      return checkBackendTokens(true);
    }
    
    // ‚ùå Refresh –Ω–µ –≤–¥–∞–≤—Å—è (404 = —Ç–æ–∫–µ–Ω–∏ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω—ñ)
    if (refreshResponse.status === 404) {
      redirectToAuth(currentPath, 'tokens_not_found');
      return;
    }
  }

  // 3. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —É–Ω—ñ–≤–µ—Ä—Å–∞–ª—å–Ω—É —É—Ç–∏–ª—ñ—Ç—É –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ä–µ–¥–∏—Ä–µ–∫—Ç—É
  redirectToAuth(currentPath, 'auth_required');
};
```

### –©–æ –ü–µ—Ä–µ–≤—ñ—Ä—è—î—Ç—å—Å—è
- ‚úÖ –ù–∞—è–≤–Ω—ñ—Å—Ç—å backend —Ç–æ–∫–µ–Ω—ñ–≤ –≤ Redis (—á–µ—Ä–µ–∑ `/api/auth/me`)
- ‚úÖ –í–∞–ª—ñ–¥–Ω—ñ—Å—Ç—å —Ç–æ–∫–µ–Ω—ñ–≤ (—á–µ—Ä–µ–∑ backend –ø–µ—Ä–µ–≤—ñ—Ä–∫—É)
- ‚úÖ –ú–æ–∂–ª–∏–≤—ñ—Å—Ç—å auto-refresh –ø—Ä–∏ 401

### –î—ñ—ó –ø—Ä–∏ –í—ñ–¥—Å—É—Ç–Ω–æ—Å—Ç—ñ –¢–æ–∫–µ–Ω—ñ–≤

1. **–°–ø—Ä–æ–±–∞ auto-refresh** (—è–∫—â–æ –æ—Ç—Ä–∏–º–∞–ª–∏ 401):
   - –í–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è `/api/auth/refresh`
   - –Ø–∫—â–æ —É—Å–ø—ñ—à–Ω–æ - –ø–æ–≤—Ç–æ—Ä–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ç–æ–∫–µ–Ω—ñ–≤
   - –Ø–∫—â–æ 404 - —Ç–æ–∫–µ–Ω–∏ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω—ñ –≤ Redis

2. **–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è `redirectToAuth()`**:
   - –ü–µ—Ä–µ–≤—ñ—Ä—è—î –Ω–∞—è–≤–Ω—ñ—Å—Ç—å NextAuth —Å–µ—Å—Å—ñ—ó
   - –Ø–∫—â–æ —Å–µ—Å—Å—ñ—è —î ‚Üí —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ `/login` (–¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è backend —Ç–æ–∫–µ–Ω—ñ–≤)
   - –Ø–∫—â–æ —Å–µ—Å—Å—ñ—ó –Ω–µ–º–∞—î ‚Üí —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ `/api/auth/signin` (–¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Å–µ—Å—Å—ñ—ó)

### API Endpoint `/api/auth/me`
–ü–µ—Ä–µ–≤—ñ—Ä—è—î –Ω–∞—è–≤–Ω—ñ—Å—Ç—å —Ç–æ–∫–µ–Ω—ñ–≤ –≤ Redis —Ç–∞ –≤–∞–ª—ñ–¥–Ω—ñ—Å—Ç—å NextAuth —Å–µ—Å—Å—ñ—ó:

```typescript
// GET /api/auth/me
// –ü–æ–≤–µ—Ä—Ç–∞—î:
{
  authenticated: true,
  user: { id, email, name, ... }
}
// –ê–±–æ 401 —è–∫—â–æ –Ω–µ–º–∞—î —Å–µ—Å—Å—ñ—ó –∞–±–æ —Ç–æ–∫–µ–Ω—ñ–≤
```

### –û—Å–æ–±–ª–∏–≤–æ—Å—Ç—ñ
- ‚úÖ –ü—Ä–∞—Ü—é—î –Ω–∞ **–∫–ª—ñ—î–Ω—Ç—Å—å–∫—ñ–π —Å—Ç–æ—Ä–æ–Ω—ñ** (client component)
- ‚úÖ –í–∏–∫–æ–Ω—É—î—Ç—å—Å—è **–ø—ñ—Å–ª—è** —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥—É Layout
- ‚úÖ –ü–æ–∫–∞–∑—É—î loader –ø—ñ–¥ —á–∞—Å –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏
- ‚úÖ –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î `redirectToAuth()` –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–∏—Ö —Ä–µ–¥–∏—Ä–µ–∫—Ç—ñ–≤

---

## üîê –†—ñ–≤–µ–Ω—å 3: Runtime –û–±—Ä–æ–±–∫–∞ 401 - –ó–∞—Ö–∏—Å—Ç –ü—ñ–¥ –ß–∞—Å –í–∏–∫–æ–Ω–∞–Ω–Ω—è

### –ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è
–¢—Ä–µ—Ç—è –ª—ñ–Ω—ñ—è –∑–∞—Ö–∏—Å—Ç—É, —è–∫–∞ –æ–±—Ä–æ–±–ª—è—î 401 –ø–æ–º–∏–ª–∫–∏ –ø—ñ–¥ —á–∞—Å —Ä–µ–∞–ª—å–Ω–∏—Ö API –∑–∞–ø–∏—Ç—ñ–≤. –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ–Ω–æ–≤–ª—é—î —Ç–æ–∫–µ–Ω–∏ —Ç–∞ –ø–æ–≤—Ç–æ—Ä—é—î –∑–∞–ø–∏—Ç–∏.

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç–∏ –°–∏—Å—Ç–µ–º–∏

#### 1. `fetchWithAuth` - –£—Ç–∏–ª—ñ—Ç–∞ –¥–ª—è –ö–ª—ñ—î–Ω—Ç—Å—å–∫–∏—Ö –ó–∞–ø–∏—Ç—ñ–≤

**–§–∞–π–ª:** `frontend/src/utils/fetchWithAuth.ts`

**–õ–æ–≥—ñ–∫–∞:**

```typescript
export async function fetchWithAuth(input: RequestInfo | URL, init: RequestInit = {}): Promise<Response> {
  // 1. –†–æ–±–∏–º–æ –∑–∞–ø–∏—Ç –ë–ï–ó –¥–æ–¥–∞–≤–∞–Ω–Ω—è —Ç–æ–∫–µ–Ω—ñ–≤ –Ω–∞ –∫–ª—ñ—î–Ω—Ç—ñ
  // –¢–æ–∫–µ–Ω–∏ –¥–æ–¥–∞—é—Ç—å—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ –≤ API routes —á–µ—Ä–µ–∑ getAuthorizationHeaders()
  const resp = await fetch(input, {
    ...init,
    credentials: 'include', // –í–∞–∂–ª–∏–≤–æ –¥–ª—è –ø–µ—Ä–µ–¥–∞—á—ñ cookies –∑ —Å–µ—Å—Å—ñ—î—é
    cache: 'no-store'
  });

  // 2. –Ø–∫—â–æ –Ω–µ 401/403 - –ø–æ–≤–µ—Ä—Ç–∞—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å
  if (resp.status !== 401 && resp.status !== 403) {
    return resp;
  }

  // 3. 403 Forbidden - –≤—ñ–¥—Ä–∞–∑—É —Ä–µ–¥–∏—Ä–µ–∫—Ç
  if (resp.status === 403) {
    redirectToAuth(currentPath, 'forbidden');
    return resp;
  }

  // 4. 401 Unauthorized - —Å–ø—Ä–æ–±–∞ refresh
  const refresh = await fetch('/api/auth/refresh', {
    method: 'POST',
    cache: 'no-store',
    credentials: 'include'
  });

  if (refresh.ok) {
    // ‚úÖ Refresh —É—Å–ø—ñ—à–Ω–∏–π - –ø–æ–≤—Ç–æ—Ä—é—î–º–æ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∏–π –∑–∞–ø–∏—Ç
    const retry = await fetch(input, { ...init, credentials: 'include' });
    
    if (retry.status !== 401) {
      return retry; // ‚úÖ –£—Å–ø—ñ—Ö
    }
  }

  // 5. Refresh –Ω–µ –≤–¥–∞–≤—Å—è –∞–±–æ retry –≤—Å–µ —â–µ 401
  if (refresh.status === 404) {
    // –¢–æ–∫–µ–Ω–∏ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω—ñ –≤ Redis
    redirectToAuth(currentPath, 'tokens_not_found');
  } else {
    // –Ü–Ω—à–∞ –ø–æ–º–∏–ª–∫–∞
    redirectToAuth(currentPath, 'auth_required');
  }

  return resp;
}
```

**–ö–ª—é—á–æ–≤—ñ –û—Å–æ–±–ª–∏–≤–æ—Å—Ç—ñ:**
- ‚úÖ **–ù–ï –¥–æ–¥–∞—î —Ç–æ–∫–µ–Ω–∏ –Ω–∞ –∫–ª—ñ—î–Ω—Ç—ñ** - —Ç–æ–∫–µ–Ω–∏ –¥–æ–¥–∞—é—Ç—å—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ –≤ API routes
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π refresh –ø—Ä–∏ 401
- ‚úÖ –ü–æ–≤—Ç–æ—Ä–Ω–∏–π –∑–∞–ø–∏—Ç –ø—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ–≥–æ refresh
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∏–π —Ä–µ–¥–∏—Ä–µ–∫—Ç —á–µ—Ä–µ–∑ `redirectToAuth()`

#### 2. `getAuthorizationHeaders` - –û—Ç—Ä–∏–º–∞–Ω–Ω—è –¢–æ–∫–µ–Ω—ñ–≤ –¥–ª—è API Routes

**–§–∞–π–ª:** `frontend/src/common/constants/headers.ts`

**–õ–æ–≥—ñ–∫–∞:**

```typescript
export const getAuthorizationHeaders = async (baseUrlOverride?: string) => {
  // 1. –û—Ç—Ä–∏–º—É—î–º–æ —Ç–æ–∫–µ–Ω–∏ –∑ Redis
  const redisUrl = `${baseUrl}/api/redis?key=backend_auth`;
  const response = await fetch(redisUrl, { cache: 'no-store' });
  
  let accessToken: string | undefined;
  if (response.ok) {
    const data = await response.json();
    const authData = JSON.parse(data.value);
    accessToken = authData?.access;
  }

  // 2. –Ø–∫—â–æ —Ç–æ–∫–µ–Ω –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∏–π - –ø—Ä–æ–±—É—î–º–æ refresh
  if (!accessToken) {
    const refreshResp = await fetch(`${baseUrl}/api/auth/refresh`, { 
      method: 'POST', 
      cache: 'no-store' 
    });
    if (refreshResp.ok) {
      const refreshData = await refreshResp.json();
      accessToken = refreshData?.access;
    }
  }

  // 3. –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∑ —Ç–æ–∫–µ–Ω–æ–º (—è–∫—â–æ —î)
  if (!accessToken) {
    return { 'Content-Type': 'application/json' };
  }

  return {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${accessToken}`
  };
};
```

**–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –≤ API Routes:**

```typescript
// frontend/src/app/api/(backend)/autoria/cars/route.ts
export async function GET(request: NextRequest) {
  // –û—Ç—Ä–∏–º—É—î–º–æ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∑ —Ç–æ–∫–µ–Ω–æ–º –∑ Redis
  const authHeaders = await getAuthorizationHeaders(request.nextUrl.origin);
  
  // –ü—Ä–æ–∫—Å–∏—Ä—É—î–º–æ –∑–∞–ø–∏—Ç –¥–æ Django –∑ —Ç–æ–∫–µ–Ω–æ–º
  const response = await fetch(`${backendUrl}/api/ads/cars/`, {
    method: 'GET',
    headers: authHeaders
  });
  
  // –Ø–∫—â–æ 401 - –ø–æ–≤–µ—Ä—Ç–∞—î–º–æ –ø–æ–º–∏–ª–∫—É (–∫–ª—ñ—î–Ω—Ç –æ–±—Ä–æ–±–∏—Ç—å —á–µ—Ä–µ–∑ fetchWithAuth)
  if (!response.ok) {
    return NextResponse.json(
      { error: 'Backend request failed' },
      { status: response.status }
    );
  }
  
  return NextResponse.json(await response.json());
}
```

#### 3. `ServerAuthManager` - –°–µ—Ä–≤–µ—Ä–Ω–∞ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è

**–§–∞–π–ª:** `frontend/src/utils/auth/serverAuth.ts`

**–ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è:** –î–ª—è server-side –∑–∞–ø–∏—Ç—ñ–≤ (SSR, API routes) –∑ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–º refresh —Ç–æ–∫–µ–Ω—ñ–≤.

**–õ–æ–≥—ñ–∫–∞:**

```typescript
static async authenticatedFetch(
  request: NextRequest,
  url: string,
  options: AuthenticatedFetchOptions = {}
): Promise<Response> {
  // 1. –û—Ç—Ä–∏–º—É—î–º–æ —Ç–æ–∫–µ–Ω–∏ –∑ Redis
  let tokens = await this.getTokensFromRedis(request);
  if (!tokens) {
    throw new Error('No authentication tokens available');
  }

  // 2. –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ access token –Ω–µ –∑–∞—Å—Ç–∞—Ä—ñ–≤ (–ø–æ exp claim)
  if (this.isTokenExpired(tokens.access)) {
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π refresh –ü–ï–†–ï–î –∑–∞–ø–∏—Ç–æ–º
    const newAccessToken = await this.refreshToken(request, tokens.refresh);
    if (!newAccessToken) {
      throw new Error('Failed to refresh access token');
    }
    tokens.access = newAccessToken;
  }

  // 3. –†–æ–±–∏–º–æ –∑–∞–ø–∏—Ç –∑ —Ç–æ–∫–µ–Ω–æ–º
  const response = await fetch(url, {
    ...options,
    headers: {
      ...options.headers,
      'Authorization': `Bearer ${tokens.access}`
    }
  });

  // 4. –Ø–∫—â–æ 401 - –ø—Ä–æ–±—É—î–º–æ refresh —ñ –ø–æ–≤—Ç–æ—Ä—é—î–º–æ
  if (response.status === 401) {
    const newAccessToken = await this.refreshToken(request, tokens.refresh);
    if (!newAccessToken) {
      throw new Error('Authentication failed - unable to refresh token');
    }

    // –ü–æ–≤—Ç–æ—Ä—é—î–º–æ –∑–∞–ø–∏—Ç –∑ –Ω–æ–≤–∏–º —Ç–æ–∫–µ–Ω–æ–º
    return await fetch(url, {
      ...options,
      headers: {
        ...options.headers,
        'Authorization': `Bearer ${newAccessToken}`
      }
    });
  }

  return response;
}
```

**–û—Å–æ–±–ª–∏–≤–æ—Å—Ç—ñ:**
- ‚úÖ –ü—Ä–æ–≤—ñ–¥–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ exp claim (–ø—Ä–æ–∞–∫—Ç–∏–≤–Ω–∏–π refresh)
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π refresh –ø—Ä–∏ 401
- ‚úÖ Retry –∑ –Ω–æ–≤–∏–º —Ç–æ–∫–µ–Ω–æ–º

#### 4. `ApiClient` - –ö–ª—ñ—î–Ω—Ç—Å—å–∫–∏–π API –ö–ª—ñ—î–Ω—Ç

**–§–∞–π–ª:** `frontend/src/services/api/apiClient.ts`

**–õ–æ–≥—ñ–∫–∞:**

```typescript
async request<T>(endpoint: string, options: RequestOptions = {}): Promise<T> {
  // 1. –û—Ç—Ä–∏–º—É—î–º–æ —Ç–æ–∫–µ–Ω–∏ –∑ Redis (–Ω–∞ –∫–ª—ñ—î–Ω—Ç—ñ)
  if (!skipAuth) {
    const tokens = await this.getTokens(); // GET /api/redis?key=backend_auth
    if (tokens?.access) {
      requestHeaders['Authorization'] = `Bearer ${tokens.access}`;
    }
  }

  // 2. –†–æ–±–∏–º–æ –∑–∞–ø–∏—Ç
  const response = await fetch(url, { method, headers: requestHeaders, body });

  // 3. –Ø–∫—â–æ 401 - –ø—Ä–æ–±—É—î–º–æ refresh
  if (response.status === 401 && !skipAuth && !skipRetry) {
    const refreshSuccess = await this.refreshTokens(); // POST /api/auth/refresh
    
    if (refreshSuccess) {
      // –ü–æ–≤—Ç–æ—Ä—é—î–º–æ –∑–∞–ø–∏—Ç –∑ –Ω–æ–≤–∏–º —Ç–æ–∫–µ–Ω–æ–º
      return this.request<T>(endpoint, { ...options, skipRetry: true });
    } else {
      // –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ /login
      window.location.href = `/login?callbackUrl=${currentUrl}&error=session_expired`;
      throw new Error('Authentication failed - session expired');
    }
  }

  return await response.json();
}
```

---

## üîÑ –ü—Ä–æ—Ü–µ—Å –û–±—Ä–æ–±–∫–∏ 401 –ü–æ–º–∏–ª–æ–∫

### –°—Ü–µ–Ω–∞—Ä—ñ–π 1: –ó–∞—Å—Ç–∞—Ä—ñ–ª–∏–π Access Token (–ù–∞–π–ø–æ—à–∏—Ä–µ–Ω—ñ—à–∏–π)

```
–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á —Ä–æ–±–∏—Ç—å API –∑–∞–ø–∏—Ç
    ‚Üì
API route –æ—Ç—Ä–∏–º—É—î —Ç–æ–∫–µ–Ω –∑ Redis —á–µ—Ä–µ–∑ getAuthorizationHeaders()
    ‚Üì
–ó–∞–ø–∏—Ç –¥–æ Django –∑ Authorization: Bearer <access_token>
    ‚Üì
Django –ø–æ–≤–µ—Ä—Ç–∞—î 401 (—Ç–æ–∫–µ–Ω –∑–∞—Å—Ç–∞—Ä—ñ–≤)
    ‚Üì
[–†—ñ–≤–µ–Ω—å 3] fetchWithAuth –æ—Ç—Ä–∏–º—É—î 401
    ‚Üì
1. –í–∏–∫–ª–∏–∫–∞—î POST /api/auth/refresh
   ‚Üì
   a. /api/auth/refresh –æ—Ç—Ä–∏–º—É—î refresh_token –∑ Redis
   b. –í–∏–∫–ª–∏–∫–∞—î Django /api/auth/refresh
   c. –û—Ç—Ä–∏–º—É—î –Ω–æ–≤–∏–π access_token
   d. –ó–±–µ—Ä—ñ–≥–∞—î –≤ Redis
   e. –ü–æ–≤–µ—Ä—Ç–∞—î –Ω–æ–≤–∏–π access_token
    ‚Üì
2. –ü–æ–≤—Ç–æ—Ä—é—î –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∏–π –∑–∞–ø–∏—Ç –∑ –Ω–æ–≤–∏–º —Ç–æ–∫–µ–Ω–æ–º
    ‚Üì
3. –Ø–∫—â–æ —É—Å–ø—ñ—à–Ω–æ - –ø–æ–≤–µ—Ä—Ç–∞—î –¥–∞–Ω—ñ
   –Ø–∫—â–æ –∑–Ω–æ–≤—É 401 - —Ä–µ–¥–∏—Ä–µ–∫—Ç —á–µ—Ä–µ–∑ redirectToAuth()
```

### –°—Ü–µ–Ω–∞—Ä—ñ–π 2: Refresh Token —Ç–∞–∫–æ–∂ –∑–∞—Å—Ç–∞—Ä—ñ–≤

```
–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á —Ä–æ–±–∏—Ç—å API –∑–∞–ø–∏—Ç
    ‚Üì
–û—Ç—Ä–∏–º—É—î–º–æ 401 –≤—ñ–¥ Django
    ‚Üì
–°–ø—Ä–æ–±–∞ refresh —á–µ—Ä–µ–∑ /api/auth/refresh
    ‚Üì
Django –ø–æ–≤–µ—Ä—Ç–∞—î 401 (refresh_token —Ç–∞–∫–æ–∂ –∑–∞—Å—Ç–∞—Ä—ñ–≤)
    ‚Üì
/api/auth/refresh –ø–æ–≤–µ—Ä—Ç–∞—î 401
    ‚Üì
fetchWithAuth –≤–∏–∫–ª–∏–∫–∞—î redirectToAuth(currentPath, 'session_expired')
    ‚Üì
redirectToAuth:
  1. –ü–µ—Ä–µ–≤—ñ—Ä—è—î NextAuth —Å–µ—Å—Å—ñ—é —á–µ—Ä–µ–∑ /api/auth/session
     ‚Üì
     a. –Ø–∫—â–æ —Å–µ—Å—Å—ñ—è —î ‚Üí —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ /login (–¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –Ω–æ–≤–∏—Ö —Ç–æ–∫–µ–Ω—ñ–≤)
     b. –Ø–∫—â–æ —Å–µ—Å—Å—ñ—ó –Ω–µ–º–∞—î ‚Üí —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ /api/auth/signin (–¥–ª—è OAuth)
```

### –°—Ü–µ–Ω–∞—Ä—ñ–π 3: –¢–æ–∫–µ–Ω–∏ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω—ñ –≤ Redis (404)

```
–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á —Ä–æ–±–∏—Ç—å API –∑–∞–ø–∏—Ç
    ‚Üì
getAuthorizationHeaders() –Ω–µ –∑–Ω–∞—Ö–æ–¥–∏—Ç—å —Ç–æ–∫–µ–Ω–∏ –≤ Redis
    ‚Üì
–°–ø—Ä–æ–±–∞ refresh —á–µ—Ä–µ–∑ /api/auth/refresh
    ‚Üì
/api/auth/refresh –æ—Ç—Ä–∏–º—É—î 404 (—Ç–æ–∫–µ–Ω–∏ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω—ñ –≤ Redis)
    ‚Üì
fetchWithAuth –æ–±—Ä–æ–±–ª—è—î 404 –≤—ñ–¥ refresh
    ‚Üì
redirectToAuth(currentPath, 'tokens_not_found')
    ‚Üì
redirectToAuth:
  1. –ü–µ—Ä–µ–≤—ñ—Ä—è—î NextAuth —Å–µ—Å—Å—ñ—é
     ‚Üì
     a. –Ø–∫—â–æ —Å–µ—Å—Å—ñ—è —î ‚Üí —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ /login (–æ—Ç—Ä–∏–º–∞—Ç–∏ —Ç–æ–∫–µ–Ω–∏)
     b. –Ø–∫—â–æ —Å–µ—Å—Å—ñ—ó –Ω–µ–º–∞—î ‚Üí —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ /api/auth/signin
```

### –°—Ü–µ–Ω–∞—Ä—ñ–π 4: 403 Forbidden (–ù–µ–º–∞—î –ü—Ä–∞–≤ –î–æ—Å—Ç—É–ø—É)

```
–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á —Ä–æ–±–∏—Ç—å API –∑–∞–ø–∏—Ç
    ‚Üì
Django –ø–æ–≤–µ—Ä—Ç–∞—î 403 (–Ω–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –ø—Ä–∞–≤)
    ‚Üì
fetchWithAuth –æ–±—Ä–æ–±–ª—è—î 403
    ‚Üì
–ù–ï –ø—Ä–æ–±—É—î refresh (403 –Ω–µ –æ–∑–Ω–∞—á–∞—î –Ω–µ–≤–∞–ª—ñ–¥–Ω–∏–π —Ç–æ–∫–µ–Ω)
    ‚Üì
–í—ñ–¥—Ä–∞–∑—É —Ä–µ–¥–∏—Ä–µ–∫—Ç —á–µ—Ä–µ–∑ redirectToAuth(currentPath, 'forbidden')
    ‚Üì
–†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ /login –∑ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è–º –ø—Ä–æ –≤—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å –ø—Ä–∞–≤
```

---

## üåê WebSocket –ß–∞—Ç - –û–±—Ä–æ–±–∫–∞ –ü–æ–º–∏–ª–æ–∫ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó (–ö–æ–¥ 4001)

### –ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è
WebSocket –∑'—î–¥–Ω–∞–Ω–Ω—è –¥–ª—è —á–∞—Ç—É –ø–æ—Ç—Ä–µ–±—É—é—Ç—å –æ—Å–æ–±–ª–∏–≤–æ—ó –æ–±—Ä–æ–±–∫–∏ –ø–æ–º–∏–ª–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó, –æ—Å–∫—ñ–ª—å–∫–∏ –≤–æ–Ω–∏ –Ω–µ –º–æ–∂—É—Ç—å –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ñ HTTP —Å—Ç–∞—Ç—É—Å–∏. –ù–∞—Ç–æ–º—ñ—Å—Ç—å –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å—Å—è **—Å–ø–µ—Ü—ñ–∞–ª—å–Ω—ñ –∫–æ–¥–∏ –∑–∞–∫—Ä–∏—Ç—Ç—è WebSocket** (4000-4999 –¥–ª—è –ø–æ–º–∏–ª–æ–∫).

### –ö–æ–¥–∏ –ü–æ–º–∏–ª–æ–∫ WebSocket

| –ö–æ–¥ | –ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è | –û–ø–∏—Å |
|-----|-------------|------|
| `4000` | –í–Ω—É—Ç—Ä—ñ—à–Ω—è –ø–æ–º–∏–ª–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ | –ó–∞–≥–∞–ª—å–Ω–∞ –ø–æ–º–∏–ª–∫–∞ –ø—ñ–¥ —á–∞—Å –∑'—î–¥–Ω–∞–Ω–Ω—è |
| `4001` | –ü–æ–º–∏–ª–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó | –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–∏–π –∞–±–æ —Ç–æ–∫–µ–Ω –Ω–µ–≤–∞–ª—ñ–¥–Ω–∏–π |
| `1008` | Policy Violation | –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–π –∫–æ–¥ –¥–ª—è –ø–æ–º–∏–ª–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó |

### –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞ –ó–∞—Ö–∏—Å—Ç—É WebSocket

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Backend Middleware: JWTAuthMiddleware                   ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ‚îÇ
‚îÇ  –§–∞–π–ª: backend/core/middlewares/auth_socket.py           ‚îÇ
‚îÇ                                                          ‚îÇ
‚îÇ  1. –û—Ç—Ä–∏–º—É—î —Ç–æ–∫–µ–Ω –∑ query –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤ –∞–±–æ headers        ‚îÇ
‚îÇ  2. –í–∞–ª—ñ–¥—É—î —Ç–æ–∫–µ–Ω —á–µ—Ä–µ–∑ JwtService.validate_any_token() ‚îÇ
‚îÇ  3. –Ø–∫—â–æ —Ç–æ–∫–µ–Ω –≤–∞–ª—ñ–¥–Ω–∏–π ‚Üí scope["user"] = user          ‚îÇ
‚îÇ  4. –Ø–∫—â–æ —Ç–æ–∫–µ–Ω –Ω–µ–≤–∞–ª—ñ–¥–Ω–∏–π ‚Üí scope["user"] = None        ‚îÇ
‚îÇ     (–∞–ª–µ –¥–æ–∑–≤–æ–ª—è—î –∞–Ω–æ–Ω—ñ–º–Ω–µ –∑'—î–¥–Ω–∞–Ω–Ω—è –¥–ª—è refresh)       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Backend Consumer: EnhancedChatConsumer                  ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ‚îÇ
‚îÇ  –§–∞–π–ª: backend/apps/chat/consumer.py                     ‚îÇ
‚îÇ                                                          ‚îÇ
‚îÇ  async def connect(self):                                ‚îÇ
‚îÇ    self.user = self.scope.get("user")                    ‚îÇ
‚îÇ    if not self._is_user_authorized():                    ‚îÇ
‚îÇ      await self.close(code=4001)  # ‚ùå –ó–∞–∫—Ä–∏–≤–∞—î–º–æ         ‚îÇ
‚îÇ      return                                               ‚îÇ
‚îÇ    await self.accept()  # ‚úÖ –ü—Ä–∏–π–º–∞—î–º–æ –∑'—î–¥–Ω–∞–Ω–Ω—è        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Frontend: useChatWebSocket Hook                         ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ‚îÇ
‚îÇ  –§–∞–π–ª: frontend/src/components/ChatBot/                  ‚îÇ
‚îÇ         hooks/useChatWebSocket.ts                         ‚îÇ
‚îÇ                                                          ‚îÇ
‚îÇ  –û–±—Ä–æ–±–∫–∞ socket.onclose:                                 ‚îÇ
‚îÇ    if (event.code === 4001 || event.code === 1008) {    ‚îÇ
‚îÇ      1. –°–ø—Ä–æ–±–∞ refresh —Ç–æ–∫–µ–Ω—ñ–≤ (–º–∞–∫—Å. 3 —Å–ø—Ä–æ–±–∏)        ‚îÇ
‚îÇ      2. –Ø–∫—â–æ refresh —É—Å–ø—ñ—à–Ω–∏–π ‚Üí –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—è       ‚îÇ
‚îÇ      3. –Ø–∫—â–æ refresh –Ω–µ –≤–¥–∞–≤—Å—è ‚Üí redirectToAuth()      ‚îÇ
‚îÇ    }                                                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Backend: JWTAuthMiddleware

**–§–∞–π–ª:** `backend/core/middlewares/auth_socket.py`

**–û—Å–æ–±–ª–∏–≤–æ—Å—Ç—ñ:**
- ‚úÖ **–ù–µ –±–ª–æ–∫—É—î –∑'—î–¥–Ω–∞–Ω–Ω—è** –Ω–∞–≤—ñ—Ç—å —è–∫—â–æ —Ç–æ–∫–µ–Ω –Ω–µ–≤–∞–ª—ñ–¥–Ω–∏–π (–¥–ª—è –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ refresh)
- ‚úÖ –ü–æ–∑–Ω–∞—á–∞—î `scope["user"] = None` —Ç–∞ `scope["auth_required"] = True` —è–∫—â–æ —Ç–æ–∫–µ–Ω –≤—ñ–¥—Å—É—Ç–Ω—ñ–π/–Ω–µ–≤–∞–ª—ñ–¥–Ω–∏–π
- ‚úÖ –î–æ–∑–≤–æ–ª—è—î `EnhancedChatConsumer` –ø—Ä–∏–π–Ω—è—Ç–∏ —Ä—ñ—à–µ–Ω–Ω—è –ø—Ä–æ –∑–∞–∫—Ä–∏—Ç—Ç—è

**–õ–æ–≥—ñ–∫–∞:**

```python
async def __call__(self, scope, receive, send):
    # 1. –û—Ç—Ä–∏–º—É—î–º–æ —Ç–æ–∫–µ–Ω –∑ query –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤ –∞–±–æ headers
    token = self._extract_token(query_params, headers)
    
    if not token:
        # –î–æ–∑–≤–æ–ª—è—î–º–æ –∞–Ω–æ–Ω—ñ–º–Ω–µ –∑'—î–¥–Ω–∞–Ω–Ω—è (–¥–ª—è –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ refresh)
        scope["user"] = None
        scope["auth_required"] = True
        return await super().__call__(scope, receive, send)
    
    # 2. –í–∞–ª—ñ–¥—É—î–º–æ —Ç–æ–∫–µ–Ω
    try:
        validated_user = await self._validate_token(token)
        if validated_user:
            scope["user"] = validated_user
            scope["auth_required"] = False
        else:
            scope["user"] = None
            scope["auth_required"] = True
    except Exception:
        scope["user"] = None
        scope["auth_required"] = True
    
    return await super().__call__(scope, receive, send)
```

### Backend: EnhancedChatConsumer

**–§–∞–π–ª:** `backend/apps/chat/consumer.py`

**–õ–æ–≥—ñ–∫–∞:**

```python
async def connect(self):
    self.user = self.scope.get("user")
    
    # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó
    if not self._is_user_authorized():
        logger.warning("üõë Unauthorized connection attempt")
        await self._send_error("Authentication required")
        await self.close(code=4001)  # ‚ùå –ó–∞–∫—Ä–∏–≤–∞—î–º–æ –∑ –∫–æ–¥–æ–º 4001
        return
    
    # ‚úÖ –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–∏–π
    await self.accept()
    # ... —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è —á–∞—Ç—É
```

**–ú–µ—Ç–æ–¥ `_is_user_authorized()`:**
```python
def _is_user_authorized(self) -> bool:
    # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–æ–≤–∞–Ω–∏–π
    if not self.user or not self.user.is_authenticated:
        return False
    
    # –ú–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ –¥–æ–¥–∞—Ç–∫–æ–≤—ñ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ (—Ä–æ–ª—ñ, –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø—É)
    return True
```

### Frontend: –û–±—Ä–æ–±–∫–∞ –ü–æ–º–∏–ª–æ–∫ –≤ `useChatWebSocket`

**–§–∞–π–ª:** `frontend/src/components/ChatBot/hooks/useChatWebSocket.ts`

#### 1. –û—Ç—Ä–∏–º–∞–Ω–Ω—è –¢–æ–∫–µ–Ω–∞ –¥–ª—è WebSocket

```typescript
const getAccessToken = async (forceRefresh = false): Promise<string | null> => {
  // 1. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∫—ñ–ª—å–∫–æ—Å—Ç—ñ —Å–ø—Ä–æ–± refresh
  if (forceRefresh && tokenRefreshAttemptsRef.current >= MAX_TOKEN_REFRESH_ATTEMPTS) {
    redirectToLogin("Too many authentication attempts. Please login again.");
    return null;
  }

  // 2. –û—Ç—Ä–∏–º—É—î–º–æ —Ç–æ–∫–µ–Ω–∏ –∑ Redis —á–µ—Ä–µ–∑ /api/auth/token
  const tokenResponse = await fetch("/api/auth/token", {
    method: "GET",
    credentials: "include",
  });

  if (tokenResponse.ok) {
    const data = await tokenResponse.json();
    const accessToken = data?.access;
    
    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ —ñ—Å—Ç–µ—á–µ–Ω–Ω—è (–ø–æ exp claim)
    if (accessToken && !isTokenExpired(accessToken)) {
      return accessToken; // ‚úÖ –í–∞–ª—ñ–¥–Ω–∏–π —Ç–æ–∫–µ–Ω
    }
  }

  // 3. –Ø–∫—â–æ —Ç–æ–∫–µ–Ω –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∏–π –∞–±–æ –∑–∞—Å—Ç–∞—Ä—ñ–≤ - —Å–ø—Ä–æ–±–∞ refresh
  if (forceRefresh || !accessToken) {
    tokenRefreshAttemptsRef.current++;
    
    const refreshResponse = await fetch("/api/auth/refresh", {
      method: "POST",
      credentials: "include",
    });

    if (refreshResponse.ok) {
      const refreshData = await refreshResponse.json();
      return refreshData?.access; // ‚úÖ –ù–æ–≤–∏–π —Ç–æ–∫–µ–Ω
    }
  }

  return null;
};
```

#### 2. –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è WebSocket –ó'—î–¥–Ω–∞–Ω–Ω—è

```typescript
const connect = async (customChannelId?: string) => {
  // 1. –û—Ç—Ä–∏–º—É—î–º–æ —Ç–æ–∫–µ–Ω –¥–æ—Å—Ç—É–ø—É
  let token = await getAccessToken(false);
  
  // 2. –Ø–∫—â–æ —Ç–æ–∫–µ–Ω –Ω–µ –æ—Ç—Ä–∏–º–∞–Ω–æ - —Å–ø—Ä–æ–±–∞ –ø—Ä–∏–º—É—Å–æ–≤–æ–≥–æ refresh
  if (!token && tokenRefreshAttemptsRef.current < MAX_TOKEN_REFRESH_ATTEMPTS) {
    token = await getAccessToken(true); // –ü—Ä–∏–º—É—Å–æ–≤–∏–π refresh
  }

  // 3. –Ø–∫—â–æ —Ç–æ–∫–µ–Ω –≤—Å–µ —â–µ –≤—ñ–¥—Å—É—Ç–Ω—ñ–π - –ø–æ–º–∏–ª–∫–∞
  if (!token) {
    toast({
      title: "Connection Error",
      description: "Failed to get authentication token. Redirecting to login...",
      variant: "destructive",
    });
    redirectToLogin("Authentication failed. Please login again.");
    return;
  }

  // 4. –°—Ç–≤–æ—Ä—é—î–º–æ WebSocket –∑'—î–¥–Ω–∞–Ω–Ω—è –∑ —Ç–æ–∫–µ–Ω–æ–º
  const wsUrl = `wss://backend.example.com/api/chat/${channelId}/?token=${token}`;
  const socket = new WebSocket(wsUrl);

  // 5. –û–±—Ä–æ–±–∫–∞ –ø–æ–¥—ñ–π
  socket.onopen = () => {
    // ‚úÖ –ó'—î–¥–Ω–∞–Ω–Ω—è –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ
    setIsConnected(true);
    tokenRefreshAttemptsRef.current = 0; // –°–∫–∏–¥–∞—î–º–æ –ª—ñ—á–∏–ª—å–Ω–∏–∫
  };

  socket.onclose = (event) => {
    // –û–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó
    if (event.code === 4001 || event.code === 1008) {
      handleAuthError(event);
    }
  };
};
```

#### 3. –û–±—Ä–æ–±–∫–∞ –ü–æ–º–∏–ª–æ–∫ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó (4001)

```typescript
socket.onclose = (event) => {
  // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—à–∏–±–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
  if (event.code === 1008 || event.code === 4001) {
    wsLogger.error(
      `WebSocket closed due to authentication error: code=${event.code}, reason=${event.reason}`,
    );

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ —Å–ø—Ä–æ–±–∞ refresh —Ç–æ–∫–µ–Ω—ñ–≤
    (async () => {
      wsLogger.info("Attempting to refresh token after authentication error");

      // –ü–æ–∫–∞–∑—É—î–º–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É
      toast({
        title: "Authentication",
        description: "Refreshing authentication token...",
        duration: 5000,
      });

      // –ü—Ä–∏–º—É—Å–æ–≤–æ –æ–Ω–æ–≤–ª—é—î–º–æ —Ç–æ–∫–µ–Ω (–∑ –ª—ñ—á–∏–ª—å–Ω–∏–∫–æ–º —Å–ø—Ä–æ–±)
      const newToken = await getAccessToken(true);

      if (newToken) {
        wsLogger.info("Token refreshed successfully, reconnecting...");

        toast({
          title: "Authentication",
          description: "Token refreshed successfully, reconnecting...",
          duration: 3000,
        });

        // ‚úÖ –¢–æ–∫–µ–Ω –æ–Ω–æ–≤–ª–µ–Ω–æ - –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞—î–º–æ—Å—å
        setTimeout(() => {
          connect(targetChannelId);
        }, 1000);
      } else {
        // ‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –æ–Ω–æ–≤–∏—Ç–∏ —Ç–æ–∫–µ–Ω –ø—ñ—Å–ª—è –≤—Å—ñ—Ö —Å–ø—Ä–æ–±
        wsLogger.error(
          "Failed to refresh token after all attempts, redirecting to login page",
        );
        redirectToLogin("Authentication failed after multiple attempts. Please login again.");
      }
    })();
    return; // –í–∞–∂–ª–∏–≤–æ: –≤–∏—Ö–æ–¥–∏–º–æ, —â–æ–± –Ω–µ –æ–±—Ä–æ–±–ª—è—Ç–∏ —è–∫ –∑–≤–∏—á–∞–π–Ω–µ –∑–∞–∫—Ä–∏—Ç—Ç—è
  }

  // –û–±—Ä–æ–±–∫–∞ —ñ–Ω—à–∏—Ö –ø–æ–º–∏–ª–æ–∫ (4000, –∑–≤–∏—á–∞–π–Ω—ñ –∑–∞–∫—Ä–∏—Ç—Ç—è —Ç–æ—â–æ)
  // ...
};
```

#### 4. –û–±—Ä–æ–±–∫–∞ –ü–æ–º–∏–ª–æ–∫ –ü—ñ–¥ –ß–∞—Å –ó'—î–¥–Ω–∞–Ω–Ω—è (`onerror`)

```typescript
socket.onerror = (error) => {
  wsLogger.error(`WebSocket error for channel ${targetChannelId}`, { error });

  // –Ø–∫—â–æ —Ü–µ –ø–æ–º–∏–ª–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó —Ç–∞ —â–µ —î —Å–ø—Ä–æ–±–∏ refresh
  if (tokenRefreshAttemptsRef.current < MAX_TOKEN_REFRESH_ATTEMPTS) {
    tokenRefreshAttemptsRef.current += 1;

    toast({
      title: "Connection Error",
      description: `Refreshing authentication tokens... (${tokenRefreshAttemptsRef.current}/${MAX_TOKEN_REFRESH_ATTEMPTS})`,
      variant: "destructive",
      duration: 3000,
    });

    (async () => {
      // –ü—Ä–∏–º—É—Å–æ–≤–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Ç–æ–∫–µ–Ω—ñ–≤
      const newToken = await getAccessToken(true);

      if (newToken) {
        wsLogger.info("Token forcefully refreshed successfully, reconnecting...");
        toast({
          title: "Authentication Updated",
          description: "Tokens refreshed successfully, reconnecting...",
          duration: 2000,
        });

        // –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞—î–º–æ—Å—å
        setTimeout(() => {
          connect(targetChannelId);
        }, 1500);
      } else {
        // –ù–µ –≤–¥–∞–ª–æ—Å—è –æ–Ω–æ–≤–∏—Ç–∏ - —Ä–µ–¥–∏—Ä–µ–∫—Ç
        redirectToLogin("Authentication failed. Please login again.");
      }
    })();
  }
};
```

### –ü—Ä–æ—Ü–µ—Å –û–±—Ä–æ–±–∫–∏ 4001 –ü–æ–º–∏–ª–æ–∫

#### –°—Ü–µ–Ω–∞—Ä—ñ–π 1: –¢–æ–∫–µ–Ω –í—ñ–¥—Å—É—Ç–Ω—ñ–π –∞–±–æ –ù–µ–≤–∞–ª—ñ–¥–Ω–∏–π

```
Frontend: –°—Ç–≤–æ—Ä—é—î WebSocket –∑'—î–¥–Ω–∞–Ω–Ω—è –ë–ï–ó —Ç–æ–∫–µ–Ω–∞ –∞–±–æ –∑ –Ω–µ–≤–∞–ª—ñ–¥–Ω–∏–º —Ç–æ–∫–µ–Ω–æ–º
    ‚Üì
Backend: JWTAuthMiddleware
    ‚Üì
    scope["user"] = None
    scope["auth_required"] = True
    ‚Üì
Backend: EnhancedChatConsumer.connect()
    ‚Üì
    if not self._is_user_authorized():
        await self.close(code=4001)  # ‚ùå –ó–∞–∫—Ä–∏–≤–∞—î–º–æ –∑'—î–¥–Ω–∞–Ω–Ω—è
    ‚Üì
Frontend: socket.onclose(event.code === 4001)
    ‚Üì
    1. –ü–æ–∫–∞–∑—É—î–º–æ toast: "Refreshing authentication token..."
    2. –í–∏–∫–ª–∏–∫–∞—î–º–æ getAccessToken(true) - –ø—Ä–∏–º—É—Å–æ–≤–∏–π refresh
       ‚Üì
       a. POST /api/auth/refresh
       b. –û—Ç—Ä–∏–º—É—î–º–æ –Ω–æ–≤–∏–π —Ç–æ–∫–µ–Ω –∑ Redis
       c. –í–∏–∫–ª–∏–∫–∞—î–º–æ Django /api/auth/refresh
       d. –û—Ç—Ä–∏–º—É—î–º–æ –Ω–æ–≤–∏–π access_token
       e. –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –≤ Redis
    ‚Üì
    3. –Ø–∫—â–æ refresh —É—Å–ø—ñ—à–Ω–∏–π:
       a. –ü–æ–∫–∞–∑—É—î–º–æ toast: "Token refreshed, reconnecting..."
       b. setTimeout(() => connect(channelId), 1000)
       c. –°—Ç–≤–æ—Ä—é—î–º–æ –ù–û–í–ï WebSocket –∑'—î–¥–Ω–∞–Ω–Ω—è –∑ –Ω–æ–≤–∏–º —Ç–æ–∫–µ–Ω–æ–º
    ‚Üì
    4. –Ø–∫—â–æ refresh –Ω–µ –≤–¥–∞–≤—Å—è (–º–∞–∫—Å. —Å–ø—Ä–æ–± –¥–æ—Å—è–≥–Ω—É—Ç–æ):
       a. redirectToLogin("Authentication failed...")
       b. –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ /login –∞–±–æ /api/auth/signin
```

#### –°—Ü–µ–Ω–∞—Ä—ñ–π 2: –¢–æ–∫–µ–Ω –ó–∞—Å—Ç–∞—Ä—ñ–≤ –ü—ñ–¥ –ß–∞—Å –†–æ–±–æ—Ç–∏

```
WebSocket –∑'—î–¥–Ω–∞–Ω–Ω—è –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∑ –≤–∞–ª—ñ–¥–Ω–∏–º —Ç–æ–∫–µ–Ω–æ–º
    ‚Üì
–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î —á–∞—Ç (–Ω–∞–¥—Å–∏–ª–∞—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è)
    ‚Üì
Backend: Django –ø–µ—Ä–µ–≤—ñ—Ä—è—î —Ç–æ–∫–µ–Ω –ø—Ä–∏ –æ–±—Ä–æ–±—Ü—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
    ‚Üì
‚ùå Token expired ‚Üí Backend –∑–∞–∫—Ä–∏–≤–∞—î –∑'—î–¥–Ω–∞–Ω–Ω—è –∑ –∫–æ–¥–æ–º 4001
    ‚Üì
Frontend: socket.onclose(event.code === 4001)
    ‚Üì
–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π refresh —Ç–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—è (—è–∫ —É –°—Ü–µ–Ω–∞—Ä—ñ—ó 1)
```

#### –°—Ü–µ–Ω–∞—Ä—ñ–π 3: Refresh Token —Ç–∞–∫–æ–∂ –ó–∞—Å—Ç–∞—Ä—ñ–≤

```
Frontend: socket.onclose(event.code === 4001)
    ‚Üì
–°–ø—Ä–æ–±–∞ refresh —á–µ—Ä–µ–∑ getAccessToken(true)
    ‚Üì
POST /api/auth/refresh
    ‚Üì
Django –ø–æ–≤–µ—Ä—Ç–∞—î 401 (refresh_token —Ç–∞–∫–æ–∂ –∑–∞—Å—Ç–∞—Ä—ñ–≤)
    ‚Üì
getAccessToken –ø–æ–≤–µ—Ä—Ç–∞—î null
    ‚Üì
redirectToLogin("Authentication failed after multiple attempts...")
    ‚Üì
redirectToAuth():
  1. –ü–µ—Ä–µ–≤—ñ—Ä—è—î NextAuth —Å–µ—Å—Å—ñ—é —á–µ—Ä–µ–∑ /api/auth/session
  2. –Ø–∫—â–æ —Å–µ—Å—Å—ñ—è —î ‚Üí —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ /login
  3. –Ø–∫—â–æ —Å–µ—Å—Å—ñ—ó –Ω–µ–º–∞—î ‚Üí —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ /api/auth/signin
```

### –ó–∞—Ö–∏—Å—Ç –≤—ñ–¥ –ó–∞—Ü–∏–∫–ª–µ–Ω–Ω—è

**–õ—ñ—á–∏–ª—å–Ω–∏–∫ –°–ø—Ä—Ä–æ–±:**
```typescript
const MAX_TOKEN_REFRESH_ATTEMPTS = 3;
const tokenRefreshAttemptsRef = useRef<number>(0);

// –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø–µ—Ä–µ–¥ refresh
if (tokenRefreshAttemptsRef.current >= MAX_TOKEN_REFRESH_ATTEMPTS) {
  redirectToLogin("Too many authentication attempts. Please login again.");
  return null;
}

// –ó–±—ñ–ª—å—à–µ–Ω–Ω—è –ª—ñ—á–∏–ª—å–Ω–∏–∫–∞
tokenRefreshAttemptsRef.current++;

// –°–∫–∏–¥–∞–Ω–Ω—è –ø—Ä–∏ —É—Å–ø—ñ—à–Ω–æ–º—É –∑'—î–¥–Ω–∞–Ω–Ω—ñ
socket.onopen = () => {
  tokenRefreshAttemptsRef.current = 0;
  reconnectAttempts.current = 0;
};
```

**–õ—ñ—á–∏–ª—å–Ω–∏–∫ –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω—å:**
```typescript
const reconnectAttempts = useRef(0);
const maxReconnectAttempts = 3;

// –ü—Ä–∏ –∑–∞–∫—Ä–∏—Ç—Ç—ñ (–Ω–µ —á–µ—Ä–µ–∑ 4001)
if (reconnectAttempts.current < maxReconnectAttempts) {
  reconnectAttempts.current++;
  setTimeout(() => connect(channelId), 2000 * reconnectAttempts.current);
}
```

### –û—Å–æ–±–ª–∏–≤–æ—Å—Ç—ñ –†–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó

#### 1. –ê–Ω–æ–Ω—ñ–º–Ω–µ –ó'—î–¥–Ω–∞–Ω–Ω—è –¥–ª—è Refresh

Backend –¥–æ–∑–≤–æ–ª—è—î –∞–Ω–æ–Ω—ñ–º–Ω—ñ WebSocket –∑'—î–¥–Ω–∞–Ω–Ω—è (–∑ `scope["user"] = None`), —â–æ–± frontend –º—ñ–≥ —Å–ø—Ä–æ–±—É–≤–∞—Ç–∏ refresh —Ç–æ–∫–µ–Ω—ñ–≤. –ê–ª–µ `EnhancedChatConsumer` –∑–∞–∫—Ä–∏–≤–∞—î —Ç–∞–∫—ñ –∑'—î–¥–Ω–∞–Ω–Ω—è –∑ –∫–æ–¥–æ–º 4001.

#### 2. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¢–æ–∫–µ–Ω–∞ –î–û –ó'—î–¥–Ω–∞–Ω–Ω—è

Frontend –æ—Ç—Ä–∏–º—É—î —Ç–æ–∫–µ–Ω –∑ Redis (`/api/auth/token`) —Ç–∞ –ø–µ—Ä–µ–≤—ñ—Ä—è—î –π–æ–≥–æ –Ω–∞ —ñ—Å—Ç–µ—á–µ–Ω–Ω—è (–ø–æ `exp` claim) **–ü–ï–†–ï–î** —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è–º WebSocket –∑'—î–¥–Ω–∞–Ω–Ω—è. –¶–µ –ø—Ä–æ–∞–∫—Ç–∏–≤–Ω–∏–π –ø—ñ–¥—Ö—ñ–¥, —è–∫–∏–π –∑–º–µ–Ω—à—É—î –∫—ñ–ª—å–∫—ñ—Å—Ç—å –Ω–µ–≤–¥–∞–ª–∏—Ö –∑'—î–¥–Ω–∞–Ω—å.

#### 3. –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π Retry –∑ –ó–∞—Ç—Ä–∏–º–∫–æ—é

–ü—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ–≥–æ refresh —Ç–æ–∫–µ–Ω—ñ–≤, frontend –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞—î—Ç—å—Å—è —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É, –¥–∞—é—á–∏ —á–∞—Å backend –∑–±–µ—Ä–µ–≥—Ç–∏ –Ω–æ–≤—ñ —Ç–æ–∫–µ–Ω–∏ –≤ Redis.

#### 4. –£–≤–µ–¥–æ–º–ª–µ–Ω–Ω—è –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—É

–°–∏—Å—Ç–µ–º–∞ –ø–æ–∫–∞–∑—É—î toast-–ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –Ω–∞ –∫–æ–∂–Ω–æ–º—É –µ—Ç–∞–ø—ñ:
- "Refreshing authentication token..." (–ø–æ—á–∞—Ç–æ–∫ refresh)
- "Token refreshed successfully, reconnecting..." (—É—Å–ø—ñ—à–Ω–∏–π refresh)
- "Authentication failed..." (–Ω–µ –≤–¥–∞–ª–æ—Å—è –æ–Ω–æ–≤–∏—Ç–∏)

### –ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è –∑ HTTP 401

| –ê—Å–ø–µ–∫—Ç | HTTP 401 | WebSocket 4001 |
|--------|----------|---------------|
| **–í–∏—è–≤–ª–µ–Ω–Ω—è** | –°—Ç–∞—Ç—É—Å –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ HTTP | –ö–æ–¥ –∑–∞–∫—Ä–∏—Ç—Ç—è WebSocket |
| **–û–±—Ä–æ–±–∫–∞** | `fetchWithAuth` –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ refresh | `socket.onclose` ‚Üí —Ä—É—á–Ω–∞ –æ–±—Ä–æ–±–∫–∞ |
| **Retry** | –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π retry –∑–∞–ø–∏—Ç—É | –†—É—á–Ω–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—è —á–µ—Ä–µ–∑ `connect()` |
| **–°—Ç–∞–Ω –∑'—î–¥–Ω–∞–Ω–Ω—è** | –ö–æ–∂–µ–Ω –∑–∞–ø–∏—Ç –Ω–µ–∑–∞–ª–µ–∂–Ω–∏–π | –ó'—î–¥–Ω–∞–Ω–Ω—è –∑–∞–∫—Ä–∏—Ç–µ, –ø–æ—Ç—Ä—ñ–±–Ω–µ –Ω–æ–≤–µ |

### –§–∞–π–ª–∏, –Ø–∫—ñ –ë–µ—Ä—É—Ç—å –£—á–∞—Å—Ç—å

**Backend:**
- `backend/core/middlewares/auth_socket.py` - Middleware –¥–ª—è –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó —Ç–æ–∫–µ–Ω—ñ–≤
- `backend/apps/chat/consumer.py` - Consumer, —è–∫–∏–π –∑–∞–∫—Ä–∏–≤–∞—î –∑'—î–¥–Ω–∞–Ω–Ω—è –∑ –∫–æ–¥–æ–º 4001
- `backend/core/services/jwt.py` - –í–∞–ª—ñ–¥–∞—Ü—ñ—è JWT —Ç–æ–∫–µ–Ω—ñ–≤

**Frontend:**
- `frontend/src/components/ChatBot/hooks/useChatWebSocket.ts` - –ì–æ–ª–æ–≤–Ω–∏–π —Ö—É–∫ –¥–ª—è WebSocket
- `frontend/src/app/api/auth/refresh/route.ts` - API route –¥–ª—è refresh —Ç–æ–∫–µ–Ω—ñ–≤
- `frontend/src/app/api/auth/token/route.ts` - API route –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Ç–æ–∫–µ–Ω—ñ–≤ –∑ Redis
- `frontend/src/utils/auth/redirectToAuth.ts` - –£—Ç–∏–ª—ñ—Ç–∞ –¥–ª—è —Ä–µ–¥–∏—Ä–µ–∫—Ç—ñ–≤

---

## üéØ –£–Ω—ñ–≤–µ—Ä—Å–∞–ª—å–Ω–∞ –£—Ç–∏–ª—ñ—Ç–∞ `redirectToAuth`

### –ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è
–¶–µ–Ω—Ç—Ä–∞–ª—ñ–∑–æ–≤–∞–Ω–∞ —É—Ç–∏–ª—ñ—Ç–∞ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ä–µ–¥–∏—Ä–µ–∫—Ç—É –∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º –±–∞–≥–∞—Ç–æ—Ä—ñ–≤–Ω–µ–≤–æ—ó —Å–∏—Å—Ç–µ–º–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó.

**–§–∞–π–ª:** `frontend/src/utils/auth/redirectToAuth.ts`

### –õ–æ–≥—ñ–∫–∞

```typescript
export async function redirectToAuth(
  currentPath?: string,
  reason: 'session_expired' | 'tokens_not_found' | 'auth_required' = 'session_expired'
): Promise<void> {
  const path = currentPath || window.location.pathname + window.location.search;

  // 1. –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å NextAuth —Å–µ—Å—Å—ñ—ó
  const hasSession = await checkNextAuthSession(); // GET /api/auth/session

  if (hasSession) {
    // ‚úÖ –£—Ä–æ–≤–µ–Ω—å 1 –ø—Ä–æ–π–¥–µ–Ω–æ (NextAuth —Å–µ—Å—Å—ñ—è —î)
    // –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ /login –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è backend —Ç–æ–∫–µ–Ω—ñ–≤ (—É—Ä–æ–≤–µ–Ω—å 2)
    const loginUrl = `/login?callbackUrl=${path}&error=${reason}&message=${message}`;
    window.location.href = loginUrl;
  } else {
    // ‚ùå –£—Ä–æ–≤–µ–Ω—å 1 –Ω–µ –ø—Ä–æ–π–¥–µ–Ω–æ (–Ω–µ–º–∞—î NextAuth —Å–µ—Å—Å—ñ—ó)
    // –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ /api/auth/signin –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Å–µ—Å—Å—ñ—ó
    await fetch('/api/auth/logout', { method: 'POST' }); // –û—á–∏—Å—Ç–∫–∞ –ø–µ—Ä–µ–¥ signin
    const signinUrl = `/api/auth/signin?callbackUrl=${path}`;
    window.location.href = signinUrl;
  }
}
```

### –¢–∏–ø–∏ –ü—Ä–∏—á–∏–Ω (`reason`)

| –ü—Ä–∏—á–∏–Ω–∞ | –û–ø–∏—Å | –†–µ–¥–∏—Ä–µ–∫—Ç (—è–∫—â–æ —î NextAuth) | –†–µ–¥–∏—Ä–µ–∫—Ç (—è–∫—â–æ –Ω–µ–º–∞—î NextAuth) |
|---------|------|----------------------------|-------------------------------|
| `session_expired` | Refresh token –∑–∞—Å—Ç–∞—Ä—ñ–≤ | `/login?error=session_expired` | `/api/auth/signin` |
| `tokens_not_found` | –¢–æ–∫–µ–Ω–∏ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω—ñ –≤ Redis | `/login?error=tokens_not_found` | `/api/auth/signin` |
| `auth_required` | –ü–æ—Ç—Ä—ñ–±–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è | `/login?error=auth_required` | `/api/auth/signin` |

---

## üîÑ API Route `/api/auth/refresh` - –ú–µ—Ö–∞–Ω—ñ–∑–º –û–Ω–æ–≤–ª–µ–Ω–Ω—è –¢–æ–∫–µ–Ω—ñ–≤

### –ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è
–¶–µ–Ω—Ç—Ä–∞–ª—ñ–∑–æ–≤–∞–Ω–∏–π endpoint –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è access token —á–µ—Ä–µ–∑ refresh token.

**–§–∞–π–ª:** `frontend/src/app/api/auth/refresh/route.ts`

### –ü–æ–≤–Ω–∏–π –ê–ª–≥–æ—Ä–∏—Ç–º

```typescript
export async function POST(request: NextRequest) {
  // 1. –í–∏–∑–Ω–∞—á–∞—î–º–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä (backend/dummy)
  const provider = await getProviderFromRedis(); // 'backend' | 'dummy'
  const authKey = provider === 'dummy' ? 'dummy_auth' : 'backend_auth';

  // 2. –û—Ç—Ä–∏–º—É—î–º–æ —Ç–æ–∫–µ–Ω–∏ –∑ Redis
  const redisData = await fetch(`/api/redis?key=${authKey}`);
  if (!redisData.exists || !redisData.value) {
    return NextResponse.json(
      { error: 'No tokens found in Redis' },
      { status: 404 } // ‚ùå –¢–æ–∫–µ–Ω–∏ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω—ñ
    );
  }

  const tokenData = JSON.parse(redisData.value);
  const { refresh: refreshToken, refreshAttempts = 0 } = tokenData;

  // 3. –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Å–ø—Ä–æ–± refresh
  const maxAttempts = 3;
  if (refreshAttempts >= maxAttempts) {
    return NextResponse.json(
      { error: 'Max refresh attempts reached' },
      { status: 429 }
    );
  }

  // 4. –ó–±—ñ–ª—å—à—É—î–º–æ –ª—ñ—á–∏–ª—å–Ω–∏–∫ —Å–ø—Ä–æ–±
  const newAttempts = refreshAttempts + 1;

  // 5. –í–∏–∫–ª–∏–∫–∞—î–º–æ Django /api/auth/refresh
  const backendResponse = await fetch(`${backendUrl}/api/auth/refresh`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ refresh: refreshToken })
  });

  if (!backendResponse.ok) {
    // ‚ùå Django –≤—ñ–¥—Ö–∏–ª–∏–≤ refresh (—Ç–æ–∫–µ–Ω –Ω–µ–≤–∞–ª—ñ–¥–Ω–∏–π)
    return NextResponse.json(
      { error: 'Token refresh failed' },
      { status: backendResponse.status } // 401 –∞–±–æ —ñ–Ω—à–µ
    );
  }

  // 6. –û—Ç—Ä–∏–º—É—î–º–æ –Ω–æ–≤—ñ —Ç–æ–∫–µ–Ω–∏ –≤—ñ–¥ Django
  const { access, refresh: newRefresh } = await backendResponse.json();

  // 7. –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –Ω–æ–≤—ñ —Ç–æ–∫–µ–Ω–∏ –≤ Redis (–∑ —Å–∫–∏–Ω—É—Ç–∏–º –ª—ñ—á–∏–ª—å–Ω–∏–∫–æ–º)
  await fetch('/api/redis', {
    method: 'POST',
    body: JSON.stringify({
      key: authKey,
      value: JSON.stringify({
        access,
        refresh: newRefresh || refreshToken, // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –Ω–æ–≤–∏–π –∞–±–æ —Å—Ç–∞—Ä–∏–π
        refreshAttempts: 0, // –°–∫–∏–¥–∞—î–º–æ –ª—ñ—á–∏–ª—å–Ω–∏–∫ –ø—Ä–∏ —É—Å–ø—ñ—Ö—É
        lastRefreshTime: Date.now()
      })
    })
  });

  // 8. –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –Ω–æ–≤—ñ —Ç–æ–∫–µ–Ω–∏
  return NextResponse.json({
    success: true,
    access,
    refresh: newRefresh || refreshToken,
    provider
  });
}
```

### –ó–∞—Ö–∏—Å—Ç –≤—ñ–¥ –ó–∞—Ü–∏–∫–ª–µ–Ω–Ω—è

- ‚úÖ –õ—ñ—á–∏–ª—å–Ω–∏–∫ —Å–ø—Ä–æ–± (`refreshAttempts`) - –º–∞–∫—Å–∏–º—É–º 3 —Å–ø—Ä–æ–±–∏
- ‚úÖ –Ø–∫—â–æ –¥–æ—Å—è–≥–Ω—É—Ç–æ –º–∞–∫—Å–∏–º—É–º - –ø–æ–≤–µ—Ä—Ç–∞—î—Ç—å—Å—è 429 (Too Many Requests)
- ‚úÖ –õ—ñ—á–∏–ª—å–Ω–∏–∫ —Å–∫–∏–¥–∞—î—Ç—å—Å—è –ø—Ä–∏ —É—Å–ø—ñ—à–Ω–æ–º—É refresh

### –°—Ç–∞—Ç—É—Å–∏ –í—ñ–¥–ø–æ–≤—ñ–¥—ñ

| –°—Ç–∞—Ç—É—Å | –ü—Ä–∏—á–∏–Ω–∞ | –î—ñ—è –∫–ª—ñ—î–Ω—Ç–∞ |
|--------|---------|-------------|
| `200 OK` | Refresh —É—Å–ø—ñ—à–Ω–∏–π | –í–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ –Ω–æ–≤–∏–π `access` —Ç–æ–∫–µ–Ω |
| `401` | Refresh token –Ω–µ–≤–∞–ª—ñ–¥–Ω–∏–π | –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ `/login` |
| `404` | –¢–æ–∫–µ–Ω–∏ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω—ñ –≤ Redis | –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ `/login` (—á–µ—Ä–µ–∑ `redirectToAuth`) |
| `429` | –ú–∞–∫—Å–∏–º—É–º —Å–ø—Ä–æ–± –¥–æ—Å—è–≥–Ω—É—Ç–æ | –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ `/login` |

---

## üèóÔ∏è Backend (Django) - –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¢–æ–∫–µ–Ω—ñ–≤

### –ú–µ—Ö–∞–Ω—ñ–∑–º –ü–µ—Ä–µ–≤—ñ—Ä–∫–∏

Django –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î **djangorestframework-simplejwt** –¥–ª—è –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó JWT —Ç–æ–∫–µ–Ω—ñ–≤:

```python
# backend/core/services/jwt.py
class JwtService:
    @staticmethod
    def validate_any_token(token):
        """Validate a JWT token using DRF SimpleJWT."""
        authenticator = JWTAuthentication()
        validated_token = authenticator.get_validated_token(token)  # Decode and verify
        user = authenticator.get_user(validated_token)  # Get user
        return user
```

### –û–±—Ä–æ–±–∫–∞ –ü–æ–º–∏–ª–æ–∫

```python
# backend/core/enums/exceptions.py
JWT_ERROR = {
    "exceptions": [JwtException, AuthenticationFailed, NotAuthenticated],
    "code": "jwt_error",
    "message": "Authentication failed or invalid JWT token.",
    "status": status.HTTP_401_UNAUTHORIZED,
}
```

### –ö–æ–ª–∏ Django –ü–æ–≤–µ—Ä—Ç–∞—î 401

1. **Access token –≤—ñ–¥—Å—É—Ç–Ω—ñ–π** –∞–±–æ –º–∞—î –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç
2. **Access token –∑–∞—Å—Ç–∞—Ä—ñ–≤** (–ø–µ—Ä–µ–≤–∏—â–∏–≤ `ACCESS_TOKEN_LIFETIME`)
3. **Access token –Ω–µ–≤–∞–ª—ñ–¥–Ω–∏–π** (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞ –ø—ñ–¥–ø–∏—Å, –∑–º—ñ–Ω–µ–Ω–∏–π payload)
4. **Refresh token –Ω–µ–≤–∞–ª—ñ–¥–Ω–∏–π** (–ø—Ä–∏ —Å–ø—Ä–æ–±—ñ refresh)

### –ü—Ä–æ—Ü–µ—Å –í–∞–ª—ñ–¥–∞—Ü—ñ—ó

```
Django –æ—Ç—Ä–∏–º—É—î –∑–∞–ø–∏—Ç –∑ Authorization: Bearer <token>
    ‚Üì
JWTAuthentication.get_validated_token(token)
    ‚Üì
1. –î–µ–∫–æ–¥—É—î JWT —Ç–æ–∫–µ–Ω
2. –ü–µ—Ä–µ–≤—ñ—Ä—è—î –ø—ñ–¥–ø–∏—Å (signature)
3. –ü–µ—Ä–µ–≤—ñ—Ä—è—î exp (expiration time)
4. –ü–µ—Ä–µ–≤—ñ—Ä—è—î iat (issued at)
5. –ü–µ—Ä–µ–≤—ñ—Ä—è—î —á–æ—Ä–Ω–∏–π —Å–ø–∏—Å–æ–∫ —Ç–æ–∫–µ–Ω—ñ–≤
    ‚Üì
–Ø–∫—â–æ –≤–∞–ª—ñ–¥–∞—Ü—ñ—è –Ω–µ –ø—Ä–æ–π–¥–µ–Ω–∞:
    ‚Üì
–ü–æ–≤–µ—Ä—Ç–∞—î 401 Unauthorized –∑ –¥–µ—Ç–∞–ª—è–º–∏ –ø–æ–º–∏–ª–∫–∏
```

---

## üîÑ –ü–æ–≤–Ω–∏–π Flow –û–±—Ä–æ–±–∫–∏ 401

### –ü—Ä–∏–∫–ª–∞–¥: –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á —Ä–æ–±–∏—Ç—å –∑–∞–ø–∏—Ç –¥–æ `/api/autoria/cars`

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 1. –ö–õ–Ü–Ñ–ù–¢ (React Component)                                  ‚îÇ
‚îÇ    fetchWithAuth('/api/autoria/cars')                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 2. API ROUTE (Next.js Server)                                ‚îÇ
‚îÇ    frontend/src/app/api/(backend)/autoria/cars/route.ts     ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ    const authHeaders = await getAuthorizationHeaders();      ‚îÇ
‚îÇ    // –û—Ç—Ä–∏–º—É—î —Ç–æ–∫–µ–Ω –∑ Redis —á–µ—Ä–µ–∑ /api/redis                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 3. BACKEND (Django)                                          ‚îÇ
‚îÇ    GET /api/ads/cars/                                        ‚îÇ
‚îÇ    Authorization: Bearer <access_token>                       ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ    JWTAuthentication.validate_token()                        ‚îÇ
‚îÇ    ‚ùå Token expired ‚Üí 401 Unauthorized                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 4. API ROUTE (Next.js Server)                                ‚îÇ
‚îÇ    –ü–æ–≤–µ—Ä—Ç–∞—î 401 –∫–ª—ñ—î–Ω—Ç—É                                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 5. –ö–õ–Ü–Ñ–ù–¢ (fetchWithAuth)                                    ‚îÇ
‚îÇ    –û—Ç—Ä–∏–º–∞–≤ 401 ‚Üí —Å–ø—Ä–æ–±–∞ refresh                             ‚îÇ
‚îÇ    POST /api/auth/refresh                                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 6. API ROUTE /api/auth/refresh                               ‚îÇ
‚îÇ    a. –û—Ç—Ä–∏–º—É—î refresh_token –∑ Redis                        ‚îÇ
‚îÇ    b. –í–∏–∫–ª–∏–∫–∞—î Django POST /api/auth/refresh                ‚îÇ
‚îÇ    c. Django –≤–∞–ª—ñ–¥—É—î refresh_token —ñ –ø–æ–≤–µ—Ä—Ç–∞—î –Ω–æ–≤–∏–π access  ‚îÇ
‚îÇ    d. –ó–±–µ—Ä—ñ–≥–∞—î –Ω–æ–≤–∏–π access –≤ Redis                         ‚îÇ
‚îÇ    e. –ü–æ–≤–µ—Ä—Ç–∞—î –Ω–æ–≤–∏–π access –∫–ª—ñ—î–Ω—Ç—É                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 7. –ö–õ–Ü–Ñ–ù–¢ (fetchWithAuth)                                    ‚îÇ
‚îÇ    ‚úÖ Refresh —É—Å–ø—ñ—à–Ω–∏–π ‚Üí –ø–æ–≤—Ç–æ—Ä—é—î –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∏–π –∑–∞–ø–∏—Ç        ‚îÇ
‚îÇ    fetchWithAuth('/api/autoria/cars') [RETRY]               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 8. API ROUTE (Next.js Server)                                ‚îÇ
‚îÇ    –û—Ç—Ä–∏–º—É—î –ù–û–í–ò–ô —Ç–æ–∫–µ–Ω –∑ Redis (–æ–Ω–æ–≤–ª–µ–Ω–∏–π –ø—ñ—Å–ª—è refresh)   ‚îÇ
‚îÇ    const authHeaders = await getAuthorizationHeaders();     ‚îÇ
‚îÇ    Authorization: Bearer <NEW_access_token>                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 9. BACKEND (Django)                                          ‚îÇ
‚îÇ    JWTAuthentication.validate_token()                        ‚îÇ
‚îÇ    ‚úÖ Token valid ‚Üí 200 OK –∑ –¥–∞–Ω–∏–º–∏                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 10. –ö–õ–Ü–Ñ–ù–¢ (React Component)                                ‚îÇ
‚îÇ     –û—Ç—Ä–∏–º—É—î –¥–∞–Ω—ñ ‚Üí –≤—ñ–¥–æ–±—Ä–∞–∂–∞—î –≤ UI                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∏–π –°—Ü–µ–Ω–∞—Ä—ñ–π: Refresh –Ω–µ –í–¥–∞–≤—Å—è

```
... (–∫—Ä–æ–∫–∏ 1-5 —Ç–∞–∫—ñ –∂) ...
                    ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 6. API ROUTE /api/auth/refresh                               ‚îÇ
‚îÇ    Django –ø–æ–≤–µ—Ä—Ç–∞—î 401 (refresh_token —Ç–∞–∫–æ–∂ –∑–∞—Å—Ç–∞—Ä—ñ–≤)      ‚îÇ
‚îÇ    /api/auth/refresh –ø–æ–≤–µ—Ä—Ç–∞—î 401 –∫–ª—ñ—î–Ω—Ç—É                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 7. –ö–õ–Ü–Ñ–ù–¢ (fetchWithAuth)                                    ‚îÇ
‚îÇ    ‚ùå Refresh –Ω–µ –≤–¥–∞–≤—Å—è                                       ‚îÇ
‚îÇ    redirectToAuth(currentPath, 'session_expired')          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 8. redirectToAuth()                                           ‚îÇ
‚îÇ    a. –ü–µ—Ä–µ–≤—ñ—Ä—è—î NextAuth —Å–µ—Å—Å—ñ—é —á–µ—Ä–µ–∑ /api/auth/session    ‚îÇ
‚îÇ    b. –Ø–∫—â–æ —Å–µ—Å—Å—ñ—è —î ‚Üí —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ /login                   ‚îÇ
‚îÇ    c. –Ø–∫—â–æ —Å–µ—Å—Å—ñ—ó –Ω–µ–º–∞—î ‚Üí —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ /api/auth/signin     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üéØ –û—Å–æ–±–ª–∏–≤–æ—Å—Ç—ñ –†–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó

### 1. –¢–æ–∫–µ–Ω–∏ –ó–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –¢—ñ–ª—å–∫–∏ –≤ Redis

**‚ùå –ù–ï –≤ localStorage:**
- –¢–æ–∫–µ–Ω–∏ –Ω–µ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –≤ `localStorage` –Ω–∞ –∫–ª—ñ—î–Ω—Ç—ñ
- –¶–µ –ø—ñ–¥–≤–∏—â—É—î –±–µ–∑–ø–µ–∫—É (XSS –∞—Ç–∞–∫–∏ –Ω–µ –∑–º–æ–∂—É—Ç—å –≤–∫—Ä–∞—Å—Ç–∏ —Ç–æ–∫–µ–Ω–∏)

**‚úÖ –¢—ñ–ª—å–∫–∏ –≤ Redis:**
- –¢–æ–∫–µ–Ω–∏ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è —Ç—ñ–ª—å–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ (Redis)
- –î–æ—Å—Ç—É–ø —á–µ—Ä–µ–∑ API routes (`/api/redis`, `/api/auth/token`)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –æ—á–∏—â–µ–Ω–Ω—è –ø—Ä–∏ signout

### 2. –ü–æ–¥–≤—ñ–π–Ω–∞ –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¢–æ–∫–µ–Ω—ñ–≤

**–ù–∞ –°–µ—Ä–≤–µ—Ä—ñ (API Routes):**
```typescript
// –ü—Ä–æ–∞–∫—Ç–∏–≤–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ exp claim
if (this.isTokenExpired(tokens.access)) {
  // Refresh –ü–ï–†–ï–î –∑–∞–ø–∏—Ç–æ–º
  const newToken = await this.refreshToken(...);
}
```

**–ù–∞ –ö–ª—ñ—î–Ω—Ç—ñ (Runtime):**
```typescript
// –†–µ–∞–∫—Ç–∏–≤–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—Ä–∏ 401
if (response.status === 401) {
  // Refresh –ü–Ü–°–õ–Ø –æ—Ç—Ä–∏–º–∞–Ω–Ω—è 401
  const refresh = await fetch('/api/auth/refresh', ...);
}
```

### 3. –ó–∞—Ö–∏—Å—Ç –≤—ñ–¥ Race Conditions

**–õ—ñ—á–∏–ª—å–Ω–∏–∫ –°–ø—Ä—Ä–æ–±:**
- –ú–∞–∫—Å–∏–º—É–º 3 —Å–ø—Ä–æ–±–∏ refresh –Ω–∞ —Ç–æ–∫–µ–Ω–∏ –≤ Redis
- –ó–∞–ø–æ–±—ñ–≥–∞—î –∑–∞—Ü–∏–∫–ª–µ–Ω–Ω—é –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö –∑ —Ç–æ–∫–µ–Ω–∞–º–∏

**–§–ª–∞–≥ `skipRetry`:**
- `fetchWithAuth` —Ç–∞ `ApiClient` –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å `skipRetry` –¥–ª—è –∑–∞–ø–æ–±—ñ–≥–∞–Ω–Ω—è –Ω–µ—Å–∫—ñ–Ω—á–µ–Ω–Ω–∏–º —Ü–∏–∫–ª–∞–º
- –ü—ñ—Å–ª—è –ø–µ—Ä—à–æ—ó —Å–ø—Ä–æ–±–∏ refresh –≤—Å—Ç–∞–Ω–æ–≤–ª—é—î—Ç—å—Å—è `skipRetry = true`

### 4. –¶–µ–Ω—Ç—Ä–∞–ª—ñ–∑–æ–≤–∞–Ω–∞ –û–±—Ä–æ–±–∫–∞ –ü–æ–º–∏–ª–æ–∫

**–£–Ω—ñ–≤–µ—Ä—Å–∞–ª—å–Ω–∞ –£—Ç–∏–ª—ñ—Ç–∞:**
- `redirectToAuth()` - —Ü–µ–Ω—Ç—Ä–∞–ª—ñ–∑–æ–≤–∞–Ω–∞ –ª–æ–≥—ñ–∫–∞ —Ä–µ–¥–∏—Ä–µ–∫—Ç—ñ–≤
- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –≤ —É—Å—ñ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö —Å–∏—Å—Ç–µ–º–∏
- –ü—Ä–∞–≤–∏–ª—å–Ω–æ –≤–∏–∑–Ω–∞—á–∞—î –∫—É–¥–∏ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç–∏ –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ —Å—Ç–∞–Ω—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó

### 5. –†—ñ–∑–Ω—ñ –®–ª—è—Ö–∏ –¥–ª—è –†—ñ–∑–Ω–∏—Ö –†—ñ–≤–Ω—ñ–≤

**Public API:**
- –ù–µ –ø–æ—Ç—Ä–µ–±—É—é—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó
- –î–æ—Å—Ç—É–ø–Ω—ñ –±–µ–∑ —Ç–æ–∫–µ–Ω—ñ–≤

**Internal API:**
- –ü–æ—Ç—Ä–µ–±—É—é—Ç—å —Ç—ñ–ª—å–∫–∏ NextAuth —Å–µ—Å—Å—ñ—é
- –î–æ—Å—Ç—É–ø–Ω—ñ –¥–ª—è `/login`, `/profile`

**Backend API (AutoRia):**
- –ü–æ—Ç—Ä–µ–±—É—é—Ç—å NextAuth —Å–µ—Å—Å—ñ—é + backend —Ç–æ–∫–µ–Ω–∏
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∏–π –∑–∞—Ö–∏—Å—Ç

---

## üìä –î—ñ–∞–≥—Ä–∞–º–∞ –ü–æ–≤–Ω–æ–≥–æ Flow

```
–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–∞–º–∞–≥–∞—î—Ç—å—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ /autoria/search
                    ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –£–†–û–í–ï–ù–¨ 1: Middleware                                    ‚îÇ
‚îÇ –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ NextAuth —Å–µ—Å—Å—ñ—ó                                ‚îÇ
‚îÇ                                                          ‚îÇ
‚îÇ ‚úÖ –°–µ—Å—Å—ñ—è —î ‚Üí –ü—Ä–æ–¥–æ–≤–∂—É—î–º–æ                               ‚îÇ
‚îÇ ‚ùå –°–µ—Å—Å—ñ—ó –Ω–µ–º–∞—î ‚Üí –†–µ–¥–∏—Ä–µ–∫—Ç ‚Üí /api/auth/signin           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚Üì (—Å–µ—Å—Å—ñ—è —î)
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –£–†–û–í–ï–ù–¨ 2: BackendTokenPresenceGate                      ‚îÇ
‚îÇ –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ backend —Ç–æ–∫–µ–Ω—ñ–≤ –≤ Redis                        ‚îÇ
‚îÇ                                                          ‚îÇ
‚îÇ GET /api/auth/me ‚Üí –ø–µ—Ä–µ–≤—ñ—Ä—è—î Redis                       ‚îÇ
‚îÇ                                                          ‚îÇ
‚îÇ ‚úÖ –¢–æ–∫–µ–Ω–∏ —î ‚Üí –ü–æ–∫–∞–∑—É—î–º–æ —Å—Ç–æ—Ä—ñ–Ω–∫—É                        ‚îÇ
‚îÇ ‚ùå –¢–æ–∫–µ–Ω–∏ –≤—ñ–¥—Å—É—Ç–Ω—ñ:                                      ‚îÇ
‚îÇ    - –°–ø—Ä–æ–±–∞ refresh (—è–∫—â–æ 401)                          ‚îÇ
‚îÇ    - redirectToAuth() ‚Üí /login                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚Üì (—Ç–æ–∫–µ–Ω–∏ —î)
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –£–†–û–í–ï–ù–¨ 3: Runtime API –ó–∞–ø–∏—Ç–∏                            ‚îÇ
‚îÇ                                                          ‚îÇ
‚îÇ –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á —Ä–æ–±–∏—Ç—å –∑–∞–ø–∏—Ç (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –æ–≥–æ–ª.)‚îÇ
‚îÇ                                                          ‚îÇ
‚îÇ API Route: getAuthorizationHeaders()                     ‚îÇ
‚îÇ   ‚Üí –û—Ç—Ä–∏–º—É—î —Ç–æ–∫–µ–Ω –∑ Redis                                ‚îÇ
‚îÇ   ‚Üí –Ø–∫—â–æ –Ω–µ–º–∞—î ‚Üí —Å–ø—Ä–æ–±–∞ refresh                         ‚îÇ
‚îÇ                                                          ‚îÇ
‚îÇ –ó–∞–ø–∏—Ç –¥–æ Django –∑ Authorization: Bearer <token>        ‚îÇ
‚îÇ                                                          ‚îÇ
‚îÇ Django –ø–æ–≤–µ—Ä—Ç–∞—î:                                         ‚îÇ
‚îÇ   ‚úÖ 200 OK ‚Üí –î–∞–Ω—ñ –ø–æ–≤–µ—Ä—Ç–∞—é—Ç—å—Å—è                         ‚îÇ
‚îÇ   ‚ùå 401 Unauthorized ‚Üí –û–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–∫–∏:                ‚îÇ
‚îÇ      1. fetchWithAuth –æ—Ç—Ä–∏–º—É—î 401                       ‚îÇ
‚îÇ      2. –í–∏–∫–ª–∏–∫–∞—î POST /api/auth/refresh                 ‚îÇ
‚îÇ      3. –Ø–∫—â–æ refresh —É—Å–ø—ñ—à–Ω–∏–π ‚Üí –ø–æ–≤—Ç–æ—Ä—é—î –∑–∞–ø–∏—Ç          ‚îÇ
‚îÇ      4. –Ø–∫—â–æ refresh –Ω–µ –≤–¥–∞–≤—Å—è ‚Üí redirectToAuth()        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üîß –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Ç–∞ –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è

### –õ—ñ–º—ñ—Ç–∏ Refresh

```typescript
// frontend/src/app/api/auth/refresh/route.ts
const maxAttempts = 3; // –ú–∞–∫—Å–∏–º—É–º —Å–ø—Ä–æ–± refresh
```

### Lifetime –¢–æ–∫–µ–Ω—ñ–≤

```python
# backend/config/extra_config/simple_jwt_config.py
ACCESS_TOKEN_LIFETIME = timedelta(minutes=15)  # Access token: 15 —Ö–≤
REFRESH_TOKEN_LIFETIME = timedelta(days=7)    # Refresh token: 7 –¥–Ω—ñ–≤
```

### Timeout –¥–ª—è Redis –ó–∞–ø–∏—Ç—ñ–≤

```typescript
// frontend/src/common/constants/headers.ts
const timeoutId = setTimeout(() => controller.abort(), 5000); // 5 —Å–µ–∫—É–Ω–¥
```

---

## ‚úÖ –ü–µ—Ä–µ–≤–∞–≥–∏ –¶—ñ—î—ó –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∏

### –ë–µ–∑–ø–µ–∫–∞
- ‚úÖ **Defense in Depth** - –∫—ñ–ª—å–∫–∞ —Ä—ñ–≤–Ω—ñ–≤ –∑–∞—Ö–∏—Å—Ç—É
- ‚úÖ –¢–æ–∫–µ–Ω–∏ —Ç—ñ–ª—å–∫–∏ –≤ Redis (–Ω–µ –¥–æ—Å—Ç—É–ø–Ω—ñ —á–µ—Ä–µ–∑ XSS)
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Ç–æ–∫–µ–Ω—ñ–≤
- ‚úÖ –ó–∞—Ö–∏—Å—Ç –≤—ñ–¥ race conditions

### UX
- ‚úÖ Seamless refresh (–∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–µ –ø–æ–º—ñ—á–∞—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Ç–æ–∫–µ–Ω—ñ–≤)
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω—ñ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏ –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
- ‚úÖ –ü–æ–Ω—è—Ç–ª–∏–≤—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –ø–æ–º–∏–ª–∫–∏

### –†–æ–∑—Ä–æ–±–∫–∞
- ‚úÖ –¶–µ–Ω—Ç—Ä–∞–ª—ñ–∑–æ–≤–∞–Ω–∞ –ª–æ–≥—ñ–∫–∞ (–ª–µ–≥–∫–æ –ø—ñ–¥—Ç—Ä–∏–º—É–≤–∞—Ç–∏)
- ‚úÖ –ú–æ–¥—É–ª—å–Ω—ñ—Å—Ç—å (–∫–æ–∂–µ–Ω —Ä—ñ–≤–µ–Ω—å –Ω–µ–∑–∞–ª–µ–∂–Ω–∏–π)
- ‚úÖ –õ–µ–≥–∫–æ —Ç–µ—Å—Ç—É–≤–∞—Ç–∏ –∫–æ–∂–µ–Ω —Ä—ñ–≤–µ–Ω—å –æ–∫—Ä–µ–º–æ
- ‚úÖ –î–µ—Ç–∞–ª—å–Ω–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è –¥–ª—è debugging

---

## üêõ Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: –ù–µ—Å–∫—ñ–Ω—á–µ–Ω–Ω—ñ Refresh –°–ø—Ä–æ–±–∏

**–ü—Ä–∏—á–∏–Ω–∞:** Race condition –º—ñ–∂ –∫—ñ–ª—å–∫–æ–º–∞ –∑–∞–ø–∏—Ç–∞–º–∏

**–†—ñ—à–µ–Ω–Ω—è:**
- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ `skipRetry` —Ñ–ª–∞–≥ –ø—ñ—Å–ª—è –ø–µ—Ä—à–æ—ó —Å–ø—Ä–æ–±–∏
- –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ª—ñ—á–∏–ª—å–Ω–∏–∫ `refreshAttempts` –≤ Redis

### –ü—Ä–æ–±–ª–µ–º–∞: 401 –Ω–∞–≤—ñ—Ç—å –ø—ñ—Å–ª—è refresh

**–ü—Ä–∏—á–∏–Ω–∞:** –ù–æ–≤—ñ —Ç–æ–∫–µ–Ω–∏ –Ω–µ –∑–±–µ—Ä–µ–∂–µ–Ω—ñ –≤ Redis

**–†—ñ—à–µ–Ω–Ω—è:**
- –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —á–∏ `/api/auth/refresh` —É—Å–ø—ñ—à–Ω–æ –∑–±–µ—Ä—ñ–≥–∞—î —Ç–æ–∫–µ–Ω–∏
- –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ª–æ–≥—ñ–∫—É –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –≤ `/api/auth/refresh/route.ts`

### –ü—Ä–æ–±–ª–µ–º–∞: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π —Ä–µ–¥–∏—Ä–µ–∫—Ç

**–ü—Ä–∏—á–∏–Ω–∞:** `redirectToAuth` –Ω–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –≤–∏–∑–Ω–∞—á–∞—î —Å—Ç–∞–Ω

**–†—ñ—à–µ–Ω–Ω—è:**
- –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —á–∏ `/api/auth/session` –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø–æ–≤–µ—Ä—Ç–∞—î —Å—Ç–∞–Ω
- –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ª–æ–≥—ñ–∫—É –≤ `redirectToAuth.ts`

---

## üìù –í–∏—Å–Ω–æ–≤–æ–∫

–°–∏—Å—Ç–µ–º–∞ –∫–æ–Ω—Ç—Ä–æ–ª—é –¥–æ—Å—Ç—É–ø—É —Ç–∞ –æ–±—Ä–æ–±–∫–∏ 401 —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–∞ —è–∫ **—Ç—Ä–∏—Ä—ñ–≤–Ω–µ–≤–∏–π –∑–∞—Ö–∏—Å—Ç** –∑ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–º –æ–Ω–æ–≤–ª–µ–Ω–Ω—è–º —Ç–æ–∫–µ–Ω—ñ–≤:

1. **–†—ñ–≤–µ–Ω—å 1 (Middleware)** - –ø–µ—Ä–µ–≤—ñ—Ä—è—î NextAuth —Å–µ—Å—Å—ñ—é –Ω–∞ —Ä—ñ–≤–Ω—ñ —Ä–æ—É—Ç–∏–Ω–≥—É
2. **–†—ñ–≤–µ–Ω—å 2 (HOC)** - –ø–µ—Ä–µ–≤—ñ—Ä—è—î backend —Ç–æ–∫–µ–Ω–∏ –ø—ñ—Å–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥—É
3. **–†—ñ–≤–µ–Ω—å 3 (Runtime)** - –æ–±—Ä–æ–±–ª—è—î 401 –ø–æ–º–∏–ª–∫–∏ –ø—ñ–¥ —á–∞—Å API –∑–∞–ø–∏—Ç—ñ–≤

–í—Å—ñ —Ä—ñ–≤–Ω—ñ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å —Ü–µ–Ω—Ç—Ä–∞–ª—ñ–∑–æ–≤–∞–Ω—ñ —É—Ç–∏–ª—ñ—Ç–∏ (`redirectToAuth`, `getAuthorizationHeaders`) –¥–ª—è —É–∑–≥–æ–¥–∂–µ–Ω–æ—ó –æ–±—Ä–æ–±–∫–∏ –ø–æ–º–∏–ª–æ–∫ —Ç–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–∏—Ö —Ä–µ–¥–∏—Ä–µ–∫—Ç—ñ–≤.

