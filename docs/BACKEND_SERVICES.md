# üîß AutoRia Backend Services - –ü–æ–≤–Ω–µ –∫–µ—Ä—ñ–≤–Ω–∏—Ü—Ç–≤–æ

## üìã –û–≥–ª—è–¥

–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è —Ñ–æ–Ω–æ–≤–∏—Ö —Å–µ—Ä–≤—ñ—Å—ñ–≤, –º–æ–¥–µ—Ä–∞—Ü—ñ—ó, Celery –∑–∞–¥–∞—á —Ç–∞ —Å–∏—Å—Ç–µ–º–∏ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó —Ç–µ—Å—Ç–æ–≤–∏—Ö –¥–∞–Ω–∏—Ö.

---

## üõ°Ô∏è –°–∏—Å—Ç–µ–º–∞ –ú–æ–¥–µ—Ä–∞—Ü—ñ—ó –ö–æ–Ω—Ç–µ–Ω—Ç—É

### –ö–ª—é—á–æ–≤—ñ –æ—Å–æ–±–ª–∏–≤–æ—Å—Ç—ñ

**–®–≤–∏–¥–∫—ñ—Å—Ç—å**:
- Hard-block –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞: **58ms**
- Topic analysis: ~15s
- –ó–∞–≥–∞–ª—å–Ω–µ –ø—Ä–∏—Å–∫–æ—Ä–µ–Ω–Ω—è: **1000x** (–±—É–ª–æ 60,000ms)

**–¢–æ—á–Ω—ñ—Å—Ç—å**:
- –ü—Ä–æ—Ñ–∞–Ω–Ω—ñ—Å—Ç—å: **100%**
- Hard-block —Å–ª–æ–≤–Ω–∏–∫: **161 —Å–ª–æ–≤–æ**
- –ü—ñ–¥—Ç—Ä–∏–º–∫–∞ –º–æ–≤: üá∫üá¶ –£–∫—Ä–∞—ó–Ω—Å—å–∫–∞, üá∑üá∫ –†–æ—Å—ñ–π—Å—å–∫–∞, üá¨üáß –ê–Ω–≥–ª—ñ–π—Å—å–∫–∞, üî§ –¢—Ä–∞–Ω—Å–ª—ñ—Ç–µ—Ä–∞—Ü—ñ—è

### –ë–∞–≥–∞—Ç–æ–º–æ–≤–Ω–∞ –ø—ñ–¥—Ç—Ä–∏–º–∫–∞

#### 1. –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–µ –∑—ñ—Å—Ç–∞–≤–ª–µ–Ω–Ω—è –ø–∞—Ç—Ç–µ—Ä–Ω—ñ–≤
- Regex-based –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–µ—Ü–µ–Ω–∑—É—Ä–Ω–æ—ó –ª–µ–∫—Å–∏–∫–∏
- –ù–µ—á—É—Ç–ª–∏–≤–∞ –¥–æ —Ä–µ–≥—ñ—Å—Ç—Ä—É
- –ú–æ–≤–Ω–æ-—Å–ø–µ—Ü–∏—Ñ—ñ—á–Ω—ñ –ø–∞—Ç—Ç–µ—Ä–Ω–∏

#### 2. –í–∏—è–≤–ª–µ–Ω–Ω—è —Ç—Ä–∞–Ω—Å–ª—ñ—Ç–µ—Ä–∞—Ü—ñ—ó
```
"blyad" ‚Üí "–±–ª—è–¥—å"
"suka" ‚Üí "—Å—É–∫–∞"
"nahuy" ‚Üí "–Ω–∞—Ö—É–π"
"pizda" ‚Üí "–ø—ñ–∑–¥–∞"
```

#### 3. –í–∏—è–≤–ª–µ–Ω–Ω—è –º–∞—Å–∫—É–≤–∞–Ω–Ω—è
```
–ó–∞–º—ñ–Ω–∞ —Å–∏–º–≤–æ–ª—ñ–≤:
"–±*–ª*—è*–¥*—å" ‚Üí –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ
"—Å@–∫@" ‚Üí –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ
"–ø1–∑–¥@" ‚Üí –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ

–í—Å—Ç–∞–≤–∫–∞ –ø—Ä–æ–±—ñ–ª—ñ–≤:
"–± –ª —è –¥ —å" ‚Üí –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ
"—Å —É –∫ –∞" ‚Üí –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ

–ó–º—ñ—à–∞–Ω—ñ –º–µ—Ç–æ–¥–∏:
"–±.–ª.—è.–¥.—å" ‚Üí –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ
"—Å-—É-–∫-–∞" ‚Üí –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ
```

#### 4. –í–∏—è–≤–ª–µ–Ω–Ω—è —Å—É—Ä–∂–∏–∫—É
```
"–±–ª—è–¥–∏–Ω–∞" ‚Üí –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ
"—Å—É—á–∞—Ä–∞" ‚Üí –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ
"—Ö—É–π–Ω—è" ‚Üí –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ
"–ø—ñ–∑–¥–µ—Ü—å" ‚Üí –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ
```

#### 5. –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–∏–π –∞–Ω–∞–ª—ñ–∑ (LLM)
```
–°–µ–∫—Å—É–∞–ª—å–Ω–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç:
- "—ñ–Ω—Ç–∏–º", "–µ—Å–∫–æ—Ä—Ç", "–º–∞—Å–∞–∂ —Ä–µ–ª–∞–∫—Å"

–ù–∞—Ä–∫–æ—Ç–∏—á–Ω–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç:
- "—Å—ñ–ª—å", "—Ç—Ä–∞–≤–∞ –∑–µ–ª–µ–Ω–∞", "–∑–∞–∫–ª–∞–¥–∫–∞"

–®–∞—Ö—Ä–∞–π—Å—å–∫–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç:
- "—à–≤–∏–¥–∫—ñ –≥—Ä–æ—à—ñ", "–±–µ–∑ –≤–∫–ª–∞–¥–µ–Ω—å"
```

### –¢–µ—Ö–Ω—ñ—á–Ω–∞ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—è

```python
# backend/core/services/llm_moderation.py

class LLMModerationService:
    """–°–µ—Ä–≤—ñ—Å –º–æ–¥–µ—Ä–∞—Ü—ñ—ó –∑ Hard-block + LLM"""
    
    def __init__(self):
        self.hard_block_dict = HARD_BLOCK_PROFANITY  # 161 —Å–ª–æ–≤–æ
        self.chatai = ChatAIService()  # g4f + PollinationsAI
    
    def moderate_content(self, title, description):
        # 1. Fast-path: Hard-block –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ (58ms)
        profanity_result = self._hard_block_check(title, description)
        if profanity_result['found']:
            return {
                'approved': False,
                'profanity_detected': True,
                'processing_time': 0.058  # ~58ms
            }
        
        # 2. LLM Topic Analysis (~15s, —è–∫—â–æ –Ω–µ–º–∞—î –ø—Ä–æ—Ñ–∞–Ω–Ω–æ—Å—Ç—ñ)
        topic_result = self.llm_topic_analysis(title, description)
        
        return {
            'approved': topic_result['is_appropriate'],
            'profanity_detected': False,
            'processing_time': topic_result['processing_time']
        }
```

### –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è

```python
# –í –º–æ–¥–µ–ª—ñ –∞–±–æ view
from core.services.llm_moderation import moderate_content

result = moderate_content(
    title="–ü—Ä–æ–¥–∞–º Toyota Camry 2020",
    description="–ê–≤—Ç–æ–º–æ–±—ñ–ª—å –≤ —ñ–¥–µ–∞–ª—å–Ω–æ–º—É —Å—Ç–∞–Ω—ñ..."
)

if not result['approved']:
    # –í—ñ–¥—Ö–∏–ª–∏—Ç–∏ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è
    ad.status = 'rejected'
    ad.moderation_reason = result.get('reason')
```

### –ï–Ω–¥–ø–æ—ñ–Ω—Ç —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è

```http
POST /api/ads/cars/test-moderation/
{
    "title": "–¢–µ—Å—Ç–æ–≤–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫",
    "description": "–¢–µ—Å—Ç–æ–≤–∏–π –æ–ø–∏—Å"
}

# –í—ñ–¥–ø–æ–≤—ñ–¥—å:
{
    "approved": true,
    "profanity_detected": false,
    "profanity_details": {
        "found": false,
        "confidence": 100
    },
    "topic_analysis": {
        "is_appropriate": true,
        "reason": "Automotive content"
    },
    "processing_time": 0.058
}
```

---

## ‚è∞ Celery –ü–µ—Ä—ñ–æ–¥–∏—á–Ω—ñ –ó–∞–¥–∞—á—ñ

### –ù–∞–ª–∞—à—Ç–æ–≤–∞–Ω—ñ –∑–∞–¥–∞—á—ñ

#### 1. –û—á–∏—Å—Ç–∫–∞ —Ç–∏–º—á–∞—Å–æ–≤–∏—Ö –º–µ–¥—ñ–∞-—Ñ–∞–π–ª—ñ–≤

```python
# backend/core/tasks/periodic_tasks.py

@shared_task
def clean_generated_media():
    """–í–∏–¥–∞–ª—è—î —Ñ–∞–π–ª–∏ —Å—Ç–∞—Ä—ñ—à–µ 7 –¥–Ω—ñ–≤ –∑ generated_media/"""
    directory = Path('backend/generated_media')
    cutoff_date = now() - timedelta(days=7)
    
    deleted_count = 0
    for file_path in directory.rglob('*'):
        if file_path.is_file():
            mtime = datetime.fromtimestamp(file_path.stat().st_mtime)
            if mtime < cutoff_date:
                file_path.unlink()
                deleted_count += 1
    
    return f"–í–∏–¥–∞–ª–µ–Ω–æ {deleted_count} —Ñ–∞–π–ª—ñ–≤"
```

**–†–æ–∑–∫–ª–∞–¥**: –©–æ–Ω–µ–¥—ñ–ª—ñ –æ 3:00 UTC  
**–ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è**: –û—á–∏—â–µ–Ω–Ω—è g4f generated files

#### 2. –û—á–∏—Å—Ç–∫–∞ –∑–∞—Å—Ç–∞—Ä—ñ–ª–∏—Ö —Ç–æ–∫–µ–Ω—ñ–≤

```python
@shared_task
def clean_blacklisted_tokens():
    """–í–∏–¥–∞–ª—è—î –¥—ñ–π—Å–Ω–æ –∑–∞—Å—Ç–∞—Ä—ñ–ª—ñ JWT —Ç–æ–∫–µ–Ω–∏"""
    # 1. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ exp –≤ JWT payload
    # 2. –í–∏–¥–∞–ª–µ–Ω–Ω—è –∑ BlacklistedToken
    # 3. –í–∏–¥–∞–ª–µ–Ω–Ω—è –∑ OutstandingToken
    # + safety buffer 7 –¥–Ω—ñ–≤
```

**–†–æ–∑–∫–ª–∞–¥**: –©–æ–¥–Ω—è –æ 2:00 UTC  
**–ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è**: –û—á–∏—â–µ–Ω–Ω—è JWT token tables

### –†—É—á–Ω–∏–π –∑–∞–ø—É—Å–∫

```bash
# –û—á–∏—Å—Ç–∫–∞ –º–µ–¥—ñ–∞
celery -A config call clean_generated_media

# –û—á–∏—Å—Ç–∫–∞ —Ç–æ–∫–µ–Ω—ñ–≤
celery -A config call clean_blacklisted_tokens
```

### –ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ (Flower)

```bash
# –ó–∞–ø—É—Å–∫ Flower
celery -A config flower

# UI –¥–æ—Å—Ç—É–ø–Ω–∏–π –Ω–∞ http://localhost:5555
```

### –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Ä–æ–∑–∫–ª–∞–¥—É

```python
# backend/config/celery.py

app.conf.beat_schedule = {
    'clean-generated-media-weekly': {
        'task': 'clean_generated_media',
        'schedule': crontab(day_of_week=0, hour=3, minute=0),  # –ù–µ–¥—ñ–ª—è 3:00
    },
    'clean-blacklisted-tokens-daily': {
        'task': 'clean_blacklisted_tokens',
        'schedule': crontab(hour=2, minute=0),  # –©–æ–¥–Ω—è 2:00
    },
}
```

---

## üé≠ –°–∏—Å—Ç–µ–º–∞ –ì–µ–Ω–µ—Ä–∞—Ü—ñ—ó –ú–æ–∫–æ–≤–∏—Ö –î–∞–Ω–∏—Ö

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø—Ä–∏ –∑–∞–ø—É—Å–∫—É

```bash
# Docker Compose –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Å—Ç–≤–æ—Ä—é—î:
docker-compose up

# 1. –î–æ–≤—ñ–¥–Ω–∏–∫–∏ (–º–∞—Ä–∫–∏, –º–æ–¥–µ–ª—ñ, –∫–æ–ª—å–æ—Ä–∏)
# 2. –¢–µ—Å—Ç–æ–≤—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ (admin, manager, buyers, sellers)
# 3. –ú–æ–∫–æ–≤–∞ —Å–∏—Å—Ç–µ–º–∞ (–ø—Ä–æ–¥–∞–≤—Ü—ñ + –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è)
```

### –†—É—á–Ω—ñ –∫–æ–º–∞–Ω–¥–∏

#### 1. –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–µ—Å—Ç–æ–≤–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤

```bash
# –ë–∞–∑–æ–≤—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ
python manage.py create_test_users

# –ó –∫–∞—Å—Ç–æ–º–Ω–∏–º –ø–∞—Ä–æ–ª–µ–º
python manage.py create_test_users --password mypass123
```

**–°—Ç–≤–æ—Ä—é—î**:
- üëë –°—É–ø–µ—Ä—é–∑–µ—Ä: `admin@autoria.com`
- üëî –ú–µ–Ω–µ–¥–∂–µ—Ä–∏: `manager@autoria.com`, `moderator@autoria.com`
- üë§ –ü–æ–∫—É–ø—Ü—ñ: `buyer1@gmail.com`, `buyer2@ukr.net`
- üè™ –ü—Ä–æ–¥–∞–≤—Ü—ñ: `seller1@gmail.com`, `dealer@autohouse.com`

#### 2. –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –º–æ–∫–æ–≤–æ—ó —Å–∏—Å—Ç–µ–º–∏

```bash
# –®–≤–∏–¥–∫–µ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è (5 –ø—Ä–æ–¥–∞–≤—Ü—ñ–≤, 20 –æ–≥–æ–ª–æ—à–µ–Ω—å)
python manage.py create_mock_system --quick

# –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–µ (15 –ø—Ä–æ–¥–∞–≤—Ü—ñ–≤, 50 –æ–≥–æ–ª–æ—à–µ–Ω—å)
python manage.py create_mock_system

# –û—á–∏—Å—Ç–∏—Ç–∏ —ñ —Å—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞–Ω–æ–≤–æ
python manage.py create_mock_system --clear
```

#### 3. LLM-–≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –¥–∞–Ω–∏—Ö (—Ä–æ–∑—à–∏—Ä–µ–Ω–∏–π)

```bash
# –ó LLM –≥–µ–Ω–µ—Ä–∞—Ü—ñ—î—é
python manage.py generate_mock_data --locale uk_UA --users 50 --car-ads 100

# –ü–æ–≤–Ω–∞ —Å–∏—Å—Ç–µ–º–∞
python manage.py populate_test_system --full
```

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å—Ç–≤–æ—Ä–µ–Ω–∏—Ö –¥–∞–Ω–∏—Ö

**–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ**:
- 1 —Å—É–ø–µ—Ä—é–∑–µ—Ä
- 2 –º–µ–Ω–µ–¥–∂–µ—Ä–∏
- 2 –ø–æ–∫—É–ø—Ü—ñ
- 5-15 –ø—Ä–æ–¥–∞–≤—Ü—ñ–≤ (–∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ —Ä–µ–∂–∏–º—É)

**–û–≥–æ–ª–æ—à–µ–Ω–Ω—è**:
- 20-50 –∞–∫—Ç–∏–≤–Ω–∏—Ö –æ–≥–æ–ª–æ—à–µ–Ω—å
- –†—ñ–∑–Ω—ñ —Å—Ç–∞—Ç—É—Å–∏: pending, active, rejected
- –†–µ–∞–ª—ñ—Å—Ç–∏—á–Ω—ñ —Ü—ñ–Ω–∏ (USD, EUR, UAH)
- –ì–µ–æ–ª–æ–∫–∞—Ü—ñ—è (—Ä–µ–≥—ñ–æ–Ω–∏/–º—ñ—Å—Ç–∞ –£–∫—Ä–∞—ó–Ω–∏)
- –§–æ—Ç–æ (–∑ g4f –∞–±–æ stock URLs)

### API –µ–Ω–¥–ø–æ—ñ–Ω—Ç–∏ –¥–ª—è –º–æ–∫—ñ–≤

```http
# –®–≤–∏–¥–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—è —á–µ—Ä–µ–∑ API
POST /api/testing/quick-setup/
{
    "num_sellers": 5,
    "num_ads": 20,
    "clear_existing": false
}

# –ü–æ–≤–Ω–∞ —Å–∏—Å—Ç–µ–º–∞
POST /api/testing/full-setup/
{
    "locale": "uk_UA",
    "num_users": 50,
    "num_ads": 100
}
```

---

## üìä –õ–æ–≥—É–≤–∞–Ω–Ω—è —Ç–∞ –ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥

### –õ–æ–≥—É–≤–∞–Ω–Ω—è –º–æ–¥–µ—Ä–∞—Ü—ñ—ó

```python
# backend/core/services/llm_moderation.py

logger.info(f"[HARD-BLOCK] Profanity detected in {len(content)} chars, took {elapsed}s")
logger.info(f"[LLM] Topic analysis: {result['is_appropriate']}, took {elapsed}s")
```

### –õ–æ–≥—É–≤–∞–Ω–Ω—è Celery

```python
# backend/core/tasks/periodic_tasks.py

logger.info(f"[CLEANUP] Deleted {deleted_count} files from generated_media")
logger.info(f"[CLEANUP] Cleaned {token_count} blacklisted tokens")
```

### –ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ —á–µ—Ä–µ–∑ Flower

- **URL**: http://localhost:5555
- **Tasks**: –°–ø–∏—Å–æ–∫ –≤—Å—ñ—Ö –∑–∞–¥–∞—á
- **Workers**: –°—Ç–∞—Ç—É—Å –≤–æ—Ä–∫–µ—Ä—ñ–≤
- **Monitor**: Real-time –≥—Ä–∞—Ñ—ñ–∫–∏

---

## üéØ Best Practices

1. **–ú–æ–¥–µ—Ä–∞—Ü—ñ—è**:
   - –ó–∞–≤–∂–¥–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ hard-block –ø–µ—Ä—à –Ω—ñ–∂ LLM
   - –õ–æ–≥—É–π—Ç–µ –≤—Å—ñ –º–æ–¥–µ—Ä–∞—Ü—ñ–π–Ω—ñ —Ä—ñ—à–µ–Ω–Ω—è
   - –ó–±–µ—Ä—ñ–≥–∞–π—Ç–µ `moderation_reason` –¥–ª—è transparency

2. **Celery**:
   - –ú–æ–Ω—ñ—Ç–æ—Ä—Ç–µ —á–µ—Ä–µ–∑ Flower
   - –ù–∞–ª–∞—à—Ç—É–π—Ç–µ alerts –¥–ª—è failed tasks
   - –†–µ–≥—É–ª—è—Ä–Ω–æ –ø–µ—Ä–µ–≤—ñ—Ä—è–π—Ç–µ –ª–æ–≥–∏

3. **–ú–æ–∫–æ–≤—ñ –¥–∞–Ω—ñ**:
   - –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ `--quick` –¥–ª—è —à–≤–∏–¥–∫–æ–≥–æ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è
   - –û—á–∏—â–∞–π—Ç–µ —Å—Ç–∞—Ä—ñ –¥–∞–Ω—ñ —á–µ—Ä–µ–∑ `--clear`
   - –ù–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ –º–æ–∫–∏ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—ñ!

---

## üîó –ü–æ–≤'—è–∑–∞–Ω—ñ –¥–æ–∫—É–º–µ–Ω—Ç–∏

- [Backend API Guide](./BACKEND_API_GUIDE.md) - API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è
- [Postman Testing](../backend/POSTMAN_TESTING_GUIDE.md) - –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è
- [Infrastructure](./INFRASTRUCTURE_SETUP.md) - Docker, Redis, Nginx

---

**–í–µ—Ä—Å—ñ—è**: 2.0  
**–û—Å—Ç–∞–Ω–Ω—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è**: 2025-01-25

