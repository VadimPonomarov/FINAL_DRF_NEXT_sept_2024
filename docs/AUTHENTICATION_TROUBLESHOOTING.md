# –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—é –ø—Ä–æ–±–ª–µ–º –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

## –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ
1. [–ü—Ä–æ–±–ª–µ–º–∞: –¢–æ–∫–µ–Ω—ã –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ Redis –ø–æ—Å–ª–µ –ª–æ–≥–∏–Ω–∞](#–ø—Ä–æ–±–ª–µ–º–∞-1-—Ç–æ–∫–µ–Ω—ã-–Ω–µ-—Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è-–≤-redis-–ø–æ—Å–ª–µ-–ª–æ–≥–∏–Ω–∞)
2. [–ü—Ä–æ–±–ª–µ–º–∞: –°–µ—Å—Å–∏—è NextAuth –∏—Å—Ç–µ–∫–∞–µ—Ç —Å–ª–∏—à–∫–æ–º –±—ã—Å—Ç—Ä–æ](#–ø—Ä–æ–±–ª–µ–º–∞-2-—Å–µ—Å—Å–∏—è-nextauth-–∏—Å—Ç–µ–∫–∞–µ—Ç-—Å–ª–∏—à–∫–æ–º-–±—ã—Å—Ç—Ä–æ)
3. [–ü—Ä–æ–±–ª–µ–º–∞: –ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ä–µ–¥–∏—Ä–µ–∫—Ç (ERR_TOO_MANY_REDIRECTS)](#–ø—Ä–æ–±–ª–µ–º–∞-3-–±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π-—Ä–µ–¥–∏—Ä–µ–∫—Ç-err_too_many_redirects)
4. [–ü—Ä–æ–±–ª–µ–º–∞: –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É /signin](#–ø—Ä–æ–±–ª–µ–º–∞-4-—Ä–µ–¥–∏—Ä–µ–∫—Ç-–Ω–∞-–Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â—É—é-—Å—Ç—Ä–∞–Ω–∏—Ü—É-signin)
5. [–ü—Ä–æ–±–ª–µ–º–∞: –°—Ç–∞—Ä—ã–π –∫–æ–¥ –∫—ç—à–∏—Ä—É–µ—Ç—Å—è Turbopack](#–ø—Ä–æ–±–ª–µ–º–∞-5-—Å—Ç–∞—Ä—ã–π-–∫–æ–¥-–∫—ç—à–∏—Ä—É–µ—Ç—Å—è-turbopack)
6. [–ü—Ä–æ–±–ª–µ–º–∞: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ signin –∏–∑-–∑–∞ CORS –æ—à–∏–±–æ–∫](#–ø—Ä–æ–±–ª–µ–º–∞-6-–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π-—Ä–µ–¥–∏—Ä–µ–∫—Ç-–Ω–∞-signin-–∏–∑-–∑–∞-cors-–æ—à–∏–±–æ–∫)
7. [–ü—Ä–æ–±–ª–µ–º–∞: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–¥–∏—Ä–µ–∫—Ç –∏–∑-–∑–∞ –æ—à–∏–±–æ–∫ 400/401](#–ø—Ä–æ–±–ª–µ–º–∞-7-–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π-—Ä–µ–¥–∏—Ä–µ–∫—Ç-–∏–∑-–∑–∞-–æ—à–∏–±–æ–∫-400401)
8. [–ü—Ä–æ–±–ª–µ–º–∞: –û—Ç–∫–∞—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å proxy - –≤–æ–∑–≤—Ä–∞—Ç –∫ –ø—Ä—è–º—ã–º –∑–∞–ø—Ä–æ—Å–∞–º](#–ø—Ä–æ–±–ª–µ–º–∞-8-–æ—Ç–∫–∞—Ç-–∏–∑–º–µ–Ω–µ–Ω–∏–π-—Å-proxy---–≤–æ–∑–≤—Ä–∞—Ç-–∫-–ø—Ä—è–º—ã–º-–∑–∞–ø—Ä–æ—Å–∞–º)
9. [–ü—Ä–æ–±–ª–µ–º–∞: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π refresh —Ç–æ–∫–µ–Ω–æ–≤ –ø—Ä–∏ 401 –æ—à–∏–±–∫–µ](#–ø—Ä–æ–±–ª–µ–º–∞-9-–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π-refresh-—Ç–æ–∫–µ–Ω–æ–≤-–ø—Ä–∏-401-–æ—à–∏–±–∫–µ)
10. [–ü—Ä–æ–±–ª–µ–º–∞: CORS –æ—à–∏–±–∫–∞ —Å credentials: 'include'](#–ø—Ä–æ–±–ª–µ–º–∞-10-cors-–æ—à–∏–±–∫–∞-—Å-credentials-include)

---

## –ü—Ä–æ–±–ª–µ–º–∞ 1: –¢–æ–∫–µ–Ω—ã –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ Redis –ø–æ—Å–ª–µ –ª–æ–≥–∏–Ω–∞

### –°–∏–º–ø—Ç–æ–º—ã
- –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ª–æ–≥–∏–Ω–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ `/login` –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Å—Ç–∞–µ—Ç—Å—è –Ω–∞ —Ç–æ–π –∂–µ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
- –í –ª–æ–≥–∞—Ö —Å–µ—Ä–≤–µ—Ä–∞ –ù–ï–¢ –∑–∞–ø—Ä–æ—Å–æ–≤ `POST /api/redis` –ø–æ—Å–ª–µ –ª–æ–≥–∏–Ω–∞
- –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ `/autoria` –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç
- –í –ª–æ–≥–∞—Ö –≤–∏–¥–Ω–æ: `[LoginForm] ‚ùå Tokens were NOT saved to Redis`

### –ü—Ä–∏—á–∏–Ω–∞
–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π `baseUrl` –¥–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Redis API –≤ —Ñ–∞–π–ª–µ `frontend/src/app/api/helpers.ts`.

**–ü—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–¥:**
```typescript
const baseUrl = isServer
  ? (process.env.NEXT_PUBLIC_IS_DOCKER === 'true' ? 'http://frontend:3000' : 'http://localhost:3000')
  : (process.env.NEXTAUTH_URL || 'http://localhost:3000'); // ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞
```

–ù–∞ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–π —Å—Ç–æ—Ä–æ–Ω–µ (–≤ –±—Ä–∞—É–∑–µ—Ä–µ) –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∞–±—Å–æ–ª—é—Ç–Ω–æ–≥–æ URL `http://localhost:3000` –º–æ–∂–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã —Å CORS –∏ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–µ–π.

### –†–µ—à–µ–Ω–∏–µ

**–§–∞–π–ª:** `frontend/src/app/api/helpers.ts`

**–ù–∞–π—Ç–∏ —Å—Ç—Ä–æ–∫–∏ (–ø—Ä–∏–º–µ—Ä–Ω–æ 299-305):**
```typescript
const baseUrl = isServer
  ? (process.env.NEXT_PUBLIC_IS_DOCKER === 'true' ? 'http://frontend:3000' : 'http://localhost:3000')
  : (process.env.NEXTAUTH_URL || 'http://localhost:3000');
```

**–ó–∞–º–µ–Ω–∏—Ç—å –Ω–∞:**
```typescript
const baseUrl = isServer
  ? (process.env.NEXT_PUBLIC_IS_DOCKER === 'true' ? 'http://frontend:3000' : 'http://localhost:3000')
  : ''; // ‚úÖ –ù–∞ –∫–ª–∏–µ–Ω—Ç–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π URL
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞
–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤ –ª–æ–≥–∞—Ö —Å–µ—Ä–≤–µ—Ä–∞ –¥–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è:
```
POST /api/redis [32m200[39m in 236ms
GET /autoria [32m200[39m in 1315ms
```

---

## –ü—Ä–æ–±–ª–µ–º–∞ 2: –°–µ—Å—Å–∏—è NextAuth –∏—Å—Ç–µ–∫–∞–µ—Ç —Å–ª–∏—à–∫–æ–º –±—ã—Å—Ç—Ä–æ

### –°–∏–º–ø—Ç–æ–º—ã
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã—Ö–æ–¥–∏—Ç –∏–∑ —Å–∏—Å—Ç–µ–º—ã —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç –ø–æ—Å–ª–µ –ª–æ–≥–∏–Ω–∞
- –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ `/api/auth/signin` –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –±–µ–∑ –≤–∏–¥–∏–º–æ–π –ø—Ä–∏—á–∏–Ω—ã
- –í middleware –ª–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç: `[Middleware] No valid NextAuth session`

### –ü—Ä–∏—á–∏–Ω–∞
–°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π `maxAge` –¥–ª—è JWT —Å–µ—Å—Å–∏–∏ –≤ NextAuth –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏.

### –†–µ—à–µ–Ω–∏–µ

**–§–∞–π–ª:** `frontend/src/configs/auth.ts`

**–ù–∞–π—Ç–∏ —Å–µ–∫—Ü–∏—é `session`:**
```typescript
session: {
  strategy: "jwt",
  maxAge: 60 * 60 * 24, // ‚ùå 24 —á–∞—Å–∞ - —Å–ª–∏—à–∫–æ–º –º–∞–ª–æ
  updateAge: 60 * 60 * 24,
},
```

**–ó–∞–º–µ–Ω–∏—Ç—å –Ω–∞:**
```typescript
session: {
  strategy: "jwt",
  maxAge: 60 * 60 * 24 * 30, // ‚úÖ 30 –¥–Ω–µ–π
  updateAge: 60 * 60 * 24, // –û–±–Ω–æ–≤–ª—è—Ç—å —Å–µ—Å—Å–∏—é –∫–∞–∂–¥—ã–µ 24 —á–∞—Å–∞
},
```

### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ `auth.ts` –ù–ï–¢ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ `pages`:
```typescript
// ‚ùå –£–î–ê–õ–ò–¢–¨ –µ—Å–ª–∏ –µ—Å—Ç—å:
pages: {
  signIn: "/api/auth/signin",
  signOut: "/api/auth/signout",
  error: "/api/auth/error",
},
```

NextAuth –¥–æ–ª–∂–µ–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã.

---

## –ü—Ä–æ–±–ª–µ–º–∞ 3: –ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ä–µ–¥–∏—Ä–µ–∫—Ç (ERR_TOO_MANY_REDIRECTS)

### –°–∏–º–ø—Ç–æ–º—ã
- –ë—Ä–∞—É–∑–µ—Ä –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ—à–∏–±–∫—É `ERR_TOO_MANY_REDIRECTS`
- –í –ª–æ–≥–∞—Ö —Å–µ—Ä–≤–µ—Ä–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ `GET /api/auth/signin [34m302[39m`
- –°—Ç—Ä–∞–Ω–∏—Ü–∞ `/api/auth/signin` –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è

### –ü—Ä–∏—á–∏–Ω–∞
–ö–æ–Ω—Ñ–ª–∏–∫—Ç –º–µ–∂–¥—É –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π `pages` –≤ NextAuth –∏ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–º —Ä–æ—É—Ç–æ–º `[...nextauth]`.

–ö–æ–≥–¥–∞ —É–∫–∞–∑–∞–Ω–æ `pages: { signIn: "/api/auth/signin" }`, NextAuth –¥—É–º–∞–µ—Ç, —á—Ç–æ —ç—Ç–æ –∫–∞—Å—Ç–æ–º–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞, –Ω–æ –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ —ç—Ç–æ –µ–≥–æ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π —Ä–æ—É—Ç, —á—Ç–æ —Å–æ–∑–¥–∞–µ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª —Ä–µ–¥–∏—Ä–µ–∫—Ç–æ–≤.

### –†–µ—à–µ–Ω–∏–µ

**–§–∞–π–ª:** `frontend/src/configs/auth.ts`

**–£–¥–∞–ª–∏—Ç—å —Å–µ–∫—Ü–∏—é `pages` –ø–æ–ª–Ω–æ—Å—Ç—å—é:**
```typescript
export const authConfig: AuthOptions = {
  // ... –¥—Ä—É–≥–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ...

  // ‚ùå –£–î–ê–õ–ò–¢–¨ –≠–¢–£ –°–ï–ö–¶–ò–Æ:
  // pages: {
  //   signIn: "/api/auth/signin",
  //   signOut: "/api/auth/signout",
  //   error: "/api/auth/error",
  // },

  callbacks: {
    // ... callbacks –æ—Å—Ç–∞—é—Ç—Å—è ...
  },
};
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞
–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```
GET /api/auth/signin [32m200[39m in 215ms  // ‚úÖ 200 –≤–º–µ—Å—Ç–æ 302
```

---

## –ü—Ä–æ–±–ª–µ–º–∞ 4: –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É /signin

### –°–∏–º–ø—Ç–æ–º—ã
- –ü—Ä–∏ –≤—ã–∑–æ–≤–µ `signOut()` –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ `/signin` (404)
- –í –ª–æ–≥–∞—Ö: `GET /signin?callbackUrl=%2Fautoria [33m404[39m`

### –ü—Ä–∏—á–∏–Ω–∞
NextAuth –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç –Ω–∞ `/signin` –ø–æ—Å–ª–µ `signOut()`, –Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø—É—Ç—å - `/api/auth/signin`.

### –†–µ—à–µ–Ω–∏–µ 1: –ò—Å–ø—Ä–∞–≤–∏—Ç—å –≤—ã–∑–æ–≤ signOut

**–§–∞–π–ª:** `frontend/src/components/Menus/MenuMain/MenuMain.tsx`

**–ù–∞–π—Ç–∏:**
```typescript
await signOut({ callbackUrl: "/api/auth/signin" });
```

**–ó–∞–º–µ–Ω–∏—Ç—å –Ω–∞:**
```typescript
await signOut({ redirect: false }); // ‚úÖ –û—Ç–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–¥–∏—Ä–µ–∫—Ç
window.location.href = '/api/auth/signin'; // –í—Ä—É—á–Ω—É—é —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏–º
```

### –†–µ—à–µ–Ω–∏–µ 2: –°–æ–∑–¥–∞—Ç—å —Ä–µ–¥–∏—Ä–µ–∫—Ç-—Å—Ç—Ä–∞–Ω–∏—Ü—É

**–§–∞–π–ª:** `frontend/src/app/signin/page.tsx` (—Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π)

```typescript
import { redirect } from 'next/navigation';

/**
 * Server-side redirect page for /signin -> /api/auth/signin
 * NextAuth sometimes redirects to /signin instead of /api/auth/signin
 * This page ensures proper redirection to the correct NextAuth signin page
 */
export default async function SignInRedirectPage({
  searchParams,
}: {
  searchParams: Promise<{ callbackUrl?: string }>;
}) {
  const params = await searchParams;
  const callbackUrl = params.callbackUrl;

  console.log('[SignInRedirect] Server-side redirect from /signin to /api/auth/signin', {
    callbackUrl
  });

  if (callbackUrl) {
    redirect(`/api/auth/signin?callbackUrl=${encodeURIComponent(callbackUrl)}`);
  } else {
    redirect('/api/auth/signin');
  }
}
```

---

## –ü—Ä–æ–±–ª–µ–º–∞ 5: –°—Ç–∞—Ä—ã–π –∫–æ–¥ –∫—ç—à–∏—Ä—É–µ—Ç—Å—è Turbopack

### –°–∏–º–ø—Ç–æ–º—ã
- –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ –Ω–µ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è
- –í –ª–æ–≥–∞—Ö –≤–∏–¥–Ω—ã –≤—ã–∑–æ–≤—ã —Å—Ç–∞—Ä—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π
- –ù–∞–ø—Ä–∏–º–µ—Ä: `[NextAuth signIn] Backend authentication failed` - —Ö–æ—Ç—è —ç—Ç–æ—Ç –∫–æ–¥ —É–∂–µ —É–¥–∞–ª–µ–Ω

### –ü—Ä–∏—á–∏–Ω–∞
Turbopack (dev —Å–µ—Ä–≤–µ—Ä Next.js 15) –∫—ç—à–∏—Ä—É–µ—Ç —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥ –∏ –Ω–µ –≤—Å–µ–≥–¥–∞ –æ–±–Ω–æ–≤–ª—è–µ—Ç –µ–≥–æ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö.

### –†–µ—à–µ–Ω–∏–µ

**–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å dev —Å–µ—Ä–≤–µ—Ä:**

```bash
# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—É—â–∏–π –ø—Ä–æ—Ü–µ—Å—Å (Ctrl+C)
# –ó–∞—Ç–µ–º –∑–∞–ø—É—Å—Ç–∏—Ç—å –∑–∞–Ω–æ–≤–æ:
npm run dev
```

**–ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—É kill:**
```bash
npm run kill 3000 && npm run dev
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞
–ü–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –≤ –ª–æ–≥–∞—Ö –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ç–æ–ª—å–∫–æ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ –∫–æ–¥–∞.

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –¥–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

### –£—Ä–æ–≤–µ–Ω—å 1: NextAuth Session
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –ë–∞–∑–æ–≤–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é
- **–•—Ä–∞–Ω–µ–Ω–∏–µ**: JWT —Ç–æ–∫–µ–Ω –≤ cookies
- **–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è**: 30 –¥–Ω–µ–π (—Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º –∫–∞–∂–¥—ã–µ 24 —á–∞—Å–∞)
- **–ü—Ä–æ–≤–µ—Ä–∫–∞**: Middleware –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `getToken()` –∏–∑ `next-auth/jwt`
- **–ó–∞—â–∏—â–∞–µ—Ç**: `/login`, `/profile`, `/settings`, `/autoria/*`

### –£—Ä–æ–≤–µ–Ω—å 2: Backend Tokens –≤ Redis
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –î–æ—Å—Ç—É–ø –∫ –∑–∞—â–∏—â–µ–Ω–Ω—ã–º API –±—ç–∫–µ–Ω–¥–∞
- **–•—Ä–∞–Ω–µ–Ω–∏–µ**: Redis (–∫–ª—é—á `backend_auth` –∏–ª–∏ `dummy_auth`)
- **–§–æ—Ä–º–∞—Ç**: `{ access: string, refresh: string, refreshAttempts: number }`
- **–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è**: –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –±—ç–∫–µ–Ω–¥–æ–º
- **–ü—Ä–æ–≤–µ—Ä–∫–∞**: Middleware —á–∏—Ç–∞–µ—Ç –∏–∑ Redis —á–µ—Ä–µ–∑ `/api/redis`
- **–ó–∞—â–∏—â–∞–µ—Ç**: `/autoria/*` (–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –∫ NextAuth)

### –ü–æ—Ç–æ–∫ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí /autoria
   ‚Üì
2. Middleware –ø—Ä–æ–≤–µ—Ä—è–µ—Ç NextAuth session
   ‚Üì (–Ω–µ—Ç)
3. Redirect ‚Üí /api/auth/signin
   ‚Üì
4. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç email ‚Üí NextAuth —Å–æ–∑–¥–∞–µ—Ç session
   ‚Üì
5. Redirect ‚Üí /login
   ‚Üì
6. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç backend user –∏ –ª–æ–≥–∏–Ω–∏—Ç—Å—è
   ‚Üì
7. useLoginForm.ts ‚Üí fetchAuth() ‚Üí Backend API
   ‚Üì
8. Backend –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç { access, refresh, user }
   ‚Üì
9. fetchAuth() —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ç–æ–∫–µ–Ω—ã –≤ Redis (POST /api/redis)
   ‚Üì
10. Redirect ‚Üí /autoria
    ‚Üì
11. Middleware –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:
    - NextAuth session ‚úÖ
    - Backend tokens –≤ Redis ‚úÖ
    ‚Üì
12. –î–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à–µ–Ω ‚Üí —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è
```

---

## –ß–µ–∫-–ª–∏—Å—Ç –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –ø—Ä–æ–±–ª–µ–º

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ NextAuth —Å–µ—Å—Å–∏–∏
```bash
# –í –ª–æ–≥–∞—Ö –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:
[Middleware] NextAuth session valid, checking backend tokens
```

–ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ:
```bash
[Middleware] No valid NextAuth session - redirecting to signin
```
‚Üí –ü—Ä–æ–±–ª–µ–º–∞ —Å NextAuth —Å–µ—Å—Å–∏–µ–π (—Å–º. –ü—Ä–æ–±–ª–µ–º–∞ 2)

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤ –≤ Redis
```bash
# –í –ª–æ–≥–∞—Ö –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:
POST /api/redis [32m200[39m in 236ms
[Middleware] backend_auth tokens found in Redis - allowing Autoria access
```

–ï—Å–ª–∏ –ù–ï–¢ `POST /api/redis`:
‚Üí –¢–æ–∫–µ–Ω—ã –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è (—Å–º. –ü—Ä–æ–±–ª–µ–º–∞ 1)

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–¥–∏—Ä–µ–∫—Ç–æ–≤
```bash
# –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ä–µ–¥–∏—Ä–µ–∫—Ç—ã:
GET /api/auth/signin [32m200[39m
POST /api/auth/callback/credentials [34m302[39m
GET /autoria [32m200[39m
```

–ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ:
```bash
GET /api/auth/signin [34m302[39m  # –ú–Ω–æ–∂–µ—Å—Ç–≤–æ —Ä–∞–∑
```
‚Üí –ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ä–µ–¥–∏—Ä–µ–∫—Ç (—Å–º. –ü—Ä–æ–±–ª–µ–º–∞ 3)

### 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
```
frontend/src/app/api/auth/
  ‚îî‚îÄ‚îÄ [...nextauth]/
      ‚îî‚îÄ‚îÄ route.ts  ‚úÖ –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —Ñ–∞–π–ª

–ù–ï –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:
  ‚îú‚îÄ‚îÄ signin/
  ‚îú‚îÄ‚îÄ signout/
  ‚îú‚îÄ‚îÄ session/
  ‚îî‚îÄ‚îÄ login/
```

–ï—Å–ª–∏ –µ—Å—Ç—å –ø—É—Å—Ç—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ ‚Üí —É–¥–∞–ª–∏—Ç—å –∏—Ö.

---

## –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

### –ü—Ä–æ–≤–µ—Ä–∫–∞ Redis
```bash
# –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Redis CLI
docker exec -it <redis-container> redis-cli

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–ª—é—á–∏
KEYS *

# –ü–æ–ª—É—á–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ
GET backend_auth
GET auth_provider
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ Docker
```bash
# Backend –ª–æ–≥–∏
docker logs <backend-container> --tail 100 -f

# Redis –ª–æ–≥–∏
docker logs <redis-container> --tail 100 -f
```

### –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞
```bash
# –£–¥–∞–ª–∏—Ç—å .next –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
rm -rf .next

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å dev —Å–µ—Ä–≤–µ—Ä
npm run dev
```


---

## –ü—Ä–æ–±–ª–µ–º–∞ 6: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ signin –∏–∑-–∑–∞ CORS –æ—à–∏–±–æ–∫

### –°–∏–º–ø—Ç–æ–º—ã
- –°—Ç—Ä–∞–Ω–∏—Ü–∞ `/autoria/search` –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —É—Å–ø–µ—à–Ω–æ –ø–æ—Å–ª–µ –ª–æ–≥–∏–Ω–∞
- –ß–µ—Ä–µ–∑ 5-10 —Å–µ–∫—É–Ω–¥ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ `/api/auth/signin`
- –í –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞ –≤–∏–¥–Ω—ã CORS –æ—à–∏–±–∫–∏:
  ```
  Access to fetch at 'http://localhost:8000/api/user/profile/' from origin 'http://localhost:3000'
  has been blocked by CORS policy
  ```
- –í –ª–æ–≥–∞—Ö –≤–∏–¥–Ω–æ: `[ApiErrorHandler] Critical API error detected`
- –ü–æ—Å–ª–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫: `[ApiErrorHandler] Too many critical errors, forcing redirect...`

### –ü—Ä–∏—á–∏–Ω–∞
–ù–µ–∫–æ—Ç–æ—Ä—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –¥–µ–ª–∞—é—Ç **–ø—Ä—è–º—ã–µ –∑–∞–ø—Ä–æ—Å—ã** –∫ backend (`http://localhost:8000`) –≤–º–µ—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è Next.js proxy (`/api/proxy/`).

**–¶–µ–ø–æ—á–∫–∞ —Å–æ–±—ã—Ç–∏–π:**
1. –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ `/autoria/search` –∑–∞–≥—Ä—É–∂–∞—é—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
2. –ó–∞–ø—Ä–æ—Å—ã –∏–¥—É—Ç –Ω–∞–ø—Ä—è–º—É—é –∫ `http://localhost:8000/api/user/profile/` –∏ –¥—Ä—É–≥–∏–º —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞–º
3. –ë—Ä–∞—É–∑–µ—Ä –±–ª–æ–∫–∏—Ä—É–µ—Ç —ç—Ç–∏ –∑–∞–ø—Ä–æ—Å—ã –∏–∑-–∑–∞ CORS policy (cross-origin requests)
4. `useApiErrorHandler` (—Ñ–∞–π–ª `frontend/src/hooks/useApiErrorHandler.ts`) —Å—á–∏—Ç–∞–µ—Ç CORS –æ—à–∏–±–∫–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–º–∏
5. –ü–æ—Å–ª–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –ø–æ—Ä–æ–≥–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ (`criticalErrorThreshold`) —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç `handleCriticalError()`
6. –§—É–Ω–∫—Ü–∏—è –≤—ã–∑—ã–≤–∞–µ—Ç `signOut({ redirect: false })` –∏ –¥–µ–ª–∞–µ—Ç —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ `/api/auth/signin`

**–ü—Ä–æ–±–ª–µ–º–Ω—ã–µ —Ñ–∞–π–ª—ã:**
- `frontend/src/app/api/helpers/publicFetch.ts` - –¥–µ–ª–∞–ª –ø—Ä—è–º—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ backend
- `frontend/src/services/api/apiClient.ts` - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª –ø—Ä—è–º–æ–π baseUrl –∫ backend

### –†–µ—à–µ–Ω–∏–µ

#### –í–∞—Ä–∏–∞–Ω—Ç 1: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Next.js proxy (–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø)

**–§–∞–π–ª 1:** `frontend/src/app/api/helpers/publicFetch.ts`

**–ë—ã–ª–æ:**
```typescript
export async function fetchPublicData<T = any>(
  endpoint: string,
  params?: Record<string, string>
): Promise<T | null> {
  try {
    // Get backend URL from environment
    const backendUrl = process.env.NEXT_PUBLIC_BACKEND_URL || 'http://localhost:8000';

    // Build URL with parameters
    const urlParams = new URLSearchParams(params || {});
    const url = `${backendUrl}/${endpoint}${urlParams.toString() ? `?${urlParams.toString()}` : ''}`;

    // Make request to Django backend
    const response = await fetch(url, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
      },
      cache: 'no-store'
    });
    // ...
  }
}
```

**–°—Ç–∞–ª–æ:**
```typescript
export async function fetchPublicData<T = any>(
  endpoint: string,
  params?: Record<string, string>
): Promise<T | null> {
  try {
    // Determine if we're on server or client
    const isServer = typeof window === 'undefined';

    // Build URL with parameters
    const urlParams = new URLSearchParams(params || {});
    const queryString = urlParams.toString() ? `?${urlParams.toString()}` : '';

    let url: string;

    if (isServer) {
      // Server-side: can make direct requests to backend
      // Use Docker service name if in Docker, otherwise localhost
      const isDocker = process.env.NEXT_PUBLIC_IS_DOCKER === 'true';
      const backendUrl = isDocker
        ? 'http://app:8000'  // Docker service name
        : (process.env.BACKEND_URL || process.env.NEXT_PUBLIC_BACKEND_URL || 'http://localhost:8000');

      url = `${backendUrl}/${endpoint}${queryString}`;
      console.log(`[Public Fetch] Server-side GET ${url}`);
    } else {
      // Client-side: use Next.js API proxy to avoid CORS
      url = `/api/proxy/${endpoint}${queryString}`;
      console.log(`[Public Fetch] Client-side GET ${url} (via proxy)`);
    }

    // Make request
    const response = await fetch(url, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
      },
      cache: 'no-store'
    });
    // ...
  }
}
```

**–§–∞–π–ª 2:** `frontend/src/services/api/apiClient.ts`

**–ë—ã–ª–æ:**
```typescript
class ApiClient {
  private baseUrl: string;
  private timeout: number;
  private retries: number;

  constructor(options: ApiClientOptions = {}) {
    this.baseUrl = options.baseUrl || process.env.NEXT_PUBLIC_BACKEND_URL || 'http://localhost:8000';
    this.timeout = options.timeout || 15000;
    this.retries = options.retries || 1;
  }

  async request<T>(endpoint: string, options: RequestOptions = {}): Promise<T> {
    // ...
    const url = endpoint.startsWith('http') ? endpoint : `${this.baseUrl}${endpoint}`;
    // ...
  }
}
```

**–°—Ç–∞–ª–æ:**
```typescript
class ApiClient {
  private baseUrl: string;
  private timeout: number;
  private retries: number;
  private useProxy: boolean;

  constructor(options: ApiClientOptions = {}) {
    // IMPORTANT: Client-side code should use Next.js proxy to avoid CORS
    // Only use direct backend URL if explicitly provided in options
    this.useProxy = !options.baseUrl; // Use proxy by default unless custom baseUrl provided
    this.baseUrl = options.baseUrl || '/api/proxy'; // Default to proxy route
    this.timeout = options.timeout || 15000;
    this.retries = options.retries || 1;

    console.log(`[ApiClient] Initialized with baseUrl: ${this.baseUrl}, useProxy: ${this.useProxy}`);
  }

  async request<T>(endpoint: string, options: RequestOptions = {}): Promise<T> {
    // ...
    let url: string;
    if (endpoint.startsWith('http')) {
      // Absolute URL provided - use as is
      url = endpoint;
    } else if (this.useProxy) {
      // Using proxy - endpoint should be relative to backend (e.g., 'api/user/profile/')
      // Remove leading slash if present
      const cleanEndpoint = endpoint.startsWith('/') ? endpoint.slice(1) : endpoint;
      url = `${this.baseUrl}/${cleanEndpoint}`;
    } else {
      // Direct backend URL
      url = `${this.baseUrl}${endpoint}`;
    }

    console.log(`[ApiClient] ${method} ${url} (proxy: ${this.useProxy})`);
    // ...
  }
}
```

**–§–∞–π–ª 3:** `frontend/src/app/api/proxy/[...path]/route.ts` (—É–∂–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω)

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ proxy –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π backend URL:
```typescript
// Get backend URL
// IMPORTANT: Frontend runs locally (not in Docker), so always use localhost
// Backend runs in Docker but exposes port 8000 to localhost
const backendUrl = process.env.BACKEND_URL || process.env.NEXT_PUBLIC_BACKEND_URL || 'http://localhost:8000';
```

#### –í–∞—Ä–∏–∞–Ω—Ç 2: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å CORS –≤ Django (–ù–ï –†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø)

–≠—Ç–æ—Ç –≤–∞—Ä–∏–∞–Ω—Ç –Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è, —Ç–∞–∫ –∫–∞–∫:
- –ù–∞—Ä—É—à–∞–µ—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –ø—Ä–æ–µ–∫—Ç–∞ (–≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –¥–æ–ª–∂–Ω—ã –∏–¥—Ç–∏ —á–µ—Ä–µ–∑ Next.js)
- –¢—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ CORS
- –ú–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π (cookies, credentials)

–ï—Å–ª–∏ –≤—Å–µ –∂–µ –Ω—É–∂–Ω–æ:

**–§–∞–π–ª:** `backend/config/settings.py`

```python
CORS_ALLOWED_ORIGINS = [
    "http://localhost:3000",
    "http://127.0.0.1:3000",
]

CORS_ALLOW_CREDENTIALS = True
```

#### –í–∞—Ä–∏–∞–Ω—Ç 3: –í—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–¥–∏—Ä–µ–∫—Ç (–î–õ–Ø –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø)

**–§–∞–π–ª:** `frontend/src/hooks/useApiErrorHandler.ts`

```typescript
// –£–≤–µ–ª–∏—á–∏—Ç—å –ø–æ—Ä–æ–≥ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫
const criticalErrorThreshold = 100; // –ë—ã–ª–æ: 5

// –ò–ª–∏ –æ—Ç–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–¥–∏—Ä–µ–∫—Ç
const enableAutoRedirect = false; // –ë—ã–ª–æ: true
```

**‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ:** –≠—Ç–æ —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è! –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ.

### –ü—Ä–æ–≤–µ—Ä–∫–∞

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ä–µ—à–µ–Ω–∏—è:

1. **–û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à –±—Ä–∞—É–∑–µ—Ä–∞** –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É
2. **–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å dev —Å–µ—Ä–≤–µ—Ä** (–µ—Å–ª–∏ –∏–∑–º–µ–Ω—è–ª–∏ –∫–æ–¥):
   ```bash
   # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—É—â–∏–π –ø—Ä–æ—Ü–µ—Å—Å (Ctrl+C)
   npm run dev
   ```
3. **–í–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É** —á–µ—Ä–µ–∑ `/api/auth/signin`
4. **–ü–µ—Ä–µ–π—Ç–∏ –Ω–∞** `/autoria/search`
5. **–ü–æ–¥–æ–∂–¥–∞—Ç—å 10-15 —Å–µ–∫—É–Ω–¥** - —Ä–µ–¥–∏—Ä–µ–∫—Ç –ù–ï –¥–æ–ª–∂–µ–Ω –ø—Ä–æ–∏–∑–æ–π—Ç–∏
6. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞** - CORS –æ—à–∏–±–æ–∫ –±—ã—Ç—å –ù–ï –¥–æ–ª–∂–Ω–æ
7. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å Network tab** - –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –¥–æ–ª–∂–Ω—ã –∏–¥—Ç–∏ —á–µ—Ä–µ–∑ `/api/proxy/`

**–û–∂–∏–¥–∞–µ–º—ã–µ –ª–æ–≥–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏:**
```
[Public Fetch] Client-side GET /api/proxy/api/user/profile/ (via proxy)
[ApiClient] GET /api/proxy/api/user/addresses/ (proxy: true)
[ApiClient] GET /api/proxy/api/accounts/contacts/ (proxy: true)
```

**–ù–ï –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:**
```
‚ùå Access to fetch at 'http://localhost:8000/...' has been blocked by CORS policy
‚ùå [ApiErrorHandler] Critical API error detected
‚ùå [ApiErrorHandler] Too many critical errors, forcing redirect...
```

### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

**–ü–æ—á–µ–º—É –≤–æ–∑–Ω–∏–∫–∞–µ—Ç CORS –æ—à–∏–±–∫–∞:**
- Frontend —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ `http://localhost:3000`
- Backend —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ `http://localhost:8000`
- –≠—Ç–æ —Ä–∞–∑–Ω—ã–µ origins (—Ä–∞–∑–Ω—ã–µ –ø–æ—Ä—Ç—ã)
- –ë—Ä–∞—É–∑–µ—Ä –±–ª–æ–∫–∏—Ä—É–µ—Ç cross-origin –∑–∞–ø—Ä–æ—Å—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

**–ü–æ—á–µ–º—É Next.js proxy —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É:**
- –ó–∞–ø—Ä–æ—Å –∏–¥–µ—Ç –Ω–∞ —Ç–æ—Ç –∂–µ origin: `http://localhost:3000/api/proxy/...`
- Next.js API route –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ backend –Ω–∞ —Å–µ—Ä–≤–µ—Ä–Ω–æ–π —Å—Ç–æ—Ä–æ–Ω–µ
- –°–µ—Ä–≤–µ—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –Ω–µ –ø–æ–¥–≤–µ—Ä–∂–µ–Ω—ã CORS –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º
- Backend –ø–æ–ª—É—á–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –∏ –æ—Ç–≤–µ—á–∞–µ—Ç
- Next.js –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ç–≤–µ—Ç –∫–ª–∏–µ–Ω—Ç—É

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:**
```
Browser (localhost:3000)
  ‚Üì fetch('/api/proxy/api/user/profile/')
Next.js API Route (localhost:3000/api/proxy/[...path])
  ‚Üì fetch('http://localhost:8000/api/user/profile/')
Django Backend (localhost:8000)
  ‚Üì response
Next.js API Route
  ‚Üì response
Browser
```

---

## –ö–æ–Ω—Ç–∞–∫—Ç—ã –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

- **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è NextAuth**: https://next-auth.js.org/
- **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è Redis**: https://redis.io/docs/
- **Next.js 15 Docs**: https://nextjs.org/docs

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è**: 2025-01-16
**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ**: 2025-01-16

---

## –ü—Ä–æ–±–ª–µ–º–∞ 7: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–¥–∏—Ä–µ–∫—Ç –∏–∑-–∑–∞ –æ—à–∏–±–æ–∫ 400/401

### –°–∏–º–ø—Ç–æ–º—ã
- –°—Ç—Ä–∞–Ω–∏—Ü–∞ `/autoria/search` –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —É—Å–ø–µ—à–Ω–æ
- –ß–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π `signOut` –∏ —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ `/signin`
- –í –ª–æ–≥–∞—Ö –≤–∏–¥–Ω–æ:
  ```
  GET /api/auth/token 400
  POST /api/auth/signout 200
  GET /signin?callbackUrl=%2Fautoria%2Fsearch 200
  ```

### –ü—Ä–∏—á–∏–Ω–∞
`useApiErrorHandler` –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç **–í–°–ï** fetch –∑–∞–ø—Ä–æ—Å—ã —á–µ—Ä–µ–∑ `setupGlobalFetchErrorTracking` –∏ —Å—á–∏—Ç–∞–µ—Ç –æ—à–∏–±–∫–∏ 400/401 **–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–º–∏**, —Ö–æ—Ç—è –æ–Ω–∏ —è–≤–ª—è—é—Ç—Å—è **–Ω–æ—Ä–º–∞–ª—å–Ω—ã–º–∏** –¥–ª—è API –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏.

**–ü—Ä–æ–±–ª–µ–º–Ω–∞—è –ª–æ–≥–∏–∫–∞ –≤ `isCriticalError`:**
```typescript
// –ë–´–õ–û (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ):
private isCriticalError(status: number, url: string): boolean {
  const isApiEndpoint = url.includes('/api/') && !url.includes('/api/auth/');

  return (
    (status === 404 && isApiEndpoint) ||
    status >= 500 ||
    status === 0 // Network error
  );
}
```

–ü—Ä–æ–±–ª–µ–º–∞: —Ñ—É–Ω–∫—Ü–∏—è –ù–ï –∏—Å–∫–ª—é—á–∞–ª–∞ –æ—à–∏–±–∫–∏ 400-499 –¥–ª—è `/api/auth/*`, `/api/public/*`, `/api/redis`.

### –†–µ—à–µ–Ω–∏–µ

**–§–∞–π–ª 1:** `frontend/src/hooks/useApiErrorHandler.ts`

–û–±–Ω–æ–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `isCriticalError` –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è –Ω–æ—Ä–º–∞–ª—å–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö –æ—à–∏–±–æ–∫:

```typescript
// –°–¢–ê–õ–û (–ø—Ä–∞–≤–∏–ª—å–Ω–æ):
private isCriticalError(status: number, url: string): boolean {
  // –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏:
  // 1. 500+ —Å–µ—Ä–≤–µ—Ä–Ω—ã–µ –æ—à–∏–±–∫–∏
  // 2. Network errors (status 0)
  // 3. 404 –¥–ª—è API endpoints (–ù–û –ù–ï –¥–ª—è /api/auth/* –∏ /api/public/*)

  // –ò—Å–∫–ª—é—á–∞–µ–º –≤—Å–µ auth endpoints - –æ–Ω–∏ –º–æ–≥—É—Ç –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å 400/401/404 –≤ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–º —Ä–µ–∂–∏–º–µ
  if (url.includes('/api/auth/')) {
    return false;
  }

  // –ò—Å–∫–ª—é—á–∞–µ–º public endpoints - –æ–Ω–∏ –º–æ–≥—É—Ç –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å 404 –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç
  if (url.includes('/api/public/')) {
    return false;
  }

  // –ò—Å–∫–ª—é—á–∞–µ–º Redis API - –æ–Ω –º–æ–∂–µ—Ç –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å 404 –µ—Å–ª–∏ –∫–ª—é—á–∞ –Ω–µ—Ç
  if (url.includes('/api/redis')) {
    return false;
  }

  // 400-499 –æ—à–∏–±–∫–∏ –ù–ï –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ (—ç—Ç–æ –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–µ –æ—à–∏–±–∫–∏ - –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å, –Ω–µ—Ç –ø—Ä–∞–≤ –∏ —Ç.–¥.)
  if (status >= 400 && status < 500) {
    return false;
  }

  const isApiEndpoint = url.includes('/api/');

  return (
    status >= 500 ||  // –°–µ—Ä–≤–µ—Ä–Ω—ã–µ –æ—à–∏–±–∫–∏
    status === 0 ||   // Network error
    (status === 404 && isApiEndpoint) // 404 –¥–ª—è API (–Ω–æ —É–∂–µ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω—ã auth/public/redis –≤—ã—à–µ)
  );
}
```

**–§–∞–π–ª 2:** `frontend/src/common/providers/RootProvider.tsx`

–£–≤–µ–ª–∏—á–µ–Ω –ø–æ—Ä–æ–≥ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫:

```typescript
// –ë–´–õ–û:
criticalErrorThreshold: 5

// –°–¢–ê–õ–û:
criticalErrorThreshold: 10 // –¢–æ–ª—å–∫–æ —Å–µ—Ä–≤–µ—Ä–Ω—ã–µ 500+ –∏ network errors
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

1. **–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ `/login`**
2. **–ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ `/autoria/search`**
3. **–ü–æ–¥–æ–∂–¥–∞—Ç—å 30+ —Å–µ–∫—É–Ω–¥** - —Ä–µ–¥–∏—Ä–µ–∫—Ç –ù–ï –¥–æ–ª–∂–µ–Ω –ø—Ä–æ–∏–∑–æ–π—Ç–∏
4. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏** - –æ—à–∏–±–∫–∏ 400/401 –ù–ï –¥–æ–ª–∂–Ω—ã —Å—á–∏—Ç–∞—Ç—å—Å—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–º–∏:
   ```
   ‚úÖ GET /api/auth/token 400 - –ù–ï –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞
   ‚úÖ GET /api/public/reference/brands 404 - –ù–ï –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞
   ‚úÖ GET /api/redis?key=backend_auth 404 - –ù–ï –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞

   ‚ùå GET /api/autoria/cars 500 - –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –æ—à–∏–±–∫–∞ (—Å–µ—Ä–≤–µ—Ä–Ω–∞—è)
   ‚ùå Network error (status 0) - –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –æ—à–∏–±–∫–∞
   ```

### –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã

1. **400-499 –æ—à–∏–±–∫–∏ –ù–ï –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ** - —ç—Ç–æ –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–µ –æ—à–∏–±–∫–∏ (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å, –Ω–µ—Ç –ø—Ä–∞–≤, –Ω–µ –Ω–∞–π–¥–µ–Ω–æ)
2. **500+ –æ—à–∏–±–∫–∏ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï** - —ç—Ç–æ —Å–µ—Ä–≤–µ—Ä–Ω—ã–µ –æ—à–∏–±–∫–∏ (backend —É–ø–∞–ª, –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞)
3. **Network errors (status 0) –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï** - —ç—Ç–æ —Å–µ—Ç–µ–≤—ã–µ –æ—à–∏–±–∫–∏ (–Ω–µ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞, backend –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)
4. **Auth endpoints –∏—Å–∫–ª—é—á–µ–Ω—ã** - `/api/auth/*` –º–æ–∂–µ—Ç –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å 400/401 –≤ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–º —Ä–µ–∂–∏–º–µ
5. **Public endpoints –∏—Å–∫–ª—é—á–µ–Ω—ã** - `/api/public/*` –º–æ–∂–µ—Ç –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å 404 –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç
6. **Redis API –∏—Å–∫–ª—é—á–µ–Ω** - `/api/redis` –º–æ–∂–µ—Ç –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å 404 –µ—Å–ª–∏ –∫–ª—é—á–∞ –Ω–µ—Ç –≤ –∫—ç—à–µ

---

## –ü—Ä–æ–±–ª–µ–º–∞ 8: –û—Ç–∫–∞—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å proxy - –≤–æ–∑–≤—Ä–∞—Ç –∫ –ø—Ä—è–º—ã–º –∑–∞–ø—Ä–æ—Å–∞–º

### –ö–æ–Ω—Ç–µ–∫—Å—Ç
–í –ü—Ä–æ–±–ª–µ–º–µ 6 –±—ã–ª–∏ –≤–Ω–µ—Å–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è Next.js proxy (`/api/proxy/`) –¥–ª—è –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ backend.
–û–¥–Ω–∞–∫–æ, —ç—Ç–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –±—ã–ª–∏ **–æ—Ç–∫–∞—á–µ–Ω—ã**, –ø–æ—Ç–æ–º—É —á—Ç–æ:

1. **–í –∫–æ–º–º–∏—Ç–µ `c4d14c783c897a60f6ccd5b1ae26f638dc4f34c6` –≤—Å–µ —Ä–∞–±–æ—Ç–∞–ª–æ –æ—Ç–ª–∏—á–Ω–æ** —Å –ø—Ä—è–º—ã–º–∏ –∑–∞–ø—Ä–æ—Å–∞–º–∏ –∫ backend
2. **Django backend –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω** —Å `CORS_ALLOW_ALL_ORIGINS = True`
3. **CORS –ù–ï —è–≤–ª—è–µ—Ç—Å—è –ø—Ä–æ–±–ª–µ–º–æ–π** - –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –ø—Ä–æ—Ö–æ–¥—è—Ç —É—Å–ø–µ—à–Ω–æ
4. **Proxy –¥–æ–±–∞–≤–ª—è–µ—Ç –Ω–µ–Ω—É–∂–Ω—É—é —Å–ª–æ–∂–Ω–æ—Å—Ç—å** –±–µ–∑ —Ä–µ–∞–ª—å–Ω–æ–π –ø–æ–ª—å–∑—ã

### –†–µ—à–µ–Ω–∏–µ: –ü—Ä—è–º—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ backend

–í—Å–µ —Ñ–∞–π–ª—ã –±—ã–ª–∏ –≤–æ–∑–≤—Ä–∞—â–µ–Ω—ã –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –ø—Ä—è–º—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤:

#### 1. `frontend/src/app/api/helpers.ts` - —Ñ—É–Ω–∫—Ü–∏—è `fetchAuth`

```typescript
// –§–æ—Ä–º–∏—Ä—É–µ–º endpoint —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Service Registry –¥–ª—è backend
let endpoint: string;
if (isUsingDummyAuth) {
  endpoint = `${API_URLS[AuthProvider.Dummy]}/auth/login`;
} else {
  // –ò—Å–ø–æ–ª—å–∑—É–µ–º NEXT_PUBLIC_BACKEND_URL –Ω–∞–ø—Ä—è–º—É—é –¥–ª—è –±–æ–ª—å—à–µ–π –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
  const backendUrl = process.env.NEXT_PUBLIC_BACKEND_URL || API_URLS[AuthProvider.MyBackendDocs];
  endpoint = `${backendUrl}/api/auth/login`;
  console.log(`[fetchAuth] Using endpoint: ${endpoint}`);
}

const response = await fetch(endpoint, {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify(credentials),
  cache: "no-store",
});
```

#### 2. `frontend/src/app/api/helpers.ts` - —Ñ—É–Ω–∫—Ü–∏—è `fetchData`

```typescript
try {
  const urlSearchParams = new URLSearchParams(params).toString();
  const headers = await getAuthorizationHeaders();
  const url = `${endpoint}${urlSearchParams ? `?${urlSearchParams}` : ''}`;

  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–ª—é—á –¥–ª—è —Ç–æ–∫–µ–Ω–æ–≤
  const authProvider = (await apiGetRedis("auth_provider")) || AuthProvider.MyBackendDocs;
  const tokenKey = authProvider === AuthProvider.Dummy ? "dummy_auth" : "backend_auth";

  const response = await fetch(url, {
    headers,
    method: "GET",
    cache: 'no-store'
  });
  // ...
}
```

#### 3. `frontend/src/app/api/helpers/publicFetch.ts`

```typescript
export async function fetchPublicData<T = any>(
  endpoint: string,
  params?: Record<string, string>
): Promise<T | null> {
  try {
    // Use Docker service name if in Docker, otherwise localhost
    const isDocker = process.env.NEXT_PUBLIC_IS_DOCKER === 'true';
    const backendUrl = isDocker
      ? 'http://app:8000'  // Docker service name
      : (process.env.BACKEND_URL || process.env.NEXT_PUBLIC_BACKEND_URL || 'http://localhost:8000');

    // Build URL with parameters
    const urlParams = new URLSearchParams(params || {});
    const queryString = urlParams.toString() ? `?${urlParams.toString()}` : '';
    const url = `${backendUrl}/${endpoint}${queryString}`;

    console.log(`[Public Fetch] GET ${url}`);

    const response = await fetch(url, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
      },
      cache: 'no-store'
    });
    // ...
  }
}
```

#### 4. `frontend/src/services/api/apiClient.ts`

```typescript
class ApiClient {
  private baseUrl: string;
  private timeout: number;
  private retries: number;
  private useProxy: boolean;

  constructor(options: ApiClientOptions = {}) {
    // Use environment variable for backend URL
    const defaultBaseUrl = process.env.NEXT_PUBLIC_BACKEND_URL || 'http://localhost:8000';
    this.useProxy = false; // Direct backend requests
    this.baseUrl = options.baseUrl || defaultBaseUrl;
    this.timeout = options.timeout || 15000;
    this.retries = options.retries || 1;

    console.log(`[ApiClient] Initialized with baseUrl: ${this.baseUrl}`);
  }

  async request<T>(endpoint: string, options: RequestOptions = {}): Promise<T> {
    // ...
    const url = endpoint.startsWith('http')
      ? endpoint
      : `${this.baseUrl}${endpoint}`;

    console.log(`[ApiClient] ${method} ${url}`);

    const response = await fetch(url, {
      method,
      headers: requestHeaders,
      body: body ? JSON.stringify(body) : undefined,
      signal: controller.signal
    });
    // ...
  }
}
```

### –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã

1. **Environment Variables**: –ò—Å–ø–æ–ª—å–∑—É–µ–º `NEXT_PUBLIC_BACKEND_URL` –¥–ª—è –≤—Å–µ—Ö –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
2. **Docker Support**: –ü—Ä–æ–≤–µ—Ä—è–µ–º `NEXT_PUBLIC_IS_DOCKER` –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –æ–∫—Ä—É–∂–µ–Ω–∏—è
3. **No Proxy Needed**: –ü—Ä—è–º—ã–µ –∑–∞–ø—Ä–æ—Å—ã —Ä–∞–±–æ—Ç–∞—é—Ç –æ—Ç–ª–∏—á–Ω–æ –±–ª–∞–≥–æ–¥–∞—Ä—è `CORS_ALLOW_ALL_ORIGINS = True`
4. **Simplicity**: –ö–æ–¥ —Å—Ç–∞–ª –ø—Ä–æ—â–µ –∏ –ø–æ–Ω—è—Ç–Ω–µ–µ –±–µ–∑ –ª–∏—à–Ω–∏—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫ server/client side

### –ü—Ä–æ–≤–µ—Ä–∫–∞

–ü–æ—Å–ª–µ –æ—Ç–∫–∞—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π:

1. **–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å dev —Å–µ—Ä–≤–µ—Ä**:
   ```bash
   npm run dev
   ```

2. **–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ —Ñ–æ—Ä–º—É `/login`**:
   - –ó–∞–ø—Ä–æ—Å –¥–æ–ª–∂–µ–Ω –∏–¥—Ç–∏ –∫ `http://localhost:8000/api/auth/login`
   - –¢–æ–∫–µ–Ω—ã –¥–æ–ª–∂–Ω—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å—Å—è –≤ Redis
   - –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ `/autoria/search`

3. **–ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ `/autoria/search`**:
   - –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –¥–æ–ª–∂–Ω—ã –∏–¥—Ç–∏ –Ω–∞–ø—Ä—è–º—É—é –∫ `http://localhost:8000`
   - –ù–ï –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å CORS –æ—à–∏–±–æ–∫
   - –ù–ï –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞

**–û–∂–∏–¥–∞–µ–º—ã–µ –ª–æ–≥–∏:**
```
[fetchAuth] Using endpoint: http://localhost:8000/api/auth/login
[Public Fetch] GET http://localhost:8000/api/public/reference/brands?page_size=50
[ApiClient] GET http://localhost:8000/api/user/profile/
```

**–ù–ï –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:**
```
‚ùå /api/proxy/auth/login
‚ùå /api/proxy/api/user/profile/
‚ùå Access to fetch at 'http://localhost:8000/...' has been blocked by CORS policy
```

### –í—ã–≤–æ–¥

**Proxy –ù–ï –Ω—É–∂–µ–Ω**, –µ—Å–ª–∏:
- Backend –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω —Å CORS
- –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ environment variables
- –ö–æ–¥ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `NEXT_PUBLIC_BACKEND_URL` –¥–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

**Proxy –Ω—É–∂–µ–Ω —Ç–æ–ª—å–∫–æ**, –µ—Å–ª–∏:
- Backend –ù–ï –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç CORS
- –ù—É–∂–Ω–æ —Å–∫—Ä—ã—Ç—å backend URL –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞
- –¢—Ä–µ–±—É–µ—Ç—Å—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ Next.js

---

## –ü—Ä–æ–±–ª–µ–º–∞ 9: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π refresh —Ç–æ–∫–µ–Ω–æ–≤ –ø—Ä–∏ 401 –æ—à–∏–±–∫–µ

### –°–∏–º–ø—Ç–æ–º—ã
- –ü—Ä–∏ –∑–∞–ø—Ä–æ—Å–∞—Ö –∫ –≤–Ω–µ—à–Ω–∏–º API —Å –∏—Å—Ç–µ–∫—à–∏–º–∏ —Ç–æ–∫–µ–Ω–∞–º–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è 401 –æ—à–∏–±–∫–∞
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—Ä–∞–∑—É –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ª–æ–≥–∏–Ω–∞
- –ù–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø–æ–ø—ã—Ç–∫–∏ –æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω—ã

### –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã
–ö–æ–≥–¥–∞ —Ç–æ–∫–µ–Ω—ã –¥–æ—Å—Ç—É–ø–∞ (access tokens) –∏—Å—Ç–µ–∫–∞—é—Ç, –ø–µ—Ä–≤–æ–µ —á—Ç–æ –¥–æ–ª–∂–Ω–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ 401 –æ—à–∏–±–∫–∏ - —ç—Ç–æ **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π refresh —Ç–æ–∫–µ–Ω–æ–≤ –∏ –ø–æ–≤—Ç–æ—Ä –∑–∞–ø—Ä–æ—Å–∞** (refresh –µ–¥–∏–Ω–æ–∂–¥—ã). –≠—Ç–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞ –≤ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö.

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ Token Refresh

#### 1. Route `/api/auth/refresh`
**–§–∞–π–ª:** `frontend/src/app/api/auth/refresh/route.ts`

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:**
- –ü–æ–ª—É—á–∞–µ—Ç refresh token –∏–∑ Redis (–∫–ª—é—á –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞: `backend_auth` –∏–ª–∏ `dummy_auth`)
- –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–µ–∫—É—â–∏–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä –∏–∑ Redis (`auth_provider`)
- –í—ã–∑—ã–≤–∞–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π backend endpoint –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –Ω–æ–≤—ã–µ —Ç–æ–∫–µ–Ω—ã –æ–±—Ä–∞—Ç–Ω–æ –≤ Redis
- –°–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Å—á–µ—Ç—á–∏–∫ `refreshAttempts` –ø—Ä–∏ —É—Å–ø–µ—Ö–µ
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –Ω–æ–≤—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤

**–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã:**
- **Backend** (`backend_auth`): Django backend –Ω–∞ `http://localhost:8000` –∏–ª–∏ `http://app:8000`
- **Dummy** (`dummy_auth`): Dummy API –Ω–∞ `http://localhost:3001` –∏–ª–∏ `http://dummy-api:3001`

#### 2. ApiClient —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º refresh
**–§–∞–π–ª:** `frontend/src/services/api/apiClient.ts`

**–õ–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ 401:**
```typescript
// –ï—Å–ª–∏ –ø–æ–ª—É—á–∏–ª–∏ 401 –∏ –Ω–µ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø–æ–≤—Ç–æ—Ä, –ø—ã—Ç–∞–µ–º—Å—è –æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω—ã
if (response.status === 401 && !skipAuth && !skipRetry) {
  console.log('[ApiClient] Got 401, attempting token refresh...');

  const refreshSuccess = await this.refreshTokens();
  if (refreshSuccess) {
    console.log('[ApiClient] Token refreshed, retrying request...');
    // –ü–æ–≤—Ç–æ—Ä—è–µ–º –∑–∞–ø—Ä–æ—Å —Å –Ω–æ–≤—ã–º–∏ —Ç–æ–∫–µ–Ω–∞–º–∏ (skipRetry: true —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–≥–æ —Ü–∏–∫–ª–∞)
    return this.request<T>(endpoint, { ...options, skipRetry: true });
  } else {
    console.error('[ApiClient] Token refresh failed, redirecting to login');
    throw new Error('Authentication failed');
  }
}
```

**–ú–µ—Ç–æ–¥ `refreshTokens()`:**
- –í—ã–∑—ã–≤–∞–µ—Ç `/api/auth/refresh` route
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `true` –µ—Å–ª–∏ refresh —É—Å–ø–µ—à–µ–Ω
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `false` –µ—Å–ª–∏ refresh –Ω–µ —É–¥–∞–ª—Å—è

#### 3. fetchData —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º refresh
**–§–∞–π–ª:** `frontend/src/app/api/helpers.ts`

**–õ–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ 401:**
```typescript
case 401: {
  console.log("Error 401: Token not valid. Attempting to refresh...");
  const refreshResult = await fetchRefresh(key);
  if (!refreshResult) {
    console.log("Refresh failed after all attempts, redirecting to login...");
    redirect("/login");
  }
  // Return null to trigger a retry with new token
  return null;
}
```

**–§—É–Ω–∫—Ü–∏—è `fetchRefresh()`:**
- –ü–æ–ª—É—á–∞–µ—Ç refresh token –∏–∑ Redis
- –í—ã–∑—ã–≤–∞–µ—Ç backend `/api/auth/refresh` endpoint –Ω–∞–ø—Ä—è–º—É—é
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –Ω–æ–≤—ã–µ —Ç–æ–∫–µ–Ω—ã –≤ Redis
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç retry –ª–æ–≥–∏–∫—É (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 3 –ø–æ–ø—ã—Ç–∫–∏)
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ —á–µ—Ä–µ–∑ `refreshAttempts` –≤ Redis

#### 4. TokenRefreshManager (—Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä)
**–§–∞–π–ª:** `frontend/src/utils/auth/tokenRefreshManager.ts`

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:**
- Singleton pattern - –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ refresh –∑–∞–ø—Ä–æ—Å—ã
- Retry –ª–æ–≥–∏–∫–∞ —Å –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
- Progress callbacks –¥–ª—è UI –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
- Success/Error callbacks
- –ú–µ—Ç–æ–¥ `smartRefresh()` - –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç–æ–∫–µ–Ω –∏—Å—Ç–µ–∫

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```typescript
const manager = TokenRefreshManager.getInstance();
const result = await manager.refreshTokens({
  maxRetries: 3,
  retryDelay: 1000,
  onProgress: (attempt, maxAttempts) => {
    console.log(`Attempt ${attempt}/${maxAttempts}`);
  },
  onSuccess: (result) => {
    console.log('Refresh successful');
  },
  onError: (error) => {
    console.error('Refresh failed:', error);
  }
});
```

### –†–µ—à–µ–Ω–∏–µ

**–°–æ–∑–¥–∞–Ω route `/api/auth/refresh/route.ts`** —Å–æ —Å–ª–µ–¥—É—é—â–∏–º–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º–∏:

1. **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –æ–±–æ–∏—Ö –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤** (Backend –∏ Dummy)
2. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞** –∏–∑ Redis
3. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤** –≤ Redis —Å –æ–±–Ω—É–ª–µ–Ω–∏–µ–º —Å—á–µ—Ç—á–∏–∫–∞ –ø–æ–ø—ã—Ç–æ–∫
4. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏** –Ω–æ–≤—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤
5. **–û—á–∏—Å—Ç–∫–∞ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤** –∏–∑ Redis –ø—Ä–∏ 401

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥:**

- ‚úÖ `ApiClient.request()` - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–∑—ã–≤–∞–µ—Ç refresh –ø—Ä–∏ 401
- ‚úÖ `fetchData()` - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–∑—ã–≤–∞–µ—Ç `fetchRefresh()` –ø—Ä–∏ 401
- ‚úÖ `TokenRefreshManager` - —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä —Å retry –ª–æ–≥–∏–∫–æ–π
- ‚úÖ `refreshAccessToken()` –≤ `tokenService.ts` - –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

1. **–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ `/login`** —Å –ª—é–±—ã–º –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–º
2. **–ü–æ–¥–æ–∂–¥–∞—Ç—å –∏—Å—Ç–µ—á–µ–Ω–∏—è access token** (–æ–±—ã—á–Ω–æ 5-15 –º–∏–Ω—É—Ç)
3. **–°–¥–µ–ª–∞—Ç—å –∑–∞–ø—Ä–æ—Å –∫ API** (–Ω–∞–ø—Ä–∏–º–µ—Ä, –æ—Ç–∫—Ä—ã—Ç—å `/autoria/search`)
4. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏:**
   ```
   ‚úÖ [ApiClient] Got 401, attempting token refresh...
   ‚úÖ [Auth Refresh API] Starting token refresh...
   ‚úÖ [Auth Refresh API] Using provider: backend
   ‚úÖ [Auth Refresh API] New tokens saved to Redis
   ‚úÖ [ApiClient] Token refreshed, retrying request...
   ‚úÖ Request successful with new token
   ```

5. **–£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ:**
   - –ó–∞–ø—Ä–æ—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–≤—Ç–æ—Ä–∏–ª—Å—è —Å –Ω–æ–≤—ã–º —Ç–æ–∫–µ–Ω–æ–º
   - –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ `/login` –ù–ï –ø—Ä–æ–∏–∑–æ—à–µ–ª
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Å—Ç–∞–ª—Å—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ

### –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã

1. **Refresh –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ï–î–ò–ù–û–ñ–î–´** - –ø–∞—Ä–∞–º–µ—Ç—Ä `skipRetry: true` –≤ `apiClient` –∏ `retryCount` –≤ `fetchData` –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—é—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª
2. **–°—á–µ—Ç—á–∏–∫ –ø–æ–ø—ã—Ç–æ–∫** - `refreshAttempts` –≤ Redis –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ (–º–∞–∫—Å–∏–º—É–º 3)
3. **–í—Ä–µ–º–µ–Ω–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞** - –µ—Å–ª–∏ refresh –Ω–µ—É–¥–∞—á–µ–Ω, –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è –Ω–∞ 60 —Å–µ–∫—É–Ω–¥ —á–µ—Ä–µ–∑ —Ñ–ª–∞–≥ `lastRefreshFailed` –∏ `lastRefreshTime`
4. **–û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –Ω–µ—É–¥–∞—á–µ** - –µ—Å–ª–∏ refresh token —Ç–æ–∂–µ –Ω–µ–≤–∞–ª–∏–¥–µ–Ω (401), —Ç–æ–∫–µ–Ω—ã —É–¥–∞–ª—è—é—Ç—Å—è –∏–∑ Redis
5. **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –æ–±–æ–∏—Ö –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ Backend –∏–ª–∏ Dummy
6. **Singleton pattern** - `TokenRefreshManager` –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ refresh –∑–∞–ø—Ä–æ—Å—ã
7. **–ó–∞—â–∏—Ç–∞ –æ—Ç —Ü–∏–∫–ª–æ–≤** - –µ—Å–ª–∏ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ refresh —Å–Ω–æ–≤–∞ –ø—Ä–∏—Ö–æ–¥–∏—Ç 401, –∑–∞–ø—Ä–æ—Å –ù–ï –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–∞ `/login`

### –ú–µ—Ö–∞–Ω–∏–∑–º –∑–∞—â–∏—Ç—ã –æ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã—Ö —Ü–∏–∫–ª–æ–≤

#### –í `apiClient.ts`:
```typescript
// –ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å —Å 401
if (response.status === 401 && !skipAuth && !skipRetry) {
  const refreshSuccess = await this.refreshTokens();
  if (refreshSuccess) {
    // –ü–æ–≤—Ç–æ—Ä —Å skipRetry: true - –≤—Ç–æ—Ä–æ–π 401 –ù–ï –≤—ã–∑–æ–≤–µ—Ç refresh
    return this.request<T>(endpoint, { ...options, skipRetry: true });
  }
}
```

#### –í `helpers.ts`:
```typescript
// –ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å —Å 401
if (!result && response.status === 401 && retryCount === 0) {
  console.log('[fetchData] Token refreshed, retrying request (attempt 1/1)...');
  return fetchData(endpoint, callbackUrl, params, retryCount + 1);
}

// –í—Ç–æ—Ä–æ–π –∑–∞–ø—Ä–æ—Å —Å 401 - –°–¢–û–ü
if (!result && response.status === 401 && retryCount > 0) {
  console.error('[fetchData] Still got 401 after token refresh, stopping retry');
  redirect("/login");
}
```

#### –í `fetchRefresh`:
```typescript
// –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
if (lastRefreshFailed && (now - lastRefreshTime) < 60000) {
  console.error('[fetchRefresh] Last refresh failed 30s ago, waiting before retry');
  return false;
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞ –ø–æ–ø—ã—Ç–æ–∫
if (refreshAttempts >= maxAttempts) {
  console.error('[fetchRefresh] Max refresh attempts (3) reached');
  return false;
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –î–∞–∂–µ –µ—Å–ª–∏ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ refresh —Å–Ω–æ–≤–∞ –ø—Ä–∏—Ö–æ–¥–∏—Ç 401, —Å–∏—Å—Ç–µ–º–∞:
1. –ù–ï –≤—ã–∑—ã–≤–∞–µ—Ç refresh –ø–æ–≤—Ç–æ—Ä–Ω–æ (–∏–∑-–∑–∞ `skipRetry` –∏–ª–∏ `retryCount`)
2. –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ `/login`
3. –ë–ª–æ–∫–∏—Ä—É–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ refresh –Ω–∞ 60 —Å–µ–∫—É–Ω–¥

---

## –ü—Ä–æ–±–ª–µ–º–∞ 10: CORS –æ—à–∏–±–∫–∞ —Å credentials: 'include'

### –°–∏–º–ø—Ç–æ–º—ã
```
Access to fetch at 'http://localhost:8000/api/user/addresses/' from origin 'http://localhost:3000'
has been blocked by CORS policy: Response to preflight request doesn't pass access control check:
The value of the 'Access-Control-Allow-Origin' header in the response must not be the wildcard '*'
when the request's credentials mode is 'include'.
```

### –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã
–ë—Ä–∞—É–∑–µ—Ä –±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã, –µ—Å–ª–∏:
- –ó–∞–ø—Ä–æ—Å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `credentials: 'include'` (–æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç cookies)
- Backend –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `Access-Control-Allow-Origin: *` (—Ä–∞–∑—Ä–µ—à–∞–µ—Ç –≤—Å–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏)

–≠—Ç–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –±—Ä–∞—É–∑–µ—Ä–∞: –Ω–µ–ª—å–∑—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ —Ä–∞–∑—Ä–µ—à–∞—Ç—å **–≤—Å–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏** –∏ **–æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å credentials**.

### –†–µ—à–µ–Ω–∏–µ

#### –í–∞—Ä–∏–∞–Ω—Ç 1: –£–±—Ä–∞—Ç—å `credentials: 'include'` (–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø)

–ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º **Bearer —Ç–æ–∫–µ–Ω—ã –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö**, –∞ –Ω–µ cookies, –ø–æ—ç—Ç–æ–º—É `credentials: 'include'` –Ω–µ –Ω—É–∂–µ–Ω.

**–ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:**

1. **`frontend/src/app/api/common.ts`** (—Å—Ç—Ä–æ–∫–∞ 109):
```typescript
// Prepare request options
const requestOptions: RequestInit = {
  method,
  headers: {
    'Content-Type': 'application/json',
    ...customHeaders
  },
  // –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ–º credentials: 'include', —Ç–∞–∫ –∫–∞–∫ –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º Bearer —Ç–æ–∫–µ–Ω—ã –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö
  // credentials: 'include' –≤—ã–∑—ã–≤–∞–µ—Ç CORS –æ—à–∏–±–∫—É —Å Access-Control-Allow-Origin: *
  cache: 'no-store'
};
```

2. **`frontend/src/utils/fetchWithAuth.ts`** (—Å—Ç—Ä–æ–∫–∏ 4, 23):
```typescript
const resp = await fetch(input, {
  ...init,
  // –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ–º credentials: 'include'
  headers: {
    'Content-Type': 'application/json',
    ...(init.headers || {})
  },
  cache: 'no-store'
});
```

3. **`frontend/src/app/api/helpers.ts`** (—Å—Ç—Ä–æ–∫–∞ 185):
```typescript
const response = await fetch(`${baseUrl}/api/auth/refresh`, {
  method: "POST",
  headers: {
    "Content-Type": "application/json",
  },
  body: JSON.stringify({ refresh }),
  // –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ–º credentials: 'include'
  cache: 'no-store'
});
```

#### –í–∞—Ä–∏–∞–Ω—Ç 2: –ü–æ–ª–Ω–æ–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ CORS –Ω–∞ backend (–ü–†–ò–ú–ï–ù–ï–ù–û)

–î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –º–æ–∂–Ω–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç–∫–ª—é—á–∏—Ç—å CORS, —Ä–∞–∑—Ä–µ—à–∏–≤ **–≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –±–µ–∑ –∏—Å–∫–ª—é—á–µ–Ω–∏–π**.

**–§–∞–π–ª 1:** `backend/core/middlewares/cors.py`

```python
def __call__(self, request):
    origin = request.META.get('HTTP_ORIGIN', '')
    print(f"üîß CORS: Processing request {request.method} {request.path} from origin: {origin}")

    # –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç–∫–ª—é—á–∞–µ–º CORS - —Ä–∞–∑—Ä–µ—à–∞–µ–º –í–°–ï –∑–∞–ø—Ä–æ—Å—ã –±–µ–∑ –∏—Å–∫–ª—é—á–µ–Ω–∏–π
    # –≠—Ç–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏ —É–ø—Ä–æ—â–∞–µ—Ç —Ä–∞–±–æ—Ç—É —Å API
    allow_origin = '*'
    allow_credentials = 'false'  # –í–ê–ñ–ù–û: –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 'false' –ø—Ä–∏ allow_origin = '*'
    print(f"üîß CORS: Allowing ALL origins and methods (CORS fully disabled for development)")
```

**–§–∞–π–ª 2:** `frontend/next.config.js` (—Å—Ç—Ä–æ–∫–∏ 192-221)

```javascript
{
  source: '/api/(.*)',
  headers: [
    {
      key: 'Cache-Control',
      value: 'no-store, must-revalidate'
    },
    // CORS headers - –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç–∫–ª—é—á–∞–µ–º CORS –¥–ª—è –∏–∑–±–µ–≥–∞–Ω–∏—è –æ—à–∏–±–æ–∫ –∑–∞–ø—Ä–æ—Å–æ–≤
    {
      key: 'Access-Control-Allow-Origin',
      value: '*'
    },
    {
      key: 'Access-Control-Allow-Methods',
      value: 'GET, POST, PUT, PATCH, DELETE, OPTIONS'
    },
    {
      key: 'Access-Control-Allow-Headers',
      value: 'Content-Type, Authorization, X-Requested-With, Accept, Origin'
    },
    {
      key: 'Access-Control-Allow-Credentials',
      value: 'false'
    },
    {
      key: 'Access-Control-Max-Age',
      value: '86400'
    }
  ],
}
```

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:**
- `Access-Control-Allow-Origin: *` - —Ä–∞–∑—Ä–µ—à–µ–Ω—ã –≤—Å–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏
- `Access-Control-Allow-Credentials: false` - credentials –ù–ï —Ä–∞–∑—Ä–µ—à–µ–Ω—ã (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–∏ `*`)
- `Access-Control-Allow-Methods: GET, POST, PUT, PATCH, DELETE, OPTIONS` - –≤—Å–µ –º–µ—Ç–æ–¥—ã
- `Access-Control-Allow-Headers: Content-Type, Authorization, ...` - –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏
- `Access-Control-Max-Age: 86400` - preflight –∫—ç—à–∏—Ä—É–µ—Ç—Å—è –Ω–∞ 24 —á–∞—Å–∞

### –†–µ–∑—É–ª—å—Ç–∞—Ç

‚úÖ **CORS –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç–∫–ª—é—á–µ–Ω** - –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã —Ä–∞–∑—Ä–µ—à–µ–Ω—ã –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
‚úÖ **–£–±—Ä–∞–Ω `credentials: 'include'`** - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ Bearer —Ç–æ–∫–µ–Ω—ã
‚úÖ **–ù–µ—Ç CORS –æ—à–∏–±–æ–∫** - –±—Ä–∞—É–∑–µ—Ä –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã
‚úÖ **–£–ø—Ä–æ—â–µ–Ω–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞** - –Ω–µ –Ω—É–∂–Ω–æ –¥—É–º–∞—Ç—å –æ CORS –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö

### –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã

1. **–î–ª—è production**: –ù—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –≤–º–µ—Å—Ç–æ `*`
2. **Bearer —Ç–æ–∫–µ–Ω—ã**: –ü–µ—Ä–µ–¥–∞—é—Ç—Å—è –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ `Authorization: Bearer <token>`, –Ω–µ —Ç—Ä–µ–±—É—é—Ç cookies
3. **Preflight –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ**: `Access-Control-Max-Age: 86400` —É–º–µ–Ω—å—à–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ OPTIONS –∑–∞–ø—Ä–æ—Å–æ–≤
4. **–ö–∞—Å—Ç–æ–º–Ω—ã–π middleware**: `CORSMiddleware` –∏–º–µ–µ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–∞–¥ `django-cors-headers`

