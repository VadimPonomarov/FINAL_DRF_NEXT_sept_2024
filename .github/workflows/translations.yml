name: Translations Validation

on:
  push:
    branches: [ main, master, develop ]
    paths:
      - 'frontend/src/locales/**'
      - 'frontend/src/**/*.tsx'
      - 'frontend/src/**/*.ts'
  pull_request:
    branches: [ main, master, develop ]
    paths:
      - 'frontend/src/locales/**'
      - 'frontend/src/**/*.tsx'
      - 'frontend/src/**/*.ts'

jobs:
  validate-translations:
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout –∫–æ–¥
      uses: actions/checkout@v3
      
    - name: üîß –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: üì¶ –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π
      working-directory: ./frontend
      run: npm ci
      
    - name: üîç –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø–æ–∫—Ä–∏—Ç—Ç—è –ø–µ—Ä–µ–∫–ª–∞–¥–∞–º–∏
      working-directory: ./frontend
      run: npm run translations:coverage
      
    - name: üîé –°–∫–∞–Ω—É–≤–∞–Ω–Ω—è hardcoded —Ç–µ–∫—Å—Ç—ñ–≤
      working-directory: ./frontend
      run: npm run translations:scan-ui
      continue-on-error: true
      
    - name: üìä –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–≤—ñ—Ç—ñ–≤
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: translation-reports
        path: |
          frontend/src/locales/translation-coverage-report.json
          frontend/src/locales/hardcoded-texts-report.json
          
    - name: üí¨ –ö–æ–º–µ–Ω—Ç–∞—Ä —É PR (—è–∫—â–æ —î –ø—Ä–æ–±–ª–µ–º–∏)
      if: failure() && github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const coveragePath = 'frontend/src/locales/translation-coverage-report.json';
          
          if (fs.existsSync(coveragePath)) {
            const coverage = JSON.parse(fs.readFileSync(coveragePath, 'utf8'));
            
            const comment = `## ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∏ –∑ –ø–µ—Ä–µ–∫–ª–∞–¥–∞–º–∏
            
**–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–∫—Ä–∏—Ç—Ç—è:**
- –í—Å—å–æ–≥–æ –∫–ª—é—á—ñ–≤: ${coverage.coverage.total}
- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è: ${coverage.coverage.used} (${coverage.coverage.percentage}%)
- –í—ñ–¥—Å—É—Ç–Ω—ñ—Ö: ${coverage.coverage.missing}
- –ù–µ–≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–∏—Ö: ${coverage.coverage.unused}

${coverage.coverage.missing > 0 ? '‚ùå –ü–æ—Ç—Ä—ñ–±–Ω–æ –¥–æ–¥–∞—Ç–∏ –≤—ñ–¥—Å—É—Ç–Ω—ñ –∫–ª—é—á—ñ' : ''}
${coverage.coverage.unused > 50 ? '‚ö†Ô∏è –ë–∞–≥–∞—Ç–æ –Ω–µ–≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–∏—Ö –∫–ª—é—á—ñ–≤ - —Ä–æ–∑–≥–ª—è–Ω—å—Ç–µ –æ—á–∏—â–µ–Ω–Ω—è' : ''}

**–í–∏–ø—Ä–∞–≤–∏—Ç–∏:**
\`\`\`bash
cd frontend
npm run translations:add-missing
npm run translations:generate-types
\`\`\`
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
          }
