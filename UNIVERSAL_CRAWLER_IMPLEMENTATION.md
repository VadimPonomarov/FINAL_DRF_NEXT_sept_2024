# –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–≥–æ LLM-based –∫—Ä–∞—É–ª–µ—Ä–∞

## üéØ –ó–∞–¥–∞—á–∞

–°–æ–∑–¥–∞—Ç—å —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∫—Ä–∞—É–ª–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π —Ä–∞–±–æ—Ç–∞–µ—Ç —Å **–õ–Æ–ë–´–ú** —Å–∞–π—Ç–æ–º, –∏—Å–ø–æ–ª—å–∑—É—è **–¢–û–õ–¨–ö–û –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç LLM**, –±–µ–∑ —Ö–∞—Ä–¥–∫–æ–¥–∏–Ω–≥–∞ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤.

## ‚úÖ –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### 1. UniversalCrawlerService (`backend/apps/chat/services/universal_crawler_service.py`)

**–ù–æ–≤—ã–π —Å–µ—Ä–≤–∏—Å** –¥–ª—è —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–≥–æ –∫—Ä–∞—É–ª–∏–Ω–≥–∞ —Å LLM extraction:

- ‚úÖ **JavaScript rendering** —á–µ—Ä–µ–∑ Crawl4AI + Chromium
- ‚úÖ **Auto-scrolling** –¥–ª—è lazy-loading –∫–æ–Ω—Ç–µ–Ω—Ç–∞
- ‚úÖ **Network idle waiting** –¥–ª—è AJAX –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚úÖ **Deep crawling** —Å —Ä–µ–∫—É—Ä—Å–∏–≤–Ω—ã–º –æ–±—Ö–æ–¥–æ–º —Å—Å—ã–ª–æ–∫
- ‚úÖ **LLM-based extraction** - –º–æ–¥–µ–ª—å —Å–∞–º–∞ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç
- ‚úÖ **Automatic table generation** - —Å–æ–∑–¥–∞–Ω–∏–µ —Å—Ç–∏–ª–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü
- ‚úÖ **Flexible schema** - –≥–∏–±–∫–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ **Fallback mechanism** - —Ä–∞–±–æ—Ç–∞ –±–µ–∑ Crawl4AI

### 2. –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π crawler_nodes_refactored.py

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è** —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–≥–æ –∫—Ä–∞—É–ª–µ—Ä–∞:

- ‚úÖ –ò–º–ø–æ—Ä—Ç `universal_crawler_service`
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π `crawl4ai_ask_node` —Å LLM extraction
- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–π LLM –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- ‚úÖ –£–ª—É—á—à–µ–Ω–Ω—ã–µ –ª–æ–≥–∏ –∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ

### 3. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

**–ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è** –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é:

- ‚úÖ `UNIVERSAL_CRAWLER_DOCUMENTATION.md` - –¥–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
- ‚úÖ –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- ‚úÖ Best practices
- ‚úÖ API reference

## üîë –ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

### –ü—Ä–æ—Ü–µ—Å—Å —Ä–∞–±–æ—Ç—ã

```
–ó–∞–ø—Ä–æ—Å ‚Üí LLM –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç deep crawl ‚Üí Crawl4AI —Å JS ‚Üí –ö–æ–Ω—Ç–µ–Ω—Ç ‚Üí LLM –∏–∑–≤–ª–µ–∫–∞–µ—Ç ‚Üí –¢–∞–±–ª–∏—Ü–∞ ‚Üí –û—Ç–≤–µ—Ç
```

### –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ

**–í–º–µ—Å—Ç–æ:**
```python
# Hardcoded patterns
CURRENCY_RATE_PATTERNS = [
    re.compile(r'USD\s*:\s*(\d+\.?\d*)\s*/\s*(\d+\.?\d*)'),
    ...
]
```

**–ò—Å–ø–æ–ª—å–∑—É–µ–º:**
```python
# LLM –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∏ –∏–∑–≤–ª–µ–∫–∞–µ—Ç
extraction_prompt = """
Analyze the content and extract relevant data based on user query.
User Query: {query}
Content: {content}
Return JSON: {{"items": [...], "data_type": "...", "columns": [...]}}
"""
```

### –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ—Å—Ç—å

–†–∞–±–æ—Ç–∞–µ—Ç —Å –õ–Æ–ë–´–ú —Ç–∏–ø–æ–º –¥–∞–Ω–Ω—ã—Ö:
- üí± –ö—É—Ä—Å—ã –≤–∞–ª—é—Ç
- üí∞ –¶–µ–Ω—ã –Ω–∞ —Ç–æ–≤–∞—Ä—ã
- üì∞ –°—Ç–∞—Ç—å–∏ –∏ –Ω–æ–≤–æ—Å—Ç–∏
- üìä –õ—é–±—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

## üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ–¥—Ö–æ–¥–æ–≤

| –ö—Ä–∏—Ç–µ—Ä–∏–π | Hardcoded Patterns | Universal LLM |
|----------|-------------------|---------------|
| –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ—Å—Ç—å | ‚ùå –¢–æ–ª—å–∫–æ –∏–∑–≤–µ—Å—Ç–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã | ‚úÖ –õ—é–±—ã–µ —Å–∞–π—Ç—ã |
| –û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ | ‚ùå –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è | ‚úÖ –ù—É–ª–µ–≤–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ |
| –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å | ‚ùå –õ–æ–º–∞–µ—Ç—Å—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö | ‚úÖ –ê–¥–∞–ø—Ç–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ |
| JavaScript | ‚ö†Ô∏è –û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ | ‚úÖ –ü–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ |
| –ù–æ–≤—ã–µ —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö | ‚ùå –ù—É–∂–µ–Ω –Ω–æ–≤—ã–π –∫–æ–¥ | ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–Ω–∏–º–∞–Ω–∏–µ |

## üöÄ –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

### –ü—Ä–∏–º–µ—Ä: –ö—É—Ä—Å—ã –≤–∞–ª—é—Ç

```python
result = await universal_crawler_service.crawl_with_llm_extraction(
    url="https://kurs.com.ua/ru/gorod/742-zaporoje",
    query="—Å–ø–∞—Ä—Å—å –∫—É—Ä—Å—ã –≤–∞–ª—é—Ç",
    max_depth=2,
    max_links=5
)
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```python
{
    'success': True,
    'extracted_data': {
        'items': [
            {'currency': 'USD', 'buy': '41.50', 'sell': '42.00'},
            {'currency': 'EUR', 'buy': '45.20', 'sell': '46.10'}
        ],
        'data_type': 'currency_rates',
        'summary': '–ò–∑–≤–ª–µ—á–µ–Ω–æ 2 –∫—É—Ä—Å–∞ –≤–∞–ª—é—Ç'
    },
    'table_html': '<table class="table table-striped">...</table>',
    'table_data': [...],
    'total_pages': 1
}
```

### –ß–µ—Ä–µ–∑ —á–∞—Ç–±–æ—Ç

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: —Å–ø–∞—Ä—Å—å –∫—É—Ä—Å—ã –≤–∞–ª—é—Ç —Å https://kurs.com.ua/ru/gorod/742-zaporoje

–ë–æ—Ç: 
üéØ –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å https://kurs.com.ua/...
üìä –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö: currency_rates
‚úÖ –ù–∞–π–¥–µ–Ω–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤: 3

üì¶ –î–∞–Ω–Ω—ã–µ:
‚Ä¢ currency: USD | buy: 41.50 | sell: 42.00
‚Ä¢ currency: EUR | buy: 45.20 | sell: 46.10
‚Ä¢ currency: PLN | buy: 10.25 | sell: 10.55

[–¢–∞–±–ª–∏—Ü–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ TableDisplay]
```

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### Crawl4AI –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

```python
{
    'headless': True,
    'browser_type': 'chromium',
    'page_timeout': 60000,
    'bypass_cache': True,
    'wait_for': 'networkidle',
    'delay_before_return_html': 3.0,
    'js_code': AUTO_SCROLL_JS  # –ê–≤—Ç–æ—Å–∫—Ä–æ–ª–ª–∏–Ω–≥
}
```

### LLM –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

```python
# –ò–∑ llm_config.py
task='classification'  # –¢–æ—á–Ω–∞—è –º–æ–¥–µ–ª—å
model='gpt-4o-mini'
temperature=0.1  # –î–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç—å
max_tokens=1500
```

### JavaScript –¥–ª—è dynamic content

```javascript
async function waitForContent() {
    // –ñ–¥–µ–º —Å–µ—Ç–µ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã
    await new Promise(resolve => setTimeout(resolve, 2000));
    
    // –ê–≤—Ç–æ—Å–∫—Ä–æ–ª–ª–∏–Ω–≥ –¥–ª—è lazy-loading
    await new Promise((resolve) => {
        let totalHeight = 0;
        const distance = 100;
        const timer = setInterval(() => {
            window.scrollBy(0, distance);
            totalHeight += distance;
            
            if (totalHeight >= document.body.scrollHeight) {
                clearInterval(timer);
                setTimeout(resolve, 1000);
            }
        }, 100);
    });
}
```

## üìù –ß—Ç–æ —É–¥–∞–ª–µ–Ω–æ/–∑–∞–º–µ–Ω–µ–Ω–æ

### ‚ùå –£–¥–∞–ª–µ–Ω–æ (hardcoded patterns)

- `CURRENCY_RATE_PATTERNS` –≤ `patterns.py` - –∑–∞–º–µ–Ω–µ–Ω–æ LLM
- `currency_parser_service` - –∑–∞–º–µ–Ω–µ–Ω–æ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–º extraction
- `price_parser_service` - –∑–∞–º–µ–Ω–µ–Ω–æ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–º extraction
- `_is_currency_query()` - LLM —Å–∞–º–∞ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø
- Hardcoded keywords –≤ `DEEP_CRAWL_CONFIG`

### ‚úÖ –ó–∞–º–µ–Ω–µ–Ω–æ –Ω–∞

- `UniversalCrawlerService` - —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å
- `_extract_with_llm()` - LLM extraction
- `_format_as_table()` - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç–∞–±–ª–∏—Ü—ã
- `_needs_deep_crawl()` - LLM detection

## üéì –ü—Ä–∏–Ω—Ü–∏–ø—ã –¥–∏–∑–∞–π–Ω–∞

1. **AI-First**: LLM - –æ—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç, –Ω–µ fallback
2. **No Hardcoding**: –ù–∏–∫–∞–∫–∏—Ö —Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö –≤—ã—Ä–∞–∂–µ–Ω–∏–π –¥–ª—è –¥–∞–Ω–Ω—ã—Ö
3. **Context-Aware**: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
4. **Fail-Safe**: Graceful fallback –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
5. **Observable**: –ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞

## üìà –ú–µ—Ç—Ä–∏–∫–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

```python
# –õ–æ–≥–∏
logger.info("üöÄ –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∫—Ä–∞—É–ª–∏–Ω–≥: {url}")
logger.info("ü§ñ LLM –∏–∑–≤–ª–µ–∫–ª–æ {items} —ç–ª–µ–º–µ–Ω—Ç–æ–≤")
logger.info("üìä –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö: {data_type}")

# –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
metadata = {
    "crawl_method": "universal_llm",
    "total_pages": 3,
    "items_found": 15,
    "data_type": "currency_rates",
    "universal_extraction": True
}
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ü–ª–∞–Ω —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

1. ‚úÖ –°–æ–∑–¥–∞–Ω —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å
2. ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –≤ crawler nodes
3. üîÑ –¢–µ—Å—Ç –Ω–∞ kurs.com.ua (IN PROGRESS)
4. ‚è≥ –¢–µ—Å—Ç –Ω–∞ rozetka.com.ua
5. ‚è≥ –¢–µ—Å—Ç –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã—Ö —Å–∞–π—Ç–∞—Ö

### –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

- –ö—É—Ä—Å—ã –≤–∞–ª—é—Ç –∏–∑–≤–ª–µ–∫–∞—é—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü—É
- –¢–∞–±–ª–∏—Ü–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ TableDisplay
- –ù–∏–∫–∞–∫–∏—Ö hardcoded –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
- –†–∞–±–æ—Ç–∞–µ—Ç —Å JavaScript-—Å–∞–π—Ç–∞–º–∏

## üîÆ –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

1. **Streaming extraction** - –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–∞—è –≤—ã–¥–∞—á–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
2. **Multi-language support** - –∞–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —è–∑—ã–∫–∞
3. **Image extraction** - –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
4. **PDF support** - –ø–∞—Ä—Å–∏–Ω–≥ PDF –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
5. **API mode** - –ø—Ä—è–º–æ–π API endpoint –¥–ª—è –∫—Ä–∞—É–ª–∏–Ω–≥–∞

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- `backend/apps/chat/services/UNIVERSAL_CRAWLER_DOCUMENTATION.md` - –ø–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- `backend/apps/chat/services/universal_crawler_service.py` - –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥
- `backend/apps/chat/nodes/crawler_nodes_refactored.py` - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

## üéâ –ò—Ç–æ–≥

–°–æ–∑–¥–∞–Ω **—Ä–µ–≤–æ–ª—é—Ü–∏–æ–Ω–Ω—ã–π —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∫—Ä–∞—É–ª–µ—Ä**:
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç —Å –õ–Æ–ë–´–ú–ò —Å–∞–π—Ç–∞–º–∏
- ‚úÖ –ü–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ JavaScript
- ‚úÖ –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–µ LLM –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ –ù—É–ª–µ–≤–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ
- ‚úÖ –ë–µ–∑ —Ö–∞—Ä–¥–∫–æ–¥–∏–Ω–≥–∞

**–§–∏–ª–æ—Å–æ—Ñ–∏—è**: "–ü—É—Å—Ç—å AI –¥–µ–ª–∞–µ—Ç —Ç–æ, —á—Ç–æ —É–º–µ–µ—Ç –ª—É—á—à–µ –≤—Å–µ–≥–æ - –ø–æ–Ω–∏–º–∞—Ç—å –∏ –∏–∑–≤–ª–µ–∫–∞—Ç—å –¥–∞–Ω–Ω—ã–µ"

