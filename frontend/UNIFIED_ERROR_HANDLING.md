# üîß –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### 1. **UnifiedAuthErrorHandler** (`utils/auth/unifiedAuthErrorHandler.ts`)
–°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –æ—à–∏–±–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ 401/4001.

**–ê–ª–≥–æ—Ä–∏—Ç–º —Ä–∞–±–æ—Ç—ã:**
```
1. –ü–æ–ª—É—á–∏–ª–∏ 401/4001
   ‚Üì
2. –ü—Ä–æ–≤–µ—Ä—è–µ–º refresh —Ç–æ–∫–µ–Ω –≤ Redis
   ‚Üì
3. –ï—Å–ª–∏ –µ—Å—Ç—å ‚Üí –¥–µ–ª–∞–µ–º refresh (–Ω–æ–≤—ã–µ —Ç–æ–∫–µ–Ω—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ Redis)
   ‚Üì
4. Retry –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
   ‚Üì
5. –ï—Å–ª–∏ —Å–Ω–æ–≤–∞ 401 –∏–ª–∏ refresh –≤–µ—Ä–Ω—É–ª 403 ‚Üí —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ –ª–æ–≥–∏–Ω —Å toast
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```typescript
import { unifiedAuthErrorHandler } from '@/utils/auth/unifiedAuthErrorHandler';

// –î–ª—è HTTP
await unifiedAuthErrorHandler.handleAuthError({
  retryRequest: () => fetch(...),
  source: 'MyComponent',
  currentPath: window.location.pathname,
  showToast: true
});

// –î–ª—è WebSocket
const canReconnect = await unifiedAuthErrorHandler.handleWebSocketAuthError({
  source: 'WebSocket',
  showToast: true
});
```

---

### 2. **UnifiedErrorHandler** (`utils/errors/unifiedErrorHandler.ts`)
–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è **–í–°–ï–•** —Ç–∏–ø–æ–≤ –æ—à–∏–±–æ–∫.

**–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ç–∏–ø—ã –æ—à–∏–±–æ–∫:**

| –¢–∏–ø | HTTP –∫–æ–¥—ã | WebSocket –∫–æ–¥—ã | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----|-----------|----------------|----------|
| `UNAUTHORIZED` | 401 | 4001, 1008 | –¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è |
| `FORBIDDEN` | 403 | 4003 | –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω |
| `NOT_FOUND` | 404 | - | –†–µ—Å—É—Ä—Å –Ω–µ –Ω–∞–π–¥–µ–Ω |
| `BAD_REQUEST` | 400 | - | –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∑–∞–ø—Ä–æ—Å |
| `VALIDATION_ERROR` | 422 | - | –û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ |
| `SERVER_ERROR` | 500-599 | - | –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ |
| `NETWORK_ERROR` | - | 1006 | –ü—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ç—å—é |
| `TIMEOUT` | 408 | - | –ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è |

**–§—É–Ω–∫—Ü–∏–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏:**

#### HTTP –æ—à–∏–±–∫–∏
```typescript
import { unifiedErrorHandler } from '@/utils/errors/unifiedErrorHandler';

const result = await unifiedErrorHandler.handleHttpError(response, {
  retryCallback: makeRequest,
  source: 'MyComponent',
  showToast: true,
  maxRetries: 2
});

if (result.retryResult) {
  // Retry —É—Å–ø–µ—à–µ–Ω
  return result.retryResult;
}
```

#### WebSocket –æ—à–∏–±–∫–∏
```typescript
import { handleWebSocketClose } from '@/utils/errors/unifiedErrorHandler';

socket.onclose = async (event) => {
  const canReconnect = await handleWebSocketClose(event, {
    source: 'ChatBot',
    showToast: true
  });
  
  if (canReconnect) {
    // –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è
  }
};
```

#### –°–µ—Ç–µ–≤—ã–µ –æ—à–∏–±–∫–∏
```typescript
import { handleNetworkError } from '@/utils/errors/unifiedErrorHandler';

try {
  await fetch(...);
} catch (error) {
  await handleNetworkError(error, {
    source: 'MyComponent',
    showToast: true
  });
}
```

---

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –ø—Ä–æ–µ–∫—Ç

### 1. **fetchWithAuth** (`utils/fetchWithAuth.ts`)
–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –í–°–ï –æ—à–∏–±–∫–∏:
- 401 ‚Üí refresh —Ç–æ–∫–µ–Ω–æ–≤ + retry
- 403 ‚Üí toast "–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω"
- 404 ‚Üí toast "–ù–µ –Ω–∞–π–¥–µ–Ω–æ"
- 500/502/503 ‚Üí toast "–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞" + retry (–¥–æ 2 —Ä–∞–∑)
- Network errors ‚Üí toast "–ü—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ç—å—é"

```typescript
import { fetchWithAuth } from '@/utils/fetchWithAuth';

const response = await fetchWithAuth('/api/autoria/favorites/toggle', {
  method: 'POST',
  body: JSON.stringify({ car_ad_id })
});
// –í—Å–µ –æ—à–∏–±–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è!
```

### 2. **ApiClient** (`services/api/apiClient.ts`)
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤:

```typescript
import { apiClient } from '@/services/api/apiClient';

try {
  const data = await apiClient.get('/api/ads/cars');
  // –í—Å–µ –æ—à–∏–±–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è
} catch (error) {
  // –û—à–∏–±–∫–∞ —É–∂–µ –ø–æ–∫–∞–∑–∞–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —á–µ—Ä–µ–∑ toast
  console.error(error);
}
```

### 3. **useChatWebSocket** (`components/ChatBot/hooks/useChatWebSocket.ts`)
–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –í–°–ï –∫–æ–¥—ã –∑–∞–∫—Ä—ã—Ç–∏—è WebSocket:

```typescript
socket.onclose = async (event) => {
  const canReconnect = await handleWebSocketClose(event, {
    source: 'ChatBot WebSocket',
    showToast: true
  });
  
  if (canReconnect) {
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è
    setTimeout(() => connect(), 1000);
  }
};
```

---

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

### ‚úÖ –ï–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏
–í—Å–µ –æ—à–∏–±–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω–æ —á–µ—Ä–µ–∑ `unifiedErrorHandler`.

### ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry
- 401 ‚Üí refresh —Ç–æ–∫–µ–Ω–æ–≤ + retry
- 500/502/503 ‚Üí retry –¥–æ 2 —Ä–∞–∑
- 408 (timeout) ‚Üí –ø–æ–∫–∞–∑–∞—Ç—å toast

### ‚úÖ –£–º–Ω—ã–µ toast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
–ö–∞–∂–¥—ã–π —Ç–∏–ø –æ—à–∏–±–∫–∏ –∏–º–µ–µ—Ç —Å–≤–æ–π:
- –ò–∫–æ–Ω–∫—É (üîí, ‚õî, üîç, ‚ùå, ‚ö†Ô∏è, üî•, üì°, ‚è±Ô∏è)
- –ó–∞–≥–æ–ª–æ–≤–æ–∫
- –û–ø–∏—Å–∞–Ω–∏–µ
- Variant (default/destructive)

### ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- 401 ‚Üí –ø—Ä–æ–≤–µ—Ä–∫–∞ refresh —Ç–æ–∫–µ–Ω–∞ –≤ Redis
- 403 (refresh failed) ‚Üí —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ –ª–æ–≥–∏–Ω
- –ó–∞—â–∏—Ç–∞ –æ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–π —Ä–µ–∫—É—Ä—Å–∏–∏ —á–µ—Ä–µ–∑ `skipRetry`

### ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
–í—Å–µ –æ—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫–∞ (`source`).

---

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ü—Ä–∏–º–µ—Ä 1: –û–±—Ä–∞–±–æ—Ç–∫–∞ 401 –≤ fetch
```typescript
const response = await fetchWithAuth('/api/protected-resource');
// 1. –ï—Å–ª–∏ 401 ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ refresh —Ç–æ–∫–µ–Ω–æ–≤
// 2. Retry –∑–∞–ø—Ä–æ—Å–∞ —Å –Ω–æ–≤—ã–º —Ç–æ–∫–µ–Ω–æ–º
// 3. –ï—Å–ª–∏ —Å–Ω–æ–≤–∞ 401 ‚Üí —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ –ª–æ–≥–∏–Ω —Å toast
```

### –ü—Ä–∏–º–µ—Ä 2: –û–±—Ä–∞–±–æ—Ç–∫–∞ 500 –≤ ApiClient
```typescript
const data = await apiClient.post('/api/ads/create', adData);
// 1. –ï—Å–ª–∏ 500 ‚Üí toast "–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞"
// 2. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry (–¥–æ 2 —Ä–∞–∑)
// 3. –ï—Å–ª–∏ –≤—Å–µ retry –Ω–µ—É—Å–ø–µ—à–Ω—ã ‚Üí –≤—ã–±—Ä–æ—Å –æ—à–∏–±–∫–∏
```

### –ü—Ä–∏–º–µ—Ä 3: –û–±—Ä–∞–±–æ—Ç–∫–∞ 4001 –≤ WebSocket
```typescript
socket.onclose = async (event) => {
  if (event.code === 4001) {
    // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ refresh —Ç–æ–∫–µ–Ω–∞ –≤ Redis
    // 2. Refresh —Ç–æ–∫–µ–Ω–æ–≤
    // 3. –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å –Ω–æ–≤—ã–º —Ç–æ–∫–µ–Ω–æ–º
  }
};
```

### –ü—Ä–∏–º–µ—Ä 4: –û–±—Ä–∞–±–æ—Ç–∫–∞ network error
```typescript
try {
  await fetch(...);
} catch (error) {
  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è toast "–ü—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ç—å—é"
  await handleNetworkError(error);
}
```

---

## –¢–∞–±–ª–∏—Ü–∞ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ –æ—à–∏–±–æ–∫

| –ö–æ–¥ –æ—à–∏–±–∫–∏ | –û–±—Ä–∞–±–æ—Ç—á–∏–∫ | –î–µ–π—Å—Ç–≤–∏–µ | Toast | Retry | Redirect |
|------------|------------|----------|-------|-------|----------|
| 401 | `unifiedAuthErrorHandler` | Refresh + retry | ‚úÖ | ‚úÖ | –ï—Å–ª–∏ failed |
| 403 | `unifiedErrorHandler` | Toast | ‚úÖ | ‚ùå | ‚ùå |
| 404 | `unifiedErrorHandler` | Toast | ‚úÖ | ‚ùå | ‚ùå |
| 400 | `unifiedErrorHandler` | Toast | ‚úÖ | ‚ùå | ‚ùå |
| 422 | `unifiedErrorHandler` | Toast | ‚úÖ | ‚ùå | ‚ùå |
| 408 | `unifiedErrorHandler` | Toast | ‚úÖ | ‚úÖ | ‚ùå |
| 500-599 | `unifiedErrorHandler` | Toast + retry | ‚úÖ | ‚úÖ (2x) | ‚ùå |
| Network | `unifiedErrorHandler` | Toast | ‚úÖ | ‚ùå | ‚ùå |
| 4001 (WS) | `unifiedAuthErrorHandler` | Refresh + reconnect | ‚úÖ | ‚úÖ | –ï—Å–ª–∏ failed |
| 1006 (WS) | `unifiedErrorHandler` | Toast | ‚úÖ | ‚úÖ | ‚ùå |

---

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ retry
```typescript
// –í fetchWithAuth
maxRetries: resp.status >= 500 ? 2 : 1

// –í ApiClient
maxRetries: response.status >= 500 ? 2 : 1
```

### –ó–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ retry
```typescript
// –í unifiedErrorHandler.handleHttpError
await new Promise(resolve => setTimeout(resolve, 1000)); // 1 —Å–µ–∫—É–Ω–¥–∞
```

### Timeout –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤
```typescript
// –í ApiClient
this.timeout = options.timeout || 15000; // 15 —Å–µ–∫—É–Ω–¥
```

---

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç 1: 401 –æ–±—Ä–∞–±–æ—Ç–∫–∞
1. –û—Ç–∫—Ä—ã—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –º–æ–¥–µ—Ä–∞—Ü–∏–∏
2. –ò—Å—Ç–µ—á—å access —Ç–æ–∫–µ–Ω (—É–¥–∞–ª–∏—Ç—å –∏–∑ Redis)
3. –°–¥–µ–ª–∞—Ç—å –∑–∞–ø—Ä–æ—Å ‚Üí –¥–æ–ª–∂–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ refresh ‚Üí retry ‚Üí —É—Å–ø–µ—Ö

### –¢–µ—Å—Ç 2: 500 –æ–±—Ä–∞–±–æ—Ç–∫–∞
1. –í—ã–∫–ª—é—á–∏—Ç—å backend
2. –°–¥–µ–ª–∞—Ç—å –∑–∞–ø—Ä–æ—Å ‚Üí –¥–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑–∞—Ç—å toast "–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞"
3. Retry 2 —Ä–∞–∑–∞ ‚Üí –µ—Å–ª–∏ –Ω–µ—É—Å–ø–µ—à–Ω–æ, –≤—ã–±—Ä–æ—Å –æ—à–∏–±–∫–∏

### –¢–µ—Å—Ç 3: 4001 WebSocket
1. –û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç-–±–æ—Ç
2. –ò—Å—Ç–µ—á—å access —Ç–æ–∫–µ–Ω
3. WebSocket –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è —Å –∫–æ–¥–æ–º 4001
4. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ refresh ‚Üí –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ

### –¢–µ—Å—Ç 4: Network error
1. –û—Ç–∫–ª—é—á–∏—Ç—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç
2. –°–¥–µ–ª–∞—Ç—å –∑–∞–ø—Ä–æ—Å ‚Üí –¥–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑–∞—Ç—å toast "–ü—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ç—å—é"

---

## –ú–∏–≥—Ä–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∫–æ–¥–∞

### –î–æ:
```typescript
const response = await fetch(...);
if (response.status === 401) {
  // –†—É—á–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ 401
  await refreshTokens();
  const retry = await fetch(...);
}
```

### –ü–æ—Å–ª–µ:
```typescript
const response = await fetchWithAuth(...);
// –í—Å—ë –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!
```

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç:
- **–ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å**: –≤—Å–µ –æ—à–∏–±–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –æ–¥–∏–Ω–∞–∫–æ–≤–æ
- **–£–¥–æ–±—Å—Ç–≤–æ**: –Ω–µ –Ω—É–∂–Ω–æ –ø–∏—Å–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤ –∫–∞–∂–¥–æ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ
- **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π refresh —Ç–æ–∫–µ–Ω–æ–≤ –ø—Ä–∏ 401
- **UX**: –ø–æ–Ω—è—Ç–Ω—ã–µ toast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å**: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ—à–∏–±–æ–∫

–í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –ø—Ä–æ–µ–∫—Ç–∞ —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É—é—Ç –µ–¥–∏–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫! üéâ

