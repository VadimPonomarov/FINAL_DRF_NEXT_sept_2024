# –£–ª—É—á—à–µ–Ω–∏—è –º–µ—Ö–∞–Ω–∏–∑–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —Å Refresh Token

## üìã –û–±–∑–æ—Ä

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω —É—Å–æ–≤–µ—Ä—à–µ–Ω—Å—Ç–≤–æ–≤–∞–Ω–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —Å refresh token'–∞–º–∏, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—â–∏–π –Ω–∞–¥–µ–∂–Ω–æ–µ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏—è–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.

## ‚ú® –ö–ª—é—á–µ–≤—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### 1. **–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π Refresh –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ Refresh Token**
- ‚úÖ –ü–µ—Ä–µ–¥ –ª—é–±—ã–º —Ä–µ–¥–∏—Ä–µ–∫—Ç–æ–º –Ω–∞ login –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –Ω–∞–ª–∏—á–∏–µ refresh token –≤ Redis
- ‚úÖ –ï—Å–ª–∏ refresh token —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ–ø—ã—Ç–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
- ‚úÖ –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ login –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ refresh –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω –∏–ª–∏ –Ω–µ—É—Å–ø–µ—à–µ–Ω

### 2. **–ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ –ø–æ—Å–ª–µ Refresh**
- ‚úÖ –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ refresh –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–æ–≤—ã–π access token –¥–ª—è WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å —á–µ—Ä–µ–∑ toast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

### 3. **–ó–∞—â–∏—Ç–∞ –æ—Ç –±—ã—Å—Ç—Ä—ã—Ö –ø—Ä–æ—Å–∫–æ–∫–æ–≤ (Rate Limiting)**
- ‚úÖ **MIN_REFRESH_DELAY = 2000ms** - –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É refresh –ø–æ–ø—ã—Ç–∫–∞–º–∏
- ‚úÖ **MIN_CONNECTION_DELAY = 1000ms** - –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
- ‚úÖ –¢–∞–π–º—Å—Ç–∞–º–ø—ã –æ—Ç—Å–ª–µ–∂–∏–≤–∞—é—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ –ø–æ–ø—ã—Ç–∫–∏ –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è —á–∞—Å—Ç–æ—Ç—ã

### 4. **–£–º–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏**
- ‚úÖ WebSocket –æ—à–∏–±–∫–∏ 1008 –∏ 4001 –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ç—Ä–∏–≥–≥–µ—Ä—è—Ç refresh
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã —Ç–∞–π–º–∞—É—Ç—ã –ø–µ—Ä–µ–¥ –∏ –ø–æ—Å–ª–µ refresh (1s + 1.5s) –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
- ‚úÖ –î–æ 3 –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –ø–æ–ø—ã—Ç–æ–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

```typescript
const MAX_TOKEN_REFRESH_ATTEMPTS = 3;      // –ú–∞–∫—Å–∏–º—É–º –ø–æ–ø—ã—Ç–æ–∫ refresh
const MIN_REFRESH_DELAY = 2000;            // 2 —Å–µ–∫—É–Ω–¥—ã –º–µ–∂–¥—É refresh
const MIN_CONNECTION_DELAY = 1000;         // 1 —Å–µ–∫—É–Ω–¥–∞ –º–µ–∂–¥—É –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è–º–∏
```

### –ù–æ–≤—ã–µ ref –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ

```typescript
const lastRefreshAttemptRef = useRef<number>(0);       // –¢–∞–π–º—Å—Ç–∞–º–ø –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ refresh
const lastConnectionAttemptRef = useRef<number>(0);    // –¢–∞–π–º—Å—Ç–∞–º–ø –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
const isRefreshingRef = useRef<boolean>(false);        // –§–ª–∞–≥ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ refresh
```

### –ü—Ä–æ—Ü–µ—Å—Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞

```
1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏ (MIN_REFRESH_DELAY)
   ‚Üì
2. –û–∂–∏–¥–∞–Ω–∏–µ –µ—Å–ª–∏ –¥—Ä—É–≥–æ–π refresh –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ (isRefreshingRef)
   ‚Üì
3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è refresh token –≤ Redis (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û)
   ‚Üì
4. –ï—Å–ª–∏ refresh token –µ—Å—Ç—å ‚Üí –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ refresh
   ‚Üì
5. –¢–∞–π–º–∞—É—Ç 500ms –ø–µ—Ä–µ–¥ refresh (–∑–∞—â–∏—Ç–∞ –æ—Ç –ø—Ä–æ—Å–∫–æ–∫–æ–≤)
   ‚Üì
6. –ó–∞–ø—Ä–æ—Å –Ω–∞ /api/auth/refresh
   ‚Üì
7. –¢–∞–π–º–∞—É—Ç 800ms –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ refresh
   ‚Üì
8. –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —Å –Ω–æ–≤—ã–º —Ç–æ–∫–µ–Ω–æ–º
```

### –û–±—Ä–∞–±–æ—Ç–∫–∞ WebSocket –æ—à–∏–±–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

```
WebSocket –∑–∞–∫—Ä—ã—Ç —Å –∫–æ–¥–æ–º 1008/4001
   ‚Üì
Toast: "Refreshing authentication token..."
   ‚Üì
–¢–∞–π–º–∞—É—Ç 1000ms (–∑–∞—â–∏—Ç–∞ –æ—Ç –ø—Ä–æ—Å–∫–æ–∫–æ–≤)
   ‚Üì
getAccessToken(true) - –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π refresh
   ‚Üì
–£—Å–ø–µ—Ö? ‚Üí –¢–∞–π–º–∞—É—Ç 1500ms ‚Üí –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
   |
   –ù–µ—É–¥–∞—á–∞ ‚Üí –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ /login
```

## üéØ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

1. **–ë–µ—Å—à–æ–≤–Ω—ã–π UX**
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–∞–º–µ—á–∞–µ—Ç –∏—Å—Ç–µ—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏
   - –ß–µ—Ç–∫–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å—Ç–∞—Ç—É—Å–µ

2. **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å**
   - –ó–∞—â–∏—Ç–∞ –æ—Ç race conditions —á–µ—Ä–µ–∑ —Ñ–ª–∞–≥–∏
   - –ö–æ–Ω—Ç—Ä–æ–ª—å —á–∞—Å—Ç–æ—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤
   - –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–º backoff

3. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**
   - –û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ refresh token –ø–µ—Ä–µ–¥ refresh
   - –¢–∞–π–º–∞—É—Ç—ã –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—é—Ç DDoS —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ API
   - –ß–∏—Å—Ç–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏ –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–∫–∞—Ö

4. **–û—Ç–ª–∞–¥–∫–∞**
   - –ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —ç—Ç–∞–ø–æ–≤
   - Toast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - –≠–º–æ–¥–∑–∏ –º–∞—Ä–∫–µ—Ä—ã –≤ –ª–æ–≥–∞—Ö –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏

## üìä –°—Ü–µ–Ω–∞—Ä–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: Access token –∏—Å—Ç–µ–∫
1. –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ WebSocket
2. –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –∏–∑ Redis ‚Üí —Ç–æ–∫–µ–Ω –∏—Å—Ç–µ–∫
3. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π refresh —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
4. –£—Å–ø–µ—à–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å –Ω–æ–≤—ã–º —Ç–æ–∫–µ–Ω–æ–º

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: WebSocket –æ—à–∏–±–∫–∞ 401
1. WebSocket –∑–∞–∫—Ä—ã—Ç —Å –∫–æ–¥–æ–º 1008
2. –¢–∞–π–º–∞—É—Ç 1s
3. –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π refresh
4. –¢–∞–π–º–∞—É—Ç 1.5s
5. –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –ù–µ—Ç refresh token
1. –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
2. –ü—Ä–æ–≤–µ—Ä–∫–∞ Redis ‚Üí refresh token –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
3. –ù–µ–º–µ–¥–ª–µ–Ω–Ω—ã–π —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ /login
4. –ù–ï–¢ –±–µ—Å–ø–æ–ª–µ–∑–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ refresh

## üîç –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–í—Å–µ –∫–ª—é—á–µ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —Å —ç–º–æ–¥–∑–∏ –º–∞—Ä–∫–µ—Ä–∞–º–∏:

- ‚è±Ô∏è - Rate limiting / —Ç–∞–π–º–∞—É—Ç—ã
- üîÑ - Refresh –æ–ø–µ—Ä–∞—Ü–∏–∏
- ‚úÖ - –£—Å–ø–µ—à–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
- ‚ùå - –û—à–∏–±–∫–∏
- ‚ö†Ô∏è - –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

–ü—Ä–∏–º–µ—Ä –ª–æ–≥–∞:
```
‚è±Ô∏è Rate limiting: waiting 1500ms before next refresh attempt
üîÑ Refresh token found - attempting refresh (mandatory)
‚úÖ Token refreshed successfully after auth error, reconnecting...
üîÑ Retrying connection with new token after delay...
```

## üöÄ –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

- [ ] –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ refresh
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å adaptive backoff –Ω–∞ –æ—Å–Ω–æ–≤–µ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ –ø–æ–ø—ã—Ç–æ–∫
- [ ] –î–æ–±–∞–≤–∏—Ç—å offline detection –¥–ª—è –ø–∞—É–∑—ã refresh –ø–æ–ø—ã—Ç–æ–∫
- [ ] –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ

## üìù –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

- `frontend/src/components/ChatBot/hooks/useChatWebSocket.ts` - –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞
- `frontend/src/services/redis/redisService.ts` - Redis –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
- `backend/apps/accounts/views.py` - Backend refresh endpoint

---

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è**: 2025-01-23  
**–í–µ—Ä—Å–∏—è**: 1.0  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ Implemented & Tested


