# Периодические задачи Celery

В проекте настроены периодические задачи Celery для автоматического обслуживания системы.

## Настроенные задачи

### 1. Очистка временных медиа-файлов

**Задача**: `clean_generated_media`
**Расписание**: Еженедельно (воскресенье в 3:00 UTC)
**Описание**: Удаляет файлы из директории `backend/generated_media`, которые старше 7 дней. Эта директория используется библиотекой `g4f` для временного хранения сгенерированных изображений.

### 2. Очистка устаревших токенов

**Задача**: `clean_blacklisted_tokens`
**Расписание**: Ежедневно (в 2:00 UTC)
**Описание**: Удаляет действительно просроченные токены из базы данных в три этапа:

1. Сначала проверяет каждый токен в таблице `OutstandingToken`, декодируя JWT и проверяя поле `exp` в пайлоаде
2. Затем удаляет записи из таблицы `BlacklistedToken` для токенов, которые действительно просрочены
3. Наконец, удаляет записи из таблицы `OutstandingToken` для просроченных токенов

Преимущества этого подхода:
- Удаляются только действительно просроченные токены, а не по фиксированному времени
- Сохраняется целостность базы данных благодаря правильному порядку удаления
- Добавлен запас безопасности (7 дней) для предотвращения удаления токенов, которые могут еще понадобиться

## Ручной запуск задач

Для ручного запуска задач можно использовать следующие команды:

```bash
# Очистка временных медиа-файлов
celery -A config call clean_generated_media

# Очистка устаревших токенов
celery -A config call clean_blacklisted_tokens
```

## Мониторинг задач

Для мониторинга выполнения задач можно использовать Flower:

```bash
celery -A config flower
```

Flower будет доступен по адресу: http://localhost:5555

## Настройка расписания

Расписание задач настроено в файле `backend/config/celery.py`. Для изменения расписания отредактируйте секцию `app.conf.beat_schedule`.

## Логирование

Информация о выполнении задач записывается в логи приложения с использованием `loguru`. Проверьте файлы логов для получения информации о выполнении задач.
