"""
Django filters for AutoRia ads application.
Provides comprehensive filtering capabilities for car advertisements and related models.
"""

import django_filters
from django.db import models
from django.utils.translation import gettext_lazy as _

from apps.ads.models import (
    CarAd, CarMarkModel, CarColorModel, RegionModel, CityModel,
    CarModel, CarGenerationModel, CarModificationModel
)
from core.enums.cars import SellerType, ExchangeStatus, Currency
from core.enums.ads import AdStatusEnum


class CarAdFilter(django_filters.FilterSet):
    """
    Comprehensive filter for car advertisements.
    
    Supports filtering by:
    - Basic fields (price, year, mileage)
    - Location (region, city)
    - Car specifications (mark, model, color)
    - Status fields (validation, seller type)
    - Date ranges
    - Text search
    """
    
    # Price filters with currency support
    price_min = django_filters.NumberFilter(
        method='filter_price_min',
        help_text=_('Minimum price')
    )
    price_max = django_filters.NumberFilter(
        method='filter_price_max',
        help_text=_('Maximum price')
    )
    price_currency = django_filters.CharFilter(
        method='filter_price_currency',
        help_text=_('Price currency (USD, EUR, UAH)')
    )
    price_range = django_filters.RangeFilter(
        field_name='price',
        help_text=_('Price range (min,max)')
    )
    
    # Currency filter with dropdown
    currency = django_filters.ChoiceFilter(
        choices=[
            ('USD', 'US Dollar'),
            ('EUR', 'Euro'),
            ('UAH', 'Ukrainian Hryvnia'),
        ],
        help_text=_('Currency'),
        empty_label="Any currency"
    )

    # Seller type filter with dropdown
    seller_type = django_filters.ChoiceFilter(
        choices=[
            ('private', 'Private seller'),
            ('dealer', 'Car dealer'),
            ('company', 'Company'),
        ],
        help_text=_('Type of seller'),
        empty_label="Any seller type"
    )

    # Exchange status filter with dropdown
    exchange_status = django_filters.ChoiceFilter(
        choices=[
            ('no_exchange', 'No exchange'),
            ('possible', 'Exchange possible'),
            ('only_exchange', 'Only exchange'),
        ],
        help_text=_('Exchange status'),
        empty_label="Any exchange status"
    )

    # Ad status filter with dropdown
    status = django_filters.ChoiceFilter(
        choices=AdStatusEnum.choices,
        help_text=_('Advertisement status'),
        empty_label="Any status"
    )
    
    # Location filters - –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º –∫–∞–∫ ID, —Ç–∞–∫ –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ
    region = django_filters.CharFilter(
        method='filter_region',
        help_text=_('Region (ID or name)')
    )
    city = django_filters.CharFilter(
        method='filter_city',
        help_text=_('City (ID or name)')
    )
    
    # Car specification filters with dropdowns
    mark = django_filters.CharFilter(
        method='filter_dynamic_field_exact',
        help_text=_('Car mark/brand')
    )
    model = django_filters.CharFilter(
        field_name='model',
        lookup_expr='icontains',
        help_text=_('Car model'),
    )

    # Vehicle type filter (stored in dynamic_fields)
    vehicle_type = django_filters.CharFilter(
        method='filter_dynamic_field_exact',
        help_text=_('Vehicle type')
    )
    
    # Dynamic fields filters (from JSON field) - —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å ViewSet
    year_from = django_filters.NumberFilter(
        method='filter_dynamic_field_gte',
        help_text=_('Minimum year')
    )
    year_to = django_filters.NumberFilter(
        method='filter_dynamic_field_lte',
        help_text=_('Maximum year')
    )
    mileage_from = django_filters.NumberFilter(
        method='filter_dynamic_field_gte',
        help_text=_('Minimum mileage')
    )
    mileage_to = django_filters.NumberFilter(
        method='filter_dynamic_field_lte',
        help_text=_('Maximum mileage')
    )
    engine_volume_min = django_filters.NumberFilter(
        method='filter_dynamic_field_gte',
        help_text=_('Minimum engine volume')
    )
    engine_volume_max = django_filters.NumberFilter(
        method='filter_dynamic_field_lte',
        help_text=_('Maximum engine volume')
    )
    
    fuel_type = django_filters.CharFilter(
        method='filter_dynamic_field_exact',
        help_text=_('Fuel type')
    )
    transmission = django_filters.CharFilter(
        method='filter_dynamic_field_exact',
        help_text=_('Transmission type')
    )
    body_type = django_filters.CharFilter(
        method='filter_dynamic_field_exact',
        help_text=_('Body type')
    )
    color = django_filters.CharFilter(
        method='filter_dynamic_field_exact',
        help_text=_('Car color')
    )
    condition = django_filters.CharFilter(
        method='filter_dynamic_field_exact',
        help_text=_('Car condition')
    )
    
    # –£–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã - –æ–Ω–∏ —É–∂–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –≤—ã—à–µ (—Å—Ç—Ä–æ–∫–∏ 61-80)
    is_validated = django_filters.BooleanFilter(
        help_text=_('Validation status')
    )
    
    # Date filters
    created_after = django_filters.DateTimeFilter(
        field_name='created_at',
        lookup_expr='gte',
        help_text=_('Created after date')
    )
    created_before = django_filters.DateTimeFilter(
        field_name='created_at',
        lookup_expr='lte',
        help_text=_('Created before date')
    )
    updated_after = django_filters.DateTimeFilter(
        field_name='updated_at',
        lookup_expr='gte',
        help_text=_('Updated after date')
    )
    
    # Text search filters
    search = django_filters.CharFilter(
        method='filter_search',
        help_text=_('Search in title and description')
    )
    title_contains = django_filters.CharFilter(
        field_name='title',
        lookup_expr='icontains',
        help_text=_('Title contains text')
    )
    description_contains = django_filters.CharFilter(
        field_name='description',
        lookup_expr='icontains',
        help_text=_('Description contains text')
    )

    # User and favorites filters
    user_id = django_filters.NumberFilter(
        field_name='account__user__id',
        help_text=_('Filter by user ID')
    )
    favorites_only = django_filters.BooleanFilter(
        method='filter_favorites_only',
        help_text=_('Show only favorite ads for authenticated user')
    )

    # Photo filter
    with_photos_only = django_filters.BooleanFilter(
        method='filter_with_photos_only',
        help_text=_('Show only ads with photos')
    )

    # My ads filter
    my_ads_only = django_filters.BooleanFilter(
        method='filter_my_ads_only',
        help_text=_('Show only ads created by authenticated user')
    )

    # Invert my ads filter
    invert_my_ads = django_filters.BooleanFilter(
        method='filter_invert_my_ads',
        help_text=_('Invert my ads filter - show all ads except user\'s own')
    )

    # Invert favorites filter
    invert_favorites = django_filters.BooleanFilter(
        method='filter_invert_favorites',
        help_text=_('Invert favorites filter - show all ads except favorites')
    )

    # Invert photos filter
    invert_photos = django_filters.BooleanFilter(
        method='filter_invert_photos',
        help_text=_('Invert photos filter - show only ads without photos')
    )
    
    # Ordering
    ordering = django_filters.OrderingFilter(
        fields=(
            ('created_at', 'created_at'),
            ('updated_at', 'updated_at'),
            ('price', 'price'),
            ('title', 'title'),
            ('year_sort', 'year_sort'),
            ('mileage_sort', 'mileage_sort'),
        ),
        field_labels={
            'created_at': _('Creation date'),
            'updated_at': _('Update date'),
            'price': _('Price'),
            'title': _('Title'),
            'year_sort': _('Year'),
            'mileage_sort': _('Mileage'),
        },
        help_text=_('Ordering field')
    )
    
    class Meta:
        model = CarAd
        fields = {
            'id': ['exact', 'in'],
            'title': ['exact', 'icontains'],
            'description': ['icontains'],
            # 'price': ['exact', 'gte', 'lte', 'range'],  # –£–±–∏—Ä–∞–µ–º, —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞—Å—Ç–æ–º–Ω—ã–µ –º–µ—Ç–æ–¥—ã
            'currency': ['exact'],
            # 'region': —É–±–∏—Ä–∞–µ–º, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ –∫–∞—Å—Ç–æ–º–Ω—ã–π –º–µ—Ç–æ–¥ filter_region
            # 'city': —É–±–∏—Ä–∞–µ–º, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ –∫–∞—Å—Ç–æ–º–Ω—ã–π –º–µ—Ç–æ–¥ filter_city
            'seller_type': ['exact'],
            'exchange_status': ['exact'],
            'status': ['exact'],
            'is_validated': ['exact'],
            'created_at': ['exact', 'gte', 'lte', 'date'],
            'updated_at': ['exact', 'gte', 'lte', 'date'],
            'account__user__id': ['exact'],  # –î–ª—è —Ñ–∏–ª—å—Ç—Ä–∞ user_id
        }
    
    def filter_dynamic_field_gte(self, queryset, name, value):
        """Filter dynamic field with greater than or equal (PostgreSQL JSON)."""
        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –Ω–æ–≤—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
        field_name = name.replace('_from', '').replace('_min', '')
        print(f"üî• [DJANGO-FILTER] filter_dynamic_field_gte called: {name} = {value} -> field: {field_name}")
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º raw SQL –¥–ª—è PostgreSQL JSON –æ–ø–µ—Ä–∞—Ü–∏–π
        return queryset.extra(
            where=["CAST((dynamic_fields->>%s) AS INTEGER) >= %s"],
            params=[field_name, value]
        )

    def filter_dynamic_field_lte(self, queryset, name, value):
        """Filter dynamic field with less than or equal (PostgreSQL JSON)."""
        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –Ω–æ–≤—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
        field_name = name.replace('_to', '').replace('_max', '')
        print(f"üî• [DJANGO-FILTER] filter_dynamic_field_lte called: {name} = {value} -> field: {field_name}")
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º raw SQL –¥–ª—è PostgreSQL JSON –æ–ø–µ—Ä–∞—Ü–∏–π
        return queryset.extra(
            where=["CAST((dynamic_fields->>%s) AS INTEGER) <= %s"],
            params=[field_name, value]
        )

    def filter_dynamic_field_exact(self, queryset, name, value):
        """Filter dynamic field with exact match (PostgreSQL JSON)."""
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º raw SQL –¥–ª—è PostgreSQL JSON –æ–ø–µ—Ä–∞—Ü–∏–π
        return queryset.extra(
            where=["dynamic_fields->>%s = %s"],
            params=[name, value]
        )
    
    def filter_search(self, queryset, name, value):
        """Search in all visible content of the card (case insensitive partial match)."""
        if not value or not value.strip():
            return queryset

        search_term = value.strip()
        print(f"üîç Search filter called with value: '{search_term}'")

        # –ü–æ–∏—Å–∫ –ø–æ –≤—Å–µ–º—É –≤–∏–¥–∏–º–æ–º—É –∫–æ–Ω—Ç–µ–Ω—Ç—É –∫–∞—Ä—Ç–æ—á–∫–∏
        search_query = (
            models.Q(title__icontains=search_term) |           # –ó–∞–≥–æ–ª–æ–≤–æ–∫
            models.Q(description__icontains=search_term) |     # –û–ø–∏—Å–∞–Ω–∏–µ
            models.Q(mark__name__icontains=search_term) |          # –ú–∞—Ä–∫–∞ (Volkswagen)
            models.Q(model__icontains=search_term) |               # –ú–æ–¥–µ–ª—å (Golf)
            models.Q(city__name__icontains=search_term) |          # –ì–æ—Ä–æ–¥ (–î–Ω–µ–ø—Ä) - —á–µ—Ä–µ–∑ ForeignKey
            models.Q(region__name__icontains=search_term) |        # –†–µ–≥–∏–æ–Ω - —á–µ—Ä–µ–∑ ForeignKey
            models.Q(price__icontains=search_term) |               # –¶–µ–Ω–∞ (18000)
            models.Q(dynamic_fields__icontains=search_term)        # JSON –ø–æ–ª—è (–≥–æ–¥, –ø—Ä–æ–±–µ–≥, etc)
        )

        result = queryset.filter(search_query)

        print(f"üîç Search result count: {result.count()}")

        # –î–ª—è –æ—Ç–ª–∞–¥–∫–∏ - –ø–æ–∫–∞–∂–µ–º –ø–µ—Ä–≤—ã–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        if result.exists():
            for ad in result[:3]:
                print(f"üîç Found: '{ad.title}' (mark: {ad.mark.name if ad.mark else 'N/A'})")

        return result

    # –ö—É—Ä—Å—ã –≤–∞–ª—é—Ç –∫ USD (—Å–∫–æ–ª—å–∫–æ USD –∑–∞ 1 –µ–¥–∏–Ω–∏—Ü—É –≤–∞–ª—é—Ç—ã)
    CURRENCY_TO_USD_RATES = {
        'USD': 1.0,        # 1 USD = 1 USD
        'EUR': 1.18,       # 1 EUR = 1.18 USD (–ø—Ä–∏–º–µ—Ä–Ω–æ)
        'UAH': 0.027,      # 1 UAH = 0.027 USD (–ø—Ä–∏–º–µ—Ä–Ω–æ 1 USD = 37 UAH)
    }

    def convert_to_usd(self, amount, currency):
        """
        –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç —Å—É–º–º—É –∏–∑ –ª—é–±–æ–π –≤–∞–ª—é—Ç—ã –≤ USD –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.

        Args:
            amount: —Å—É–º–º–∞ –≤ –∏—Å—Ö–æ–¥–Ω–æ–π –≤–∞–ª—é—Ç–µ
            currency: –∏—Å—Ö–æ–¥–Ω–∞—è –≤–∞–ª—é—Ç–∞ (USD/EUR/UAH)

        Returns:
            float: —Å—É–º–º–∞ –≤ USD
        """
        if not amount or not currency:
            return amount

        currency = currency.upper()
        if currency not in self.CURRENCY_TO_USD_RATES:
            print(f"‚ö†Ô∏è Unknown currency: {currency}, using as USD")
            return float(amount)

        # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ USD
        rate = self.CURRENCY_TO_USD_RATES[currency]
        usd_amount = float(amount) * rate

        print(f"üí± Currency conversion: {amount} {currency} √ó {rate} = {usd_amount} USD")
        return usd_amount

    def filter_price_min(self, queryset, name, value):
        """–§–∏–ª—å—Ç—Ä –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π —Ü–µ–Ω—ã —Å —É—á–µ—Ç–æ–º –≤–∞–ª—é—Ç—ã."""
        print(f"üö®üö®üö® FILTER_PRICE_MIN CALLED! Value: {value}, Type: {type(value)}")

        if not value:
            print("üö® No value provided, returning original queryset")
            return queryset

        try:
            # –ü—Ä–æ—Å—Ç–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –±–µ–∑ —Å–ª–æ–∂–Ω–æ–π –ª–æ–≥–∏–∫–∏
            print(f"üí∞ Filtering by price >= {value}")
            filtered_queryset = queryset.filter(price__gte=value)

            print(f"üí∞ Original count: {queryset.count()}, Filtered count: {filtered_queryset.count()}")

            return filtered_queryset
        except Exception as e:
            print(f"üö® Error in filter_price_min: {e}")
            return queryset

    def filter_price_max(self, queryset, name, value):
        """–§–∏–ª—å—Ç—Ä –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Ü–µ–Ω—ã —Å —É—á–µ—Ç–æ–º –≤–∞–ª—é—Ç—ã."""
        print(f"üö®üö®üö® FILTER_PRICE_MAX CALLED! Value: {value}, Type: {type(value)}")

        if not value:
            print("üö® No value provided, returning original queryset")
            return queryset

        try:
            # –ü—Ä–æ—Å—Ç–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –±–µ–∑ —Å–ª–æ–∂–Ω–æ–π –ª–æ–≥–∏–∫–∏
            print(f"üí∞ Filtering by price <= {value}")
            filtered_queryset = queryset.filter(price__lte=value)

            print(f"üí∞ Original count: {queryset.count()}, Filtered count: {filtered_queryset.count()}")

            return filtered_queryset
        except Exception as e:
            print(f"üö® Error in filter_price_max: {e}")
            return queryset

    def filter_price_currency(self, queryset, name, value):
        """–§–∏–ª—å—Ç—Ä –≤–∞–ª—é—Ç—ã (–Ω–µ —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç queryset, —Ç–æ–ª—å–∫–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ)."""
        # –≠—Ç–æ—Ç —Ñ–∏–ª—å—Ç—Ä –Ω–µ –∏–∑–º–µ–Ω—è–µ—Ç queryset, —Ç–æ–ª—å–∫–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤–∞–ª—é—Ç—É –¥–ª—è –¥—Ä—É–≥–∏—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
        return queryset

    # –ö—É—Ä—Å—ã –≤–∞–ª—é—Ç (–ø—Ä–∏–º–µ—Ä–Ω—ã–µ, –≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ –ª—É—á—à–µ –ø–æ–ª—É—á–∞—Ç—å –∏–∑ API)
    CURRENCY_RATES = {
        'USD': 1.0,      # –ë–∞–∑–æ–≤–∞—è –≤–∞–ª—é—Ç–∞
        'EUR': 0.85,     # 1 USD = 0.85 EUR
        'UAH': 37.0,     # 1 USD = 37 UAH
    }

    def convert_to_usd(self, amount, currency):
        """–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç —Å—É–º–º—É –≤ USD –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö."""
        if not amount or not currency:
            return amount

        currency = currency.upper()
        if currency not in self.CURRENCY_RATES:
            return amount

        # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ USD
        rate = self.CURRENCY_RATES[currency]
        return float(amount) / rate



    def filter_favorites_only(self, queryset, name, value):
        """Filter to show only user's favorite ads (per-user based via FavoriteAd)."""
        if not value:
            return queryset
        try:
            request = self.request
            user = getattr(request, 'user', None)
            if not user or not user.is_authenticated:
                return queryset.none()
            # Use relation from FavoriteAd.related_name='favorited_by'
            return queryset.filter(favorited_by__user=user).distinct()
        except Exception:
            return queryset.none()

    def filter_with_photos_only(self, queryset, name, value):
        """Filter to show only ads with photos."""
        if not value:
            return queryset

        # –§–∏–ª—å—Ç—Ä—É–µ–º –æ–±—ä—è–≤–ª–µ–Ω–∏—è, —É –∫–æ—Ç–æ—Ä—ã—Ö –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∫ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã (image), —Ç–∞–∫ –∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ URL (image_url)
        return queryset.filter(
            models.Q(
                images__isnull=False,
                images__image__isnull=False
            ) |
            models.Q(
                images__isnull=False,
                images__image_url__isnull=False
            )
        ).exclude(
            models.Q(images__image='') & models.Q(images__image_url='')
        ).distinct()

    def filter_my_ads_only(self, queryset, name, value):
        """Filter to show only ads created by authenticated user."""
        if not value:
            return queryset

        # –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ request
        request = self.request
        if not request or not request.user.is_authenticated:
            return queryset.none()  # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π queryset

        # –§–∏–ª—å—Ç—Ä—É–µ–º –æ–±—ä—è–≤–ª–µ–Ω–∏—è –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        return queryset.filter(account__user=request.user)

    def filter_invert_my_ads(self, queryset, name, value):
        """Filter to show all ads except user's own ads."""
        if not value:
            return queryset

        # –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ request
        request = self.request
        if not request or not request.user.is_authenticated:
            return queryset  # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è

        # –ò—Å–∫–ª—é—á–∞–µ–º –æ–±—ä—è–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        return queryset.exclude(account__user=request.user)

    def filter_invert_favorites(self, queryset, name, value):
        """Filter to show all ads except the authenticated user's favorites (per-user)."""
        if not value:
            return queryset
        try:
            request = self.request
            user = getattr(request, 'user', None)
            if not user or not user.is_authenticated:
                return queryset
            return queryset.exclude(favorited_by__user=user).distinct()
        except Exception:
            return queryset

    def filter_invert_photos(self, queryset, name, value):
        """Filter to show only ads without photos."""
        if not value:
            return queryset

        # –§–∏–ª—å—Ç—Ä—É–µ–º –æ–±—ä—è–≤–ª–µ–Ω–∏—è, —É –∫–æ—Ç–æ—Ä—ã—Ö –ù–ï–¢ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∫–∞–∫ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤, —Ç–∞–∫ –∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö URL
        return queryset.filter(
            models.Q(images__isnull=True) |
            models.Q(
                images__image__isnull=True,
                images__image_url__isnull=True
            ) |
            models.Q(
                images__image='',
                images__image_url=''
            )
        ).distinct()

    def filter_year_min(self, queryset, name, value):
        """Filter by minimum year - search in dynamic_fields and title."""
        # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º —Ñ–∏–ª—å—Ç—Ä –ø–æ dynamic_fields
        try:
            dynamic_queryset = queryset.extra(
                where=["CAST((dynamic_fields->>%s) AS INTEGER) >= %s"],
                params=['year', value]
            )
        except:
            dynamic_queryset = queryset.none()

        # –ò—â–µ–º –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ (4-–∑–Ω–∞—á–Ω—ã–µ —á–∏—Å–ª–∞ - –≥–æ–¥—ã)
        try:
            title_queryset = queryset.extra(
                where=["""
                    CAST(
                        SUBSTRING(title FROM '\\d{4}') AS INTEGER
                    ) >= %s
                """],
                params=[value]
            )
        except:
            title_queryset = queryset.none()

        # –û–±—ä–µ–¥–∏–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        return (dynamic_queryset | title_queryset).distinct()

    def filter_year_max(self, queryset, name, value):
        """Filter by maximum year - search in dynamic_fields and title."""
        # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º —Ñ–∏–ª—å—Ç—Ä –ø–æ dynamic_fields
        try:
            dynamic_queryset = queryset.extra(
                where=["CAST((dynamic_fields->>%s) AS INTEGER) <= %s"],
                params=['year', value]
            )
        except:
            dynamic_queryset = queryset.none()

        # –ò—â–µ–º –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ
        try:
            title_queryset = queryset.extra(
                where=["""
                    CAST(
                        SUBSTRING(title FROM '\\d{4}') AS INTEGER
                    ) <= %s
                """],
                params=[value]
            )
        except:
            title_queryset = queryset.none()

        # –û–±—ä–µ–¥–∏–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        return (dynamic_queryset | title_queryset).distinct()

    def filter_mark(self, queryset, name, value):
        """Filter by car mark - search in title and description (case insensitive)."""
        return queryset.filter(
            models.Q(title__icontains=value) |
            models.Q(description__icontains=value)
        )

    def filter_region(self, queryset, name, value):
        """Filter by region - supports both ID and name."""
        print(f"üåç [REGION FILTER] Called with value: '{value}', type: {type(value)}")

        if not value:
            print("üåç [REGION FILTER] Empty value, returning original queryset")
            return queryset

        # –ü—Ä–æ–±—É–µ–º –∫–∞–∫ ID (—á–∏—Å–ª–æ) - —Ñ–∏–ª—å—Ç—Ä—É–µ–º –Ω–∞–ø—Ä—è–º—É—é –ø–æ region_id
        try:
            region_id = int(value)
            print(f"üåç [REGION FILTER] Filtering by region ID: {region_id}")
            result = queryset.filter(region_id=region_id)
            print(f"üåç [REGION FILTER] Found {result.count()} ads by region ID")
            return result
        except (ValueError, TypeError):
            print(f"üåç [REGION FILTER] Not a valid ID, trying by name")
            pass

        # –ü—Ä–æ–±—É–µ–º –∫–∞–∫ –Ω–∞–∑–≤–∞–Ω–∏–µ (—Å—Ç—Ä–æ–∫–∞) - –∏—â–µ–º —Ä–µ–≥–∏–æ–Ω –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏ —Ñ–∏–ª—å—Ç—Ä—É–µ–º –ø–æ ID
        try:
            print(f"üåç [REGION FILTER] Looking for region with name containing: '{value}'")
            region = RegionModel.objects.get(name__icontains=value)
            print(f"üåç [REGION FILTER] Found region: {region.name} (ID: {region.id})")
            result = queryset.filter(region_id=region.id)
            print(f"üåç [REGION FILTER] Found {result.count()} ads for region '{region.name}'")
            return result
        except RegionModel.DoesNotExist:
            print(f"üåç [REGION FILTER] No region found with name containing: '{value}'")
            return queryset.none()

    def filter_city(self, queryset, name, value):
        """Filter by city - supports both ID and name."""
        print(f"üèôÔ∏è [CITY FILTER] Called with value: '{value}', type: {type(value)}")

        if not value:
            print("üèôÔ∏è [CITY FILTER] Empty value, returning original queryset")
            return queryset

        # –ü—Ä–æ–±—É–µ–º –∫–∞–∫ ID (—á–∏—Å–ª–æ) - —Ñ–∏–ª—å—Ç—Ä—É–µ–º –Ω–∞–ø—Ä—è–º—É—é –ø–æ city_id
        try:
            city_id = int(value)
            print(f"üèôÔ∏è [CITY FILTER] Filtering by city ID: {city_id}")
            result = queryset.filter(city_id=city_id)
            print(f"üèôÔ∏è [CITY FILTER] Found {result.count()} ads by city ID")
            return result
        except (ValueError, TypeError):
            print(f"üèôÔ∏è [CITY FILTER] Not a valid ID, trying by name")
            pass

        # –ü—Ä–æ–±—É–µ–º –∫–∞–∫ –Ω–∞–∑–≤–∞–Ω–∏–µ (—Å—Ç—Ä–æ–∫–∞) - –∏—â–µ–º –≥–æ—Ä–æ–¥ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏ —Ñ–∏–ª—å—Ç—Ä—É–µ–º –ø–æ ID
        try:
            print(f"üèôÔ∏è [CITY FILTER] Looking for city with name containing: '{value}'")
            city = CityModel.objects.get(name__icontains=value)
            print(f"üèôÔ∏è [CITY FILTER] Found city: {city.name} (ID: {city.id})")
            result = queryset.filter(city_id=city.id)
            print(f"üèôÔ∏è [CITY FILTER] Found {result.count()} ads for city '{city.name}'")
            return result
        except CityModel.DoesNotExist:
            print(f"üèôÔ∏è [CITY FILTER] No city found with name containing: '{value}'")
            return queryset.none()


class CarMarkFilter(django_filters.FilterSet):
    """Filter for car marks/brands."""
    
    name = django_filters.CharFilter(
        lookup_expr='icontains',
        help_text=_('Mark name (partial match)')
    )
    

    
    ordering = django_filters.OrderingFilter(
        fields=(
            ('name', 'name'),
            ('created_at', 'created_at'),
        ),
        help_text=_('Ordering field')
    )
    
    class Meta:
        model = CarMarkModel
        fields = {
            'id': ['exact', 'in'],
            'name': ['exact', 'icontains'],
        }


class CarModelFilter(django_filters.FilterSet):
    """Filter for car models."""
    
    name = django_filters.CharFilter(
        lookup_expr='icontains',
        help_text=_('Model name (partial match)')
    )
    
    mark = django_filters.ModelChoiceFilter(
        queryset=CarMarkModel.objects.all(),
        help_text=_('Car mark')
    )
    
    ordering = django_filters.OrderingFilter(
        fields=(
            ('name', 'name'),
            ('mark__name', 'mark_name'),
        ),
        help_text=_('Ordering field')
    )
    
    class Meta:
        model = CarModel
        fields = {
            'id': ['exact', 'in'],
            'name': ['exact', 'icontains'],
            'mark': ['exact'],
        }


class RegionFilter(django_filters.FilterSet):
    """Filter for regions."""
    
    name = django_filters.CharFilter(
        lookup_expr='icontains',
        help_text=_('Region name (partial match)')
    )
    
    ordering = django_filters.OrderingFilter(
        fields=(
            ('name', 'name'),
            ('code', 'code'),
        ),
        help_text=_('Ordering field')
    )
    
    class Meta:
        model = RegionModel
        fields = {
            'id': ['exact', 'in'],
            'name': ['exact', 'icontains'],
            'code': ['exact', 'icontains'],
        }


class CityFilter(django_filters.FilterSet):
    """Filter for cities."""
    
    name = django_filters.CharFilter(
        lookup_expr='icontains',
        help_text=_('City name (partial match)')
    )
    
    region = django_filters.ModelChoiceFilter(
        queryset=RegionModel.objects.all(),
        help_text=_('Region')
    )
    
    is_regional_center = django_filters.BooleanFilter(
        help_text=_('Is regional center')
    )
    
    ordering = django_filters.OrderingFilter(
        fields=(
            ('name', 'name'),
            ('region__name', 'region_name'),
        ),
        help_text=_('Ordering field')
    )
    
    class Meta:
        model = CityModel
        fields = {
            'id': ['exact', 'in'],
            'name': ['exact', 'icontains'],
            'region': ['exact'],
            'is_regional_center': ['exact'],
        }
