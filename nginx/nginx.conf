events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    sendfile on;
    keepalive_timeout 65;
    server_tokens off;

    # Proper WebSocket upgrade handling
    map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
    }

    upstream backend {
        server app:8000;  # Django + Channels (daphne)
    }

    # Frontend upstream (local dev outside docker)
    upstream frontend_localhost {
        server host.docker.internal:3000;
    }

    server {
        listen 80;
        server_name localhost;

        # Health for compose healthcheck
        location = /nginx-health { return 200 'ok'; add_header Content-Type text/plain; }

        # Keep NextAuth routes on the Next.js side (frontend handles OAuth callbacks)
        location ^~ /api/auth/ {
            proxy_pass http://frontend_localhost/api/auth/;
            proxy_set_header Host $host;
        }

        # Frontend-internal API routes (Next.js API routes) that must NOT hit Django
        location ^~ /api/redis {
            proxy_pass http://frontend_localhost/api/redis;
            proxy_set_header Host $host;
        }
        location ^~ /api/health {
            proxy_pass http://frontend_localhost/api/health;
            proxy_set_header Host $host;
        }
        location ^~ /api/backend-health {
            proxy_pass http://frontend_localhost/api/backend-health;
            proxy_set_header Host $host;
        }
        location ^~ /api/openapi {
            proxy_pass http://frontend_localhost/api/openapi;
            proxy_set_header Host $host;
        }

        # WebSocket proxy to Django Channels (chat etc.)
        location ^~ /api/chat/ {
            proxy_pass http://backend/api/chat/;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_set_header Host $host;
            proxy_read_timeout 300s;
        }

        # API default → Next.js (SSR/API routes perform auth, proxy, caching)
        location ^~ /api/ {
            proxy_pass http://frontend_localhost/api/;
            proxy_set_header Host $host;
        }

        # Admin and docs
        location ^~ /admin/ { proxy_pass http://backend/admin/; proxy_set_header Host $host; }
        location ^~ /api/doc/ { proxy_pass http://backend/api/doc/; proxy_set_header Host $host; }
        location ^~ /api/redoc/ { proxy_pass http://backend/api/redoc/; proxy_set_header Host $host; }
        location ^~ /health { proxy_pass http://backend/health/; }

        # Static and media from backend container
        location ^~ /static/ { proxy_pass http://backend/static/; }
        location ^~ /media/ { proxy_pass http://backend/media/; }

        # Next.js assets and everything else → frontend
        location ^~ /_next/ {
            proxy_pass http://frontend_localhost;
            proxy_set_header Host $host;
        }
        location / {
            proxy_pass http://frontend_localhost;
            proxy_set_header Host $host;
        }
    }
}
