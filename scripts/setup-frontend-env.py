#!/usr/bin/env python3
"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è frontend/.env.local –ø–µ—Ä–µ–¥ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ–º
–ß–∏—Ç–∞–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ env-config/ –∏ —Å–æ–∑–¥–∞–µ—Ç .env.local –¥–ª—è Next.js
"""

import os
from pathlib import Path

def create_frontend_env():
    """–°–æ–∑–¥–∞–µ—Ç frontend/.env.local —Å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–º–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏"""
    
    # –ü—É—Ç–∏
    root_dir = Path(__file__).parent.parent
    frontend_dir = root_dir / "frontend"
    env_config_dir = root_dir / "env-config"
    env_local_path = frontend_dir / ".env.local"
    
    print("üìù –°–æ–∑–¥–∞–Ω–∏–µ frontend/.env.local...")
    
    # –ß–∏—Ç–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ env-config —Ñ–∞–π–ª–æ–≤
    env_vars = {}
    env_files = [
        env_config_dir / ".env.base",
        env_config_dir / ".env.secrets",
        env_config_dir / ".env.local",
    ]
    
    for env_file in env_files:
        if env_file.exists():
            print(f"   –ß—Ç–µ–Ω–∏–µ {env_file.name}...")
            with open(env_file, 'r', encoding='utf-8') as f:
                for line in f:
                    line = line.strip()
                    if line and not line.startswith('#') and '=' in line:
                        key, value = line.split('=', 1)
                        # –í–∏–¥–∞–ª—è—î–º–æ –≤—Å—ñ –ø–µ—Ä–µ–Ω–æ—Å–∏ —Ä—è–¥–∫—ñ–≤ —Ç–∞ –∑–∞–π–≤—ñ –ø—Ä–æ–±—ñ–ª–∏
                        env_vars[key.strip()] = value.strip().replace('\n', '').replace('\r', '')
    
    # –ö—Ä–∏—Ç–∏—á–Ω—ñ –∑–º—ñ–Ω–Ω—ñ –¥–ª—è Next.js
    critical_vars = [
        'NEXTAUTH_SECRET',
        'NEXTAUTH_URL',
        'NEXT_PUBLIC_BACKEND_URL',
        'BACKEND_URL',
        'NODE_ENV',
        'NEXT_PUBLIC_IS_DOCKER',
        'IS_DOCKER',
        'REDIS_HOST',
        'REDIS_URL',
        'GOOGLE_CLIENT_ID',
        'GOOGLE_CLIENT_SECRET',
        'NEXT_PUBLIC_GOOGLE_CLIENT_ID'
    ]
    
    # –ó–∞–ø–∏—Å—É—î–º–æ –≤ .env.local
    with open(env_local_path, 'w', encoding='utf-8') as f:
        f.write("# Auto-generated by setup-frontend-env.py\n")
        f.write("# DO NOT COMMIT THIS FILE\n")
        f.write("# Run 'python scripts/setup-frontend-env.py' to regenerate\n\n")
        
        for var in critical_vars:
            if var in env_vars:
                f.write(f"{var}={env_vars[var]}\n")
            elif var == 'NODE_ENV':
                f.write(f"{var}=production\n")
            elif var == 'NEXTAUTH_URL':
                f.write(f"{var}=http://localhost:3000\n")
            elif var == 'NEXT_PUBLIC_BACKEND_URL':
                f.write(f"{var}=http://localhost:8000\n")
            elif var == 'BACKEND_URL':
                f.write(f"{var}=http://localhost:8000\n")
            elif var == 'NEXT_PUBLIC_IS_DOCKER':
                f.write(f"{var}=false\n")
            elif var == 'IS_DOCKER':
                f.write(f"{var}=false\n")
    
    print(f"‚úÖ –°—Ç–≤–æ—Ä–µ–Ω–æ {env_local_path}")
    print(f"   –ó–∞–ø–∏—Å–∞–Ω–æ {len(critical_vars)} –∑–º—ñ–Ω–Ω–∏—Ö")
    
    # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å NEXTAUTH_SECRET
    if 'NEXTAUTH_SECRET' not in env_vars:
        print("\n‚ö†Ô∏è  –£–í–ê–ì–ê: NEXTAUTH_SECRET –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ!")
        print("   –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è —â–æ env-config/.env.secrets –º—ñ—Å—Ç–∏—Ç—å NEXTAUTH_SECRET")
        return False
    
    return True

if __name__ == "__main__":
    try:
        success = create_frontend_env()
        exit(0 if success else 1)
    except Exception as e:
        print(f"‚ùå –ü–æ–º–∏–ª–∫–∞: {e}")
        exit(1)
