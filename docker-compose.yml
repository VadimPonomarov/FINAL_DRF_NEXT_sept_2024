services:

  app:
    build:
      context: ./backend
    volumes:
      - ./backend:/app
      - backend-static:/app/static
      - backend-temp:/app/temp
      - backend-staticfiles:/app/staticfiles
      - ./media:/app/media  # Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¼ĞµĞ´Ğ¸Ğ° Ñ„Ğ°Ğ¹Ğ»Ñ‹
    environment:
      IS_DOCKER: true
      DISABLE_RATELIMIT: true
      DEBUG: true
    env_file:
      - ./env-config/.env.base       # Base configuration
      - ./env-config/.env.secrets    # Secrets
      - ./env-config/.env.docker     # Docker overrides
    ports:
      - "8000:8000"
    restart: unless-stopped
    depends_on:
      pg:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 600s
    command: >
      sh -c "
        echo 'ğŸ“Š Waiting for PostgreSQL database...' &&
        python manage.py wait_db --timeout=60 &&
        echo 'ğŸ”„ Running database migrations...' &&
        python manage.py migrate --noinput &&
        echo 'ğŸŒ± Seeding database (forced)...' &&
        python manage.py init_project_data --force &&
        echo 'ğŸ“ Collecting static files...' &&
        python manage.py collectstatic --noinput --clear &&
        echo 'ğŸ“¦ Checking test ads...' &&
        python -c '
          from apps.ads.models import CarAd;
          count = CarAd.objects.filter(status="active").count();
          import sys;
          sys.exit(0 if count >= 10 else 1);
        ' && echo 'âœ… Test ads already exist (count >= 10)' ||
        (echo 'ğŸš€ Generating test ads (count < 10)...' &&
         python manage.py generate_test_ads_with_images --count=10 --with-images --image-types=front,side,rear &&
         echo 'âœ… Test ads generated') &&
        echo 'ğŸ‰ Application setup complete!' &&
        daphne -b 0.0.0.0 -p 8000 config.asgi:application
      "

  pg:
    image: postgres:17-alpine
    container_name: pg
    env_file:
      - ./env-config/.env.base       # Base configuration
      - ./env-config/.env.secrets    # Secrets
      - ./env-config/.env.docker     # Docker overrides
    ports:
      - "5432:5432"
    volumes:
      # IMPORTANT: Use named volume instead of local directory
      # This ensures data persistence even if ./pg/data is deleted
      - postgres-data:/var/lib/postgresql/data
      # Alternative: uncomment below to use local directory
      # - ./pg/data:/var/lib/postgresql/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-autoria_db} || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s  # Ğ”Ğ°Ñ”Ğ¼Ğ¾ PostgreSQL 60 ÑĞµĞºÑƒĞ½Ğ´ Ğ½Ğ° Ñ–Ğ½Ñ–Ñ†Ñ–Ğ°Ğ»Ñ–Ğ·Ğ°Ñ†Ñ–Ñ


  # =============================================================================
  # FRONTEND SERVICE (Next.js)
  # =============================================================================
  # 
  # âš ï¸  Ğ’ĞĞ–ĞĞ: Frontend Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ·Ğ°ĞºĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½
  # 
  # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ:
  # 1. Ğ”Ğ»Ñ Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ğ³Ğ¾ Docker Ñ€Ğ°Ğ·Ğ²ĞµÑ€Ñ‚Ñ‹Ğ²Ğ°Ğ½Ğ¸Ñ: Ñ€Ğ°ÑĞºĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ ÑĞµĞºÑ†Ğ¸Ñ Ğ½Ğ¸Ğ¶Ğµ
  # 2. Ğ”Ğ»Ñ deploy.py: Ğ±ÑƒĞ´ĞµÑ‚ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ÑÑ‚ÑŒÑÑ ÑĞºÑ€Ğ¸Ğ¿Ñ‚Ğ¾Ğ¼
  #
  #   frontend:
  #     build:
  #       context: ./frontend
  #       dockerfile: Dockerfile
  #     env_file:
  #       - ./env-config/.env.base
  #       - ./env-config/.env.secrets
  #       - ./env-config/.env.docker
  #     environment:
  #       IS_DOCKER: "true"
  #       NEXT_PUBLIC_IS_DOCKER: "true"
  #       REDIS_HOST: redis
  #       REDIS_URL: redis://redis:6379/0
  #       # BACKEND_URL Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ Ğ´Ğ»Ñ SSR Ğ¸ API routes Ğ² Next.js
  #       # Ğ”Ğ»Ñ Docker Ñ€ĞµĞ¶Ğ¸Ğ¼Ğ° backend Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½ Ğ¿Ğ¾ Ğ²Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½ĞµĞ¼Ñƒ DNS Ğ¸Ğ¼ĞµĞ½Ğ¸
  #       BACKEND_URL: http://app:8000
  #       # NEXT_PUBLIC_BACKEND_URL - Ğ´Ğ»Ñ ĞºĞ»Ğ¸ĞµĞ½Ñ‚ÑĞºĞ¾Ğ¹ Ñ‡Ğ°ÑÑ‚Ğ¸ (Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€)
  #       # Ğ‘Ñ€Ğ°ÑƒĞ·ĞµÑ€ Ğ´ĞµĞ»Ğ°ĞµÑ‚ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹ Ñ‡ĞµÑ€ĞµĞ· nginx, Ğ¿Ğ¾ÑÑ‚Ğ¾Ğ¼Ñƒ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ¾Ñ‚Ğ½Ğ¾ÑĞ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğ¹ Ğ¿ÑƒÑ‚ÑŒ Ğ¸Ğ»Ğ¸ nginx URL
  #       NEXT_PUBLIC_BACKEND_URL: /api
  #       NEXTAUTH_URL_INTERNAL: http://frontend:3000
  #     ports:
  #       - "3000:3000"
  #     depends_on:
  #       - redis
  #       - app
  #     restart: unless-stopped
  #     healthcheck:
  #       test: [ "CMD", "curl", "-f", "http://localhost:3000/api/health" ]
  #       interval: 30s
  #       timeout: 10s
  #       retries: 3
  #       start_period: 60s


  # =============================================================================
  # CELERY MICROSERVICE - Autonomous Queue Management
  # =============================================================================

  celery-worker:
    build:
      context: ./celery-service
      dockerfile: Dockerfile
    container_name: celery-worker
    restart: unless-stopped
    environment:
      # Broker and Backend
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: 5672
      RABBITMQ_USER: guest
      RABBITMQ_PASSWORD: guest
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_DB: 0
      # Backend API integration
      BACKEND_API_URL: http://app:8000
      BACKEND_API_KEY: ${BACKEND_API_KEY:-celery-microservice-key}
      # Email configuration
      SMTP_HOST: ${SMTP_HOST:-localhost}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USER: ${SMTP_USER:-}
      SMTP_PASSWORD: ${SMTP_PASSWORD:-}
      FROM_EMAIL: ${FROM_EMAIL:-noreply@example.com}
      # Push notifications
      FCM_SERVER_KEY: ${FCM_SERVER_KEY:-}
      # SMS configuration
      TWILIO_ACCOUNT_SID: ${TWILIO_ACCOUNT_SID:-}
      TWILIO_AUTH_TOKEN: ${TWILIO_AUTH_TOKEN:-}
      TWILIO_FROM_NUMBER: ${TWILIO_FROM_NUMBER:-}
    env_file:
      - ./env-config/.env.base       # Base configuration
      - ./env-config/.env.secrets    # Secrets
      - ./env-config/.env.docker     # Docker overrides
    volumes:
      - celery-logs:/app/logs
      - celery-temp:/app/temp
    depends_on:
      rabbitmq:
        condition: service_started
      redis:
        condition: service_healthy
    command:
      - python
      - -m
      - celery
      - -A
      - config.celery_app
      - worker
      - --loglevel=info
      - --pool=solo
      - --concurrency=2
      - --queues=email,notifications,data_processing,cleanup
    healthcheck:
      test: ["CMD", "python", "-m", "celery", "-A", "config.celery_app", "inspect", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - default

  celery-beat:
    build:
      context: ./celery-service
      dockerfile: Dockerfile
    container_name: celery-beat
    restart: unless-stopped
    environment:
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: 5672
      RABBITMQ_USER: guest
      RABBITMQ_PASSWORD: guest
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_DB: 0
    env_file:
      - ./env-config/.env.base       # Base configuration
      - ./env-config/.env.secrets    # Secrets
      - ./env-config/.env.docker     # Docker overrides
    volumes:
      - celery-logs:/app/logs
      - celery-beat-schedule:/app/celerybeat-schedule
    depends_on:
      - rabbitmq
      - redis
    command:
      - python
      - -m
      - celery
      - -A
      - config.celery_app
      - beat
      - --loglevel=info
      - --schedule=/app/celerybeat-schedule/celerybeat-schedule
    networks:
      - default

  flower:
    build:
      context: ./celery-service
      dockerfile: Dockerfile
    container_name: celery-flower
    restart: unless-stopped
    environment:
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: 5672
      RABBITMQ_USER: guest
      RABBITMQ_PASSWORD: guest
      REDIS_HOST: redis
      REDIS_PORT: 6379
    env_file:
      - ./env-config/.env.base       # Base configuration
      - ./env-config/.env.secrets    # Secrets
      - ./env-config/.env.docker     # Docker overrides
    ports:
      - "5555:5555"
    volumes:
      - celery-logs:/app/logs
    depends_on:
      - rabbitmq
      - redis
    command:
      - python
      - -m
      - celery
      - -A
      - config.celery_app
      - flower
      - --port=5555
      - --broker_api=http://guest:guest@rabbitmq:15672/api/
    networks:
      - default



  redis:
    image: redis:7-alpine
    container_name: redis
    env_file:
      - ./env-config/.env.base       # Base configuration
      - ./env-config/.env.secrets    # Secrets
      - ./env-config/.env.docker     # Docker overrides
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - ./redis/redis.conf:/usr/local/etc/redis/redis.conf:ro
      - redis-data:/data
    command: redis-server /usr/local/etc/redis/redis.conf
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  redis-insight:
    image: redislabs/redisinsight:latest
    container_name: redis-insight
    ports:
      - "5540:5540"
    env_file:
      - ./env-config/.env.base       # Base configuration
      - ./env-config/.env.secrets    # Secrets
      - ./env-config/.env.docker     # Docker overrides
    volumes:
      - redis-insight:/data

  rabbitmq:
    image: rabbitmq:3.13-management  # ĞĞ±Ñ€Ğ°Ğ· Ñ Ğ¿Ñ€ĞµĞ´ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ‹Ğ¼ Management UI
    container_name: rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      - RABBITMQ_DEFAULT_USER=guest
      - RABBITMQ_DEFAULT_PASS=guest
      - RABBITMQ_LOG=none
      - RABBITMQ_LOG_LEVELS=error
      - RABBITMQ_SASL_LOG_LEVEL=error
      - RABBITMQ_HEARTBEAT=30
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # =============================================================================
  # MAILING SERVICE (FastAPI + RabbitMQ Consumer)
  # =============================================================================
  # NOTE: This service runs BOTH:
  # 1. FastAPI server on port 8001 (for health checks and API)
  # 2. RabbitMQ consumer (for processing email queue)
  # Both are started by src/app.py using asyncio lifespan events
  #
  mailing:
    build:
      context: ./mailing
    container_name: mailing
    ports:
      - "8001:8001"
    env_file:
      - ./env-config/.env.base       # Base configuration
      - ./env-config/.env.secrets    # Secrets
      - ./env-config/.env.docker     # Docker overrides
    environment:
      IS_DOCKER: true
      RABBITMQ_HOST: rabbitmq
    volumes:
      - ./mailing:/app
    depends_on:
      - rabbitmq
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8001/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s





  nginx:
    build:
      context: ./nginx
    container_name: nginx
    ports:
      - "80:80"
    env_file:
      - ./env-config/.env.base       # Base configuration
      - ./env-config/.env.secrets    # Secrets
      - ./env-config/.env.docker     # Docker overrides
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - backend-static:/var/www/static:ro
    depends_on:
      app:
        condition: service_healthy
      rabbitmq:
        condition: service_started
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/nginx-health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s



volumes:
  # PostgreSQL data - named volume for persistence
  postgres-data:
  redis-data:
  rabbitmq-data:
  redis-insight:
  backend-static:
  backend-temp:
  backend-staticfiles:
  backend-media:
  # Celery microservice volumes
  celery-logs:
  celery-temp:
  celery-beat-schedule:
